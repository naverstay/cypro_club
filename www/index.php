<!DOCTYPE html><html lang="ru"><head><title>Отдых на Кипре</title> 
<!-- saved from url=(0014)about:internet --><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="SKYPE_TOOLBAR" content="SKYPE_TOOLBAR_PARSER_COMPATIBLE"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="format-detection" content="telephone=no"/><style>.btn_v1.callback_btn,.formError,button,input[type=submit]{cursor:pointer}.dialog_butt_v1 .dialog_butt_wrap{display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;-webkit-flex-flow:row nowrap;flex-flow:row nowrap;-webkit-justify-content:center;justify-content:center;-webkit-align-items:flex-start;align-items:flex-start;-webkit-box-pack:center;-webkit-box-align:start}.formError,article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}.contact_block:after,.contact_block_questions:after,.contact_phones:after,.contacts_section:after,.factoid_slider_holder:after,.hero_controls:after,.how_it_works_steps:after,.object_gallery:after,.object_list:after,.partners_list:after,.phones_block:after,.review_unit:after,.section_caption:after,.share_block:after,.slick-track:after,.slide_info:after,.slide_info_holder:after,.wrapper:after{position:static;display:block;height:0;clear:both;content:"";visibility:hidden}#video{top:50%;left:50%;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}a,abbr,address,article,aside,audio,b,blockquote,body,canvas,cite,code,dd,del,details,dfn,div,dl,dt,em,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,input,ins,kbd,label,legend,li,mark,menu,nav,object,ol,p,pre,q,samp,section,small,span,strong,sub,summary,sup,textarea,time,ul,var,video{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:0 0;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;-webkit-tap-highlight-color:transparent}a:after,a:before,abbr:after,abbr:before,address:after,address:before,article:after,article:before,aside:after,aside:before,audio:after,audio:before,b:after,b:before,blockquote:after,blockquote:before,body:after,body:before,canvas:after,canvas:before,cite:after,cite:before,code:after,code:before,dd:after,dd:before,del:after,del:before,details:after,details:before,dfn:after,dfn:before,div:after,div:before,dl:after,dl:before,dt:after,dt:before,em:after,em:before,fieldset:after,fieldset:before,figcaption:after,figcaption:before,figure:after,figure:before,footer:after,footer:before,form:after,form:before,h1:after,h1:before,h2:after,h2:before,h3:after,h3:before,h4:after,h4:before,h5:after,h5:before,h6:after,h6:before,header:after,header:before,hgroup:after,hgroup:before,html:after,html:before,i:after,i:before,iframe:after,iframe:before,img:after,img:before,input:after,input:before,ins:after,ins:before,kbd:after,kbd:before,label:after,label:before,legend:after,legend:before,li:after,li:before,mark:after,mark:before,menu:after,menu:before,nav:after,nav:before,object:after,object:before,ol:after,ol:before,p:after,p:before,pre:after,pre:before,q:after,q:before,samp:after,samp:before,section:after,section:before,small:after,small:before,span:after,span:before,strong:after,strong:before,sub:after,sub:before,summary:after,summary:before,sup:after,sup:before,textarea:after,textarea:before,time:after,time:before,ul:after,ul:before,var:after,var:before,video:after,video:before{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}caption,table,tbody,td,tfoot,th,thead,tr{margin:0;padding:0;border:0;outline:0;font-size:100%;background:0 0}body{line-height:1.2}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:'';content:none}:focus,button:active,button:focus,input:active,input:focus,input:hover,textarea:active,textarea:focus,textarea:hover{outline:0}textarea{resize:none;overflow-y:auto}a,ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}input,select{vertical-align:middle}input[type=radio]{vertical-align:text-bottom}input[type=checkbox]{vertical-align:bottom}input,textarea{margin:0;padding:0;border:0;background:0 0;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}button{border:none;padding:0;margin:0}input::-webkit-input-placeholder,textarea::-webkit-input-placeholder{color:#ccc}input::-moz-placeholder,textarea::-moz-placeholder{color:#ccc}input:focus::-webkit-input-placeholder,textarea:focus::-webkit-input-placeholder{color:transparent!important}input:focus::-moz-placeholder,textarea:focus::-moz-placeholder{color:transparent!important}@font-face{font-family:MyriadProRegular;src:url(fonts/MyriadPro-Regular.eot);src:url(fonts/MyriadPro-Regular.eot?#iefix) format("embedded-opentype"),url(fonts/MyriadPro-Regular.woff) format("woff"),url(fonts/MyriadPro-Regular.ttf) format("truetype"),url(fonts/MyriadPro-Regular.svg) format("svg");font-weight:400;font-style:normal}@font-face{font-family:MyriadProBold;src:url(fonts/MyriadPro-Bold.eot);src:url(fonts/MyriadPro-Bold.eot?#iefix) format("embedded-opentype"),url(fonts/MyriadPro-Bold.woff) format("woff"),url(fonts/MyriadPro-Bold.ttf) format("truetype"),url(fonts/MyriadPro-Bold.svg) format("svg");font-weight:400;font-style:normal}.contact_phones dt:after,.contact_phones dt:before,.dialog_close_butt_mod_1 .ui-dialog-titlebar-close:after,.dialog_close_butt_mod_1 .ui-dialog-titlebar-close:before,.object_list .slick-next:after,.object_list .slick-next:before,.object_list .slick-prev:after,.object_list .slick-prev:before,.phones_block:after,.phones_block:before,.phones_callback_btn:after,.phones_callback_btn:before,.slide_features ul li:after,.slide_features ul li:before{font-family:cypro_icons!important;speak:none;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}@font-face{font-family:cypro_icons;src:url(fonts/cypro_icons.eot?yvi0qy);src:url(fonts/cypro_icons.eot?yvi0qy#iefix) format("embedded-opentype"),url(fonts/cypro_icons.ttf?yvi0qy) format("truetype"),url(fonts/cypro_icons.woff?yvi0qy) format("woff"),url(fonts/cypro_icons.svg?yvi0qy#cypro_icons) format("svg");font-weight:400;font-style:normal}[class*=" i-"],[class^=i-]{font-family:cypro_icons!important;speak:none;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.i-cross:before{content:""}.i-phone:before{content:""}.i-envelope:before{content:""}.i-facebook:before{content:""}.i-instagram:before{content:""}.i-arrow_right:before{content:""}.i-arrow_left:before{content:""}.i-info:before{content:""}.i-menu:before{content:""}.i-help:before{content:""}.i-check:before{content:""}.i-mobile:before{content:""}.formError{z-index:1}.formError .formErrorContent{z-index:2}.formError .formErrorArrow{z-index:3}.ui-dialog .formError{z-index:5000}.ui-dialog .formError .formErrorContent{z-index:5001}.ui-dialog .formError .formErrorArrow{z-index:5006}.inputContainer{position:relative;float:left}.formError{position:absolute;top:300px;left:100%!important;text-align:left;line-height:normal}.formError.hidden_mode,.formError.relative_mode .formErrorContent p~p{display:none}.formError.relative_mode{left:0!important;top:100%!important;right:0!important;text-align:center}.error_top .formError.relative_mode{bottom:100%!important;top:auto!important}.formError.relative_mode .formErrorContent p{margin:0 auto;color:#ed145b;overflow:visible}.formError_left_mod .formError,.form_el_left .formError{left:auto!important;right:100%!important}.formError_left_mod .formError .left_center_arrow .formErrorContent:before,.form_el_left .formError .left_center_arrow .formErrorContent:before{right:-7px;left:auto;border-right:none;border-left:8px solid #e82022}.error_holder_v1 .formError{left:-100px!important;top:100%!important;margin-top:0!important;padding-left:25px}.error_holder_v1 .formError:before{content:'';position:absolute;width:17px;height:17px;top:0;left:0;background:url(../i/sprite.png) -70px -27px no-repeat}.formError.inline{position:relative;top:0;left:0;display:inline-block}.ajaxSubmit,.formError .formErrorArrow{display:none}.ajaxSubmit{padding:20px;background:#55ea55;border:1px solid #999}.formError .formErrorContent{position:relative;font-size:13px;-moz-box-shadow:0 0 6px #000;-webkit-box-shadow:0 0 6px #000;-o-box-shadow:0 0 6px #000;border-radius:6px;-moz-border-radius:6px;-webkit-border-radius:6px;-o-border-radius:6px}.formError.inline .formErrorContent{box-shadow:none;-moz-box-shadow:none;-webkit-box-shadow:none;-o-box-shadow:none;border:none;border-radius:0;-moz-border-radius:0;-webkit-border-radius:0;-o-border-radius:0}.greenPopup .formErrorContent{background:#33be40}.blackPopup .formErrorContent{background:#393939;color:#fff}.formError .formErrorArrow{width:15px;margin:-2px 0 0 13px;position:relative}body.rtl .formError .formErrorArrow,body[dir=rtl] .formError .formErrorArrow{margin:-2px 13px 0 0}.formError .formErrorArrowBottom{box-shadow:none;-moz-box-shadow:none;-webkit-box-shadow:none;-o-box-shadow:none;margin:0 0 0 12px;top:2px}.formError .formErrorArrow div{border-left:2px solid #ddd;border-right:2px solid #ddd;box-shadow:0 2px 3px #444;-moz-box-shadow:0 2px 3px #444;-webkit-box-shadow:0 2px 3px #444;-o-box-shadow:0 2px 3px #444;height:1px;background:rgba(216,107,34,.83);margin:0 auto;line-height:0;font-size:0;display:block}.formError .formErrorArrowBottom div{box-shadow:none;-moz-box-shadow:none;-webkit-box-shadow:none;-o-box-shadow:none}.greenPopup .formErrorArrow div{background:#33be40}.blackPopup .formErrorArrow div{background:#393939;color:#fff}.formError .formErrorArrow .line10{width:13px;border:none}.formError .formErrorArrow .line9{width:11px;border:none}.formError .formErrorArrow .line8{width:11px}.formError .formErrorArrow .line7{width:9px}.formError .formErrorArrow .line6{width:7px}.formError .formErrorArrow .line5{width:5px}.formError .formErrorArrow .line4{width:3px}.formError .formErrorArrow .line3{width:1px;border-left:2px solid #ddd;border-right:2px solid #ddd;border-bottom:0 solid #ddd}.formError .formErrorArrow .line2{width:3px;border:none;background:#ddd}.formError .formErrorArrow .line1{width:1px;border:none;background:#ddd}.formError.relative_mode .formErrorContent{background:0 0;color:#c30000;padding:0;font-size:11px;text-align:left}.formError .formErrorContent{background:#e82022;border:none;color:#fff;padding:10px 14px;box-shadow:none}.formError .formErrorContent p{max-width:300px;overflow:hidden;white-space:nowrap}.formError.left_bottom_arrow .formErrorContent{margin-left:15px}.formError.left_center_arrow .formErrorContent,.formError.right_center_arrow .formErrorContent{margin-left:10px}.formError.left_bottom_arrow .formErrorContent:before{z-index:2;content:'';position:absolute;top:100%;left:11px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #e82022}.formError.left_center_arrow .formErrorContent:before,.formError.right_center_arrow .formErrorContent:before{z-index:2;content:'';top:50%;margin-top:-8px;width:0;height:0;border-bottom:8px solid transparent;border-top:8px solid transparent;position:absolute}.formError.left_center_arrow .formErrorContent:before{left:-7px;border-right:8px solid #e82022}.formError.right_center_arrow .formErrorContent:before{right:-7px;border-left:8px solid #e82022}.formError .required{color:#c42121}.formError_left_mod .formError.left_center_arrow .formErrorContent,.form_el_left .formError.left_center_arrow .formErrorContent{margin-left:0;margin-right:19px}.formError_left_mod .formError.left_center_arrow .formErrorContent:before,.form_el_left .formError.left_center_arrow .formErrorContent:before{right:-7px;left:auto;border-left:8px solid #e82022;border-right:none}.validation_msg{display:none;position:absolute;bottom:100%;left:0;right:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.input_error+.validation_msg{display:block;color:#ffb2b2}@media only screen and (max-width:720px){.formError{top:auto!important;left:30px!important;bottom:100%;margin-bottom:15px}.formError.left_center_arrow .formErrorContent{margin-left:15px}.formError.left_center_arrow .formErrorContent:before{top:100%;left:11px;margin-top:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #e82022}.quart_mod>div{width:50%!important}}@media only screen and (max-width:479px){.mob_center{text-align:center}.quart_mod>div{width:100%!important}}@media only screen and (min-width:719px){.error_right_center_arrow .formError{left:auto!important;right:100%!important;margin-left:0!important;margin-right:10px!important}.error_right_center_arrow .formError.left_center_arrow .formErrorContent{margin-left:15px}.error_right_center_arrow .formError.left_center_arrow .formErrorContent:before{margin-top:-8px;right:-7px;left:auto;border-right:none;border-left:8px solid #e82022}.quart_mod>div{width:25%!important}.quart_mod>div input{font-size:18px}}.btn_v1.callback_btn,.btn_v2.subscribe_btn{border-radius:4px;display:block;font-size:14px;text-align:center}.btn_v1{height:30px}.btn_v1.callback_btn{padding:5px 22px;line-height:16px}.btn_v2.subscribe_btn{width:100%;height:44px;margin-top:20px}.btn_v3.caption_btn,.btn_v4.hero_btn{text-decoration:none;text-transform:uppercase;font-size:18px;display:block}.club .btn_v2.subscribe_btn{border-radius:0}.btn_v3{height:45px}.btn_v3.caption_btn{padding:10px 20px;line-height:25px;font-weight:400;min-width:200px}.btn_v4{height:60px}.btn_v4.hero_btn{padding:18px 47px;line-height:24px;float:left}.btn_v5.contact_btn,.btn_v5.factoid_btn{padding:10px 55px;line-height:20px;text-decoration:none;text-transform:uppercase}.btn_v5{height:40px}.btn_v5.contact_btn{display:block;text-align:center;font-size:16px}.btn_v5.factoid_btn{display:inline-block;vertical-align:top;font-size:15px}.ui-dialog,.ui-helper-hidden{display:none}.btn_blue_transp{border:1px solid #29abe2;color:#fff}.dialog_close_butt_mod_1 .ui-dialog-titlebar-close,.green_btn{color:#fefefe;background:#22b573}.btn_red{color:#fff;background:#f46b65}.btn_black{-webkit-transition:color .3s,box-shadow .3s;-ms-transition:color .3s,box-shadow .3s;transition:color .3s,box-shadow .3s;color:#fff;background:#101317}.btn_black:hover{color:#00b159;box-shadow:inset 0 0 0 1px #00b159}.yellow_btn{background:#fbe622;color:#000;box-shadow:0 3px 5px #7f7f7f}.green_btn_2{-webkit-transition:background-color .3s;-ms-transition:background-color .3s;transition:background-color .3s;background-color:#27ae60;color:#fff}.green_btn_2:hover{background-color:#229051}.ui-helper-hidden-accessible{z-index:5000;position:absolute;opacity:0;left:0;color:transparent;visibility:hidden}.ui-dialog{z-index:1000;position:absolute;outline:0;max-width:95%}.no_animation .ui-dialog,.ui-resizable-handle{display:none!important}@media only screen and (max-width:1039px){.ui-dialog.dialog_g_size_1{max-width:95%}}.dialog_global{box-shadow:0 3px 13px rgba(59,59,59,.86)}.ui-dialog-content{min-height:0!important}#video,.club .wrapper{min-height:100%}.dialog_color_schem_1 .ui-dialog-content{background:#e5e5e5}.ui-widget-overlay{z-index:500;position:fixed;width:100%;height:100%;left:0;top:0;background:rgba(0,0,0,.6)}.ui-helper-clearfix{display:block}.ui-helper-clearfix:after{display:block;height:0;clear:both;content:"";visibility:hidden}.hide,.no_close_mod .ui-dialog-titlebar-close{display:none!important}.dialog_close_butt_mod_1 .ui-dialog-titlebar-close{cursor:pointer;position:absolute;top:23px;right:23px;width:28px;height:28px;border-radius:100%}.is_overlay,body,html{height:100%}.dialog_close_butt_mod_1 .ui-dialog-titlebar-close:before{content:"";position:absolute;top:0;bottom:0;left:0;right:0;line-height:28px;text-align:center}.is_overlay,.wrapper{position:relative}.ui-draggable .ui-dialog-titlebar{cursor:move}.dialog_g_size_1 .ui-dialog-titlebar{padding:10px 50px 10px 20px;background:#f4f4f4;color:#1d1d1b;font-size:26px;font-weight:700}.dialog_g_size_2 .ui-dialog-titlebar{padding:0 50px;background:#f4f4f4;color:#1d1d1b;font-size:16px;font-weight:700}.title_center_mod .ui-dialog-titlebar{text-align:center}.dialog_butt_v1 .dialog_butt_wrap{padding:25px 0}html{overflow-y:scroll;overflow-x:hidden}body{font:14px/1.2 MyriadProRegular,sans-serif;color:#7f7f7f}body.ov_vis{overflow:visible!important}b{font-weight:700}.clearfix:after,.clearfix:before{content:" ";display:table}.factoid_section .backstretch:before,.factoid_title:before,.hero_sub_title:before,.img_gray_over .backstretch:before{content:'';bottom:0}.clearfix:after{clear:both}.is_overlay{display:block;width:100%;overflow:hidden}#video{position:absolute;width:auto;height:auto;min-width:100%}@media only screen and (min-width:1040px){.hero_block{padding-top:80px}}.hero_text{text-align:center;padding:30px 0;border:solid #000;border-width:2px 0;margin:0 auto;line-height:1.05;max-width:840px;position:relative;font-size:28px;font-weight:600;color:#000}@media only screen and (min-width:1040px){.hero_text{font-size:38px;padding:30px 20px}}@media only screen and (min-width:769px){.hero_unit{margin-top:30%}.hero_title_holder{float:left;width:62.5%}}.hero_controls{margin-top:-7px}.hero_slogan{font-size:108px;line-height:1;color:#fff}.hero_sub_title{position:relative;color:#fff;padding:8px 10px 3px 0;font-size:22px;min-width:83%;display:inline-block;vertical-align:top}.hero_sub_title:before{position:absolute;right:0;top:0;left:-5000px;background:rgba(0,0,0,.4)}.form_cell,.hero_tip,.input_w,.section_inner{position:relative}.hero_sub_title span{position:relative;z-index:1}.hero_btn_holder{clear:both}.hero_tip{border-top:2px solid #27ae60}.hero_tip p{margin:-2px 0 15px;background:#e8e8e8;color:#3c3c3c;float:right;font-size:13px;padding:3px 10px}@media only screen and (min-width:769px){.hero_btn_holder{clear:none;float:right;width:37.5%}.hero_tip p{padding:3px 55px}}.section_inner{z-index:1;width:100%;max-width:1044px;padding:0 10px;margin:0 auto}.form_caption{margin-bottom:14px;font-size:20px;font-weight:600}.form_cell.f_cell_v1{max-width:340px;margin:0 auto 10px}.form_tip{font-size:13px;font-weight:300;line-height:1.5}.tip_star{color:red}.f_input_v1{display:block;width:100%;color:#000;text-align:center;font-size:13px;padding:13px;height:44px;border-radius:4px;border:1px solid #c4c4c4;background:#fff}.f_input_v1.error{border-color:red}textarea.f_input_v1{height:150px}.club .f_input_v1{text-align:left;border-radius:0}.input_w{width:100%}.form_label{text-align:left;margin-bottom:5px}.abs_holder{position:absolute;top:0;bottom:0;left:0;right:0}.gl_table{display:table;width:100%;height:100%}.gl_table_cell{display:table-cell;width:100%;vertical-align:middle}.services{padding:0 0 40px;background:#fff}.service_list{font-size:0;text-align:center;margin-left:-12px;padding-top:22px}.service_list>li{display:inline-block;vertical-align:top;padding-left:12px;margin-bottom:18px;width:100%}@media only screen and (min-width:641px){.service_list li{width:50%}}@media only screen and (min-width:769px){.service_list{margin-right:-1%}.service_list li{width:33%}}@media only screen and (min-width:1040px){.service_list{margin-right:0}.service_list li{width:20%}}.service_img{height:265px;position:relative;overflow:hidden}.img_gray_over .backstretch:before{position:absolute;top:0;left:0;right:0;background:-moz-linear-gradient(top,rgba(255,255,255,0) 0,rgba(0,0,0,.35) 100%);background:-webkit-linear-gradient(top,rgba(255,255,255,0) 0,rgba(0,0,0,.35) 100%);background:linear-gradient(to bottom,rgba(255,255,255,0) 0,rgba(0,0,0,.35) 100%);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#00ffffff', endColorstr='#59000000', GradientType=0)}.backstretched>img{display:none!important}.factoid_section{position:relative;padding:80px 0 85px;color:#fff}.factoid_section .backstretch:before{position:absolute;top:0;left:0;right:0;background:rgba(0,0,0,.45)}.factoid_slider{position:relative}.factoid_slider .slide p{font-size:15px;max-width:550px}.factoid_slider .slick-dots{margin-left:-10px;padding-top:33px}.factoid_slider .slick-dots>li{display:inline-block;vertical-align:top;margin-left:10px}.factoid_slider .slick-dots>li.slick-active button{cursor:default;background:#fff}.factoid_slider .slick-dots button{-webkit-transition:background .3s;-ms-transition:background .3s;transition:background .3s;display:block;width:20px;height:5px;font-size:0;background:#c3c3c3;cursor:pointer}.factoid_slider .slick-dots button:hover{background:#fff}@media only screen and (min-width:769px){.factoid_slider{padding-right:37.5%}.factoid_slider_controls{position:absolute;bottom:0;right:0}}.factoid_slider_controls{text-align:center;padding:30px 0 15px}.factoid_title{font-size:22px;line-height:1.4;font-weight:300;position:relative;margin-bottom:40px;padding-bottom:10px;max-width:590px}.factoid_title:before{position:absolute;left:0;height:2px;width:82px;background:#fff}.factoid_slider_caption{font-size:18px;margin-bottom:15px}.service_unit{text-decoration:none;position:relative;display:block;color:#020400;text-align:center;border:1px solid #d9d9d9;overflow:hidden;font-size:14px}.object_description a,.service_info .object_description_link a{text-decoration:underline}.service_caption{height:110px;line-height:100px;padding:5px}.service_caption>span{display:inline-block;vertical-align:middle;line-height:normal}.benefit_img img,.benefits_list>li{display:inline-block;vertical-align:top}.service_info{-webkit-transition:opacity .3s;-ms-transition:opacity .3s;transition:opacity .3s;position:absolute;top:0;bottom:0;left:0;right:0;padding:10px;text-align:justify;overflow:hidden;opacity:0;font-size:13px;color:#fff;background:rgba(0,0,0,.95)}.benefits,.main_slider .slide,.main_slider_holder,.service_box,.slide_features ul li{position:relative}.service_info p{margin-bottom:10px}.service_info .object_description_link{text-align:right}.benefit_img,.benefit_unit,.benefits_list,.object_price{text-align:center}.service_unit:hover .service_info{opacity:1}.benefits{background:#fbfbfb}.benefits .section_caption{position:relative;z-index:1}.service_box{z-index:1;margin:0 30px;padding:0 10px;background:rgba(0,0,0,.6)}.service_box>div:first-child{padding-top:15px}.service_box .section_caption{padding:15px}.service_box .caption_description ul li{margin:10px 0}@media only screen and (min-width:1040px){.service_box{width:50%}}.benefits_list{font-size:0;padding:40px 0 35px;margin-left:-20px}.benefits_list>li{width:100%;margin-bottom:40px;padding-left:20px}@media only screen and (min-width:641px){.benefits_list>li{width:50%}}@media only screen and (min-width:1040px){.benefits_list>li{width:33%}}.benefit_unit p{font-size:14px;line-height:18px;color:#878c92}.benefit_img{margin-bottom:20px}.benefit_img img{max-width:100%;width:140px}.benefit_caption{text-transform:uppercase;color:#27ae60;margin-bottom:15px;font-size:24px;line-height:29px;font-weight:700}.main_slider_holder .abs_holder{pointer-events:none;z-index:10}.main_slider_holder .section_inner{pointer-events:all}.main_slider{min-height:100vh;height:400px}.main_slider .slick-list,.main_slider .slick-track,.main_slider .slide{height:100%}.main_slider .slide>img{display:none}.slide_btn,.slide_hero,.slide_info_holder{display:inline-block;vertical-align:top}.slide_hero{padding:19px 22px;text-transform:uppercase;background:rgba(41,51,61,.74);color:#fff;margin-top:125px;font-size:20px;line-height:26px;margin-bottom:22px;letter-spacing:-.035em}@media only screen and (min-width:769px){.slide_hero{font-size:36px;line-height:43px}}.slide_hero p{font-size:18px;line-height:1.5;letter-spacing:0;font-weight:400;text-transform:none}.slide_features{float:left;line-height:21px;font-size:18px;text-transform:uppercase;color:#fff;letter-spacing:-.01em}.slide_features ul li{padding-left:30px}.slide_features ul li:before{content:"";position:absolute;top:0;left:0;color:#27ae60;font-size:20px;line-height:22px}.object_list,.promo_slider_holder{position:relative}@media only screen and (min-width:769px){.slide_features{line-height:31px;font-size:24px}.slide_features ul li:before{font-size:26px;line-height:31px}}.slide_info_holder{margin-bottom:20px}.slide_info{background:#1f303a;padding:16px 45px 11px 27px}.slide_btn{margin-bottom:20px;max-width:100%}.slide_btn .send_order{padding-top:9px}@media only screen and (min-width:641px){.slide_btn .send_order{padding-left:103px}.slide_btn{width:380px}}@media only screen and (min-width:1120px){.slide_btn{margin-right:-60px}}.slide_btn_caption{text-transform:uppercase;font-size:26px;line-height:31px;font-weight:700}.slide_year{float:left;font-size:60px;min-width:200px;font-weight:700;line-height:1;margin-top:-7px;margin-bottom:20px;letter-spacing:1px}.promo_slider_holder .promo_slider{height:600px}.promo_slider_holder .slick-list,.promo_slider_holder .slick-track{height:100%}.promo_slider_holder .slide{height:100%;position:relative}.promo_slider_holder .slide>img{display:none}.object_list{margin:0 -10px 10px}@media only screen and (min-width:1040px){ul.object_list{margin-right:-1%}}ul.object_list>li{float:left;width:100%}@media only screen and (min-width:620px){ul.object_list>li{width:50%}}@media only screen and (min-width:960px){ul.object_list>li{width:33%}}.object_list.slick-initialized{padding:0 35px}@media only screen and (min-width:1140px){.object_list.slick-initialized{margin-left:-45px;margin-right:-45px}}.object_list.slick-initialized .slick-next,.object_list.slick-initialized .slick-prev{display:block}.object_list .slick-next{right:0}.object_list .slick-next:before{content:""}.object_list .slick-prev{left:0}.object_list .slick-prev:before{content:""}.contacts_section:before,.object_features dt:before,.review_section:before,.send_order:before,.text_block:before{content:''}.object_list .slick-next,.object_list .slick-prev{display:none;position:absolute;top:50%;margin-top:20px;font-size:0;background:0 0}.object_list .slick-next:before,.object_list .slick-prev:before{-webkit-transition:color .3s;-ms-transition:color .3s;transition:color .3s;font-size:40px;color:#a9a9a9}.object_list .slick-next:hover:before,.object_list .slick-prev:hover:before{color:#27ae60}.object_list .slide{padding:10px}.object_unit{-webkit-transition:box-shadow .3s;-ms-transition:box-shadow .3s;transition:box-shadow .3s;border:1px solid rgba(41,159,83,.35);padding-bottom:10px}.object_unit .object_img_loader,.object_unit>.object_img{height:207px;overflow:hidden}.object_unit:hover{box-shadow:0 0 10px rgba(7,23,12,.35)}.object_description{font-size:13px;line-height:1.5;padding:12px 10px;color:#001000;position:relative;height:11em}.object_description p{overflow:hidden;text-overflow:ellipsis;word-wrap:break-word;max-height:7.5em;line-height:1.5em;display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical}.object_description a:hover{text-decoration:none}.object_caption{font-size:18px;color:#000100;padding:0 10px}.slick-initialized .object_caption{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.object_img{display:block}.object_img img{display:block;min-width:100%;height:100%}.object_gallery{margin-left:-10px;margin-right:-1%;padding:10px 0}.object_gallery li{width:33%;float:left;padding-left:10px}.object_gallery .object_img{height:82px;overflow:hidden}.object_tip{color:#7f7f7f;font-size:12px;line-height:14px;padding:5px 10px 10px;min-height:43px}.object_price_w{position:relative;height:51px;overflow:hidden}.object_price_w .object_price,.object_price_w .object_price_btn{-webkit-transition:top .3s;-ms-transition:top .3s;transition:top .3s;position:absolute;right:0;left:0}.object_price_w .object_price{top:0}.object_price_w .object_price_btn{top:-51px;height:51px;text-align:center;font-size:20px;line-height:51px}.object_price_w:hover .object_price_btn{top:0}.object_price_w:hover .object_price{top:51px}.object_price{background:#27ae60}.object_price ._daily{font-size:12px;line-height:20px;padding-top:2px;margin:0 32px;color:#a1e2bd;border-bottom:1px solid #a1e2bd;text-decoration:line-through}.contact_block_btn,.menu_link,.mob_menu,.send_order,.sh_link{text-decoration:none}.object_price ._daily+._weekly{line-height:28px}.object_price ._weekly{color:#fff;line-height:51px;font-size:20px;letter-spacing:-.02em}.object_features{overflow:hidden;margin:0 10px}.object_features dd,.object_features dt{padding:9px 0 7px}.object_features dt{text-align:left;float:left;position:relative;clear:both;color:#878c92}.section_caption,.section_title{text-align:center;font-size:20px;line-height:24px;text-transform:uppercase;font-weight:600;letter-spacing:-.3px}.object_features dt:before{position:absolute;top:0;left:0;width:500px;background:#d9d9d9;height:1px}.object_features dt:first-child:before{display:none}.object_features dd{float:right;color:#000}.clr_green{color:#27ae60}.clr_white{color:#fff}.main_content.mod_1{padding-top:130px}.section_title{padding:25px 0 15px}@media only screen and (min-width:1040px){.section_title{padding:50px 0 40px}}.section_caption{padding:15px;color:#fff}.section_caption .caption_text{margin-bottom:20px;padding-right:20px;text-align:left;display:block}.caption_description,.partner_unit img,.partners_list li,.review_author_avatar,.send_order{display:inline-block;vertical-align:top}.section_caption .caption_text span{text-transform:none}@media only screen and (min-width:1040px){.section_caption .caption_text._full_cat{margin-top:-10px;margin-bottom:-10px}}.section_caption .caption_btn{margin-top:-8px;margin-bottom:-8px}@media only screen and (min-width:1040px){.section_caption{padding:25px;font-size:24px;line-height:30px}.section_caption .caption_text{float:left;margin-bottom:0}.section_caption .caption_btn{float:right}}.section_caption.caption_bg{background-color:#ededed;position:relative;color:#3c3c3c}.text_block{padding:30px 0;position:relative}.text_block:before{position:absolute;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,.75)}.text_block .section_inner{position:relative;z-index:1}.text_block p{font-size:16px;color:#000}.text_img{position:absolute;top:0;bottom:0;left:0;right:0}.sub_caption_text{font-size:20px}.caption_description{width:100%;clear:both;text-transform:none;font-size:14px;line-height:1.2;text-align:left}.caption_description p{margin-top:20px}.caption_description ul{padding-left:40px;list-style:disc;padding-bottom:5px}.caption_description ul li{margin:20px 0}.how_it_works{background:url(i/bg_how_it_works_2.jpg) 50% no-repeat;-webkit-background-size:cover;-moz-background-size:cover;-o-background-size:cover;background-size:cover;min-height:100vh}.how_it_works:first-child{padding-top:130px}.how_it_works_steps{padding-top:40px}.how_it_works_step{min-height:60px;padding:19px 15px 19px 80px;position:relative;margin-bottom:11px;background:rgba(41,51,61,.7)}.how_it_works_step p{line-height:22px;color:#fff;font-size:16px}.how_it_works_icon{position:absolute;background:#2d3a46;top:0;bottom:0;width:60px;left:0}.how_it_works_icon img{position:absolute;top:50%;left:50%;width:32px;height:32px;margin:-16px 0 0 -16px}@media only screen and (min-width:769px){.how_it_works .how_it_works_step{width:50%;clear:both;padding:19px 45px}.how_it_works .how_it_works_step:nth-child(even){float:left;margin-right:-60px;text-align:right;padding-left:15px}.how_it_works .how_it_works_step:nth-child(even) .how_it_works_icon{right:-30px;left:auto}.how_it_works .how_it_works_step:nth-child(odd){float:right;margin-left:-60px;padding-right:15px}.how_it_works .how_it_works_step:nth-child(odd) .how_it_works_icon{left:-30px}}@media only screen and (min-width:1140px){.how_it_works_steps{margin:0 -20px}}.send_order{position:relative;height:100px;padding:20px 10px 0 85px;max-width:625px;width:100%;margin-bottom:40px;text-align:left}.partner_unit,.partners_list,.review_unit{text-align:center}.send_order:before{position:absolute;top:15px;bottom:10px;left:77px;width:1px;background:#1c8046}.send_order_icon{position:absolute;top:0;bottom:0;left:0;width:87px}.send_order_icon img{position:absolute;top:50%;left:50%;width:47px;height:55px;margin:-28px 0 0 -23px}.send_order p{font-size:16px;font-weight:600;margin-bottom:7px}@media only screen and (min-width:641px){.send_order{padding-left:95px}.send_order:before{left:86px}.send_order p{font-size:26px}.send_order div{font-size:17px}.review_unit{text-align:left}}.partners_list{margin-left:-20px;padding-bottom:40px}.partners_list li{margin:50px 10px;padding-left:20px}@media only screen and (min-width:1040px){.partners_list li{float:left;margin:50px 0;width:20%}}.review_section{position:relative;background:url(i/reviews_bg_2.jpg) 50% no-repeat;-webkit-background-size:cover;-moz-background-size:cover;-o-background-size:cover;background-size:cover;min-height:280px;padding-bottom:25px}.review_section:before{position:absolute;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,.75)}.review_unit{color:#fff}.review_unit p{margin-top:20px;font-size:16px}.review_author_avatar{border-radius:100%;overflow:hidden;width:130px;height:130px}.review_author_avatar img{display:block}.review_author_name{padding-right:50px;text-align:right}.slider_holder{position:relative}.review_slider{padding:0 50px}@media only screen and (min-width:1040px){.review_slider{padding:0 155px}}.review_controls .slider_arrow{position:absolute;bottom:50%;height:50px;margin-bottom:-25px;text-align:center;cursor:pointer}.review_controls .slider_arrow:before{font-size:36px;line-height:50px;color:#fff}.review_controls .slider_prev{left:0}.review_controls .slider_next{right:0}.slick-list{overflow:hidden}.slick-track .slide{float:left}.contact_block{padding-top:20px}.contact_info{margin-bottom:25px;text-align:center}@media only screen and (min-width:1040px){.contact_block{padding-top:40px}._simple .contact_block{padding-top:20px}.contact_info{float:left;width:30%;text-align:left}._simple .contact_info{margin-bottom:0}}.contact_block_logo{display:inline-block;position:relative;line-height:1;z-index:17;margin-bottom:20px}.contact_block_logo img,.contact_block_logo span{display:inline-block;vertical-align:middle;line-height:1}.contact_block_logo span{font-size:15px;color:#a7a7a7;padding-left:12px;letter-spacing:-.3px}.contacts_section{position:relative;background:rgba(0,0,0,.9);padding-bottom:25px}.contacts_section:before{position:absolute;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,.75)}.contacts_section._simple{padding-bottom:5px}.contacts_section._simple .contact_info{width:100%}@media only screen and (min-width:641px){.review_author_avatar{float:left;margin-right:25px}.contacts_section._simple .contact_block_text{float:left;padding-right:20px}}@media only screen and (min-width:1040px){.contact_block_logo{margin-bottom:50px}.contacts_section._simple .contact_block_text{text-align:right;float:none;padding-right:0}}.contact_block_btn,.contact_block_questions,.contact_map_unit,.logo_block,.mob_menu{text-align:center}@media only screen and (min-width:641px){.contacts_section._simple .contact_block_btn{float:right}}.contacts_section._simple .contact_share_block{float:right;margin-right:-10px;text-align:center;padding-bottom:20px;padding-top:25px}.contacts_section._simple .contact_block_questions{clear:both;margin-top:10px}@media only screen and (min-width:1040px){.contacts_section._simple .contact_share_block{float:left;margin-right:0}.contacts_section._simple .contact_block_questions{width:30%;float:right;clear:none}}.contacts_section._simple .contact_block_logo{float:left;margin-right:20px}.contact_share_block>li{display:inline-block;vertical-align:top;padding-right:10px}.logo img,.logo span,.main_m_item{vertical-align:middle}.contact_share_block .sh_link{width:70px;height:70px}.contact_share_block .sh_link:before{font-size:50px;line-height:70px}._simple .contact_share_block .sh_link{width:40px;height:40px;background:0 0}._simple .contact_share_block .sh_link:before{font-size:34px;line-height:40px}.footer_v2 .contact_share_block .sh_link{width:30px;height:30px;background:0 0}.footer_v2 .contact_share_block .sh_link:before{font-size:25px;line-height:30px}.contact_block_questions{margin-top:20px}.contact_block_questions p{margin-bottom:25px;font-size:18px;color:#fff}.contact_block_caption{font-size:16px;font-weight:700;margin-bottom:5px}.contact_block_btn{display:block;height:65px;font-weight:600;font-size:25px;line-height:1;padding:20px}._simple .contact_block_btn{height:38px;font-size:18px;padding:10px}.contact_maps{margin-left:-20px}.contact_maps li{margin-bottom:25px;padding-left:20px}@media only screen and (min-width:641px){.contact_maps li{float:left;width:50%}}@media only screen and (min-width:1040px){.contact_block_questions{margin-top:35px}.contact_maps{float:right;width:70%}}.contact_map_unit{height:380px;border:1px solid #aaa;border-radius:0 0 10px 10px}.contact_map_unit p{line-height:20px;font-size:16px;color:#aaa;margin-bottom:10px}.contact_map_unit p a,.contact_map_unit p span{display:inline-block;vertical-align:middle}.contact_map_unit a{color:#aaa}.contact_block_addr{font-size:20px;line-height:24px;color:#fff;font-weight:600}.contact_map{position:relative;height:200px;overflow:hidden;margin-bottom:20px}.contact_map iframe{width:100%!important}.header{position:absolute;top:0;right:0;left:0;padding-top:10px;line-height:100px;z-index:15}.club .header{position:fixed;padding:10px 0;line-height:75px;background:rgba(0,0,0,.7)}.club .header .sh_link{background:0 0}.club .header .phones_callback_btn{font-size:14px;margin:0 0 3px;padding:4px 10px;border-radius:0}.club .header .phones_block{font-size:14px}.club .header .header_callback,.club .header .logo span,.club .header .nav_link{color:#fff}.club .header .logo img{max-width:70px}.mob_menu{-webkit-transition:transform .3s;-ms-transition:transform .3s;transition:transform .3s;position:absolute;top:10px;right:10px;width:50px;height:50px;z-index:10}.mob_menu:before{line-height:50px;font-size:26px;color:#fff}.open_menu .mob_menu{-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}@media only screen and (min-width:1040px){.mob_menu{display:none}.logo_block{float:left;padding-left:25px;text-align:left}}.logo,.logo img,.logo span{display:inline-block;line-height:1}.club .logo_block{padding-left:0}.logo{position:relative;z-index:17}.logo span{font-size:15px;color:#a7a7a7;padding-left:12px;letter-spacing:-.3px}.callback_block{float:right}@media only screen and (max-width:1039px){.nav_menu{position:fixed;top:156px;bottom:0;width:100%;max-width:300px;right:0;padding:20px;z-index:16;overflow-y:auto;background:#29333d;-webkit-transition:transform .3s;-ms-transition:transform .3s;transition:transform .3s;-webkit-transform:translate(100%,0);-ms-transform:translate(100%,0);transform:translate(100%,0)}.open_menu .nav_menu{-webkit-transform:translate(0,0);-ms-transform:translate(0,0);transform:translate(0,0)}.nav_menu>li{margin-bottom:15px}}.header_callback,.nav_menu{line-height:normal}@media only screen and (min-width:1040px){.nav_menu{margin-top:25px;-webkit-transform:translate(0,0);-ms-transform:translate(0,0);transform:translate(0,0)}.nav_menu>li{float:left;padding-left:38px}.club .nav_menu{margin-top:15px}.header_callback,.nav_menu{float:right;clear:right}}.header_callback{border-bottom:1px solid #3f4b59}.phones_callback_btn{display:block;text-transform:uppercase;text-align:center;font-size:16px;padding:14px 10px 6px;margin-top:-15px;border-radius:0 0 5px 5px}@media only screen and (max-width:1039px){.phones_callback_btn{width:50px;height:50px;border-radius:100%;position:absolute;top:10px;right:0}.phones_callback_btn:before{position:absolute;top:0;bottom:0;left:0;right:0;content:"";font-size:26px;line-height:50px}.phones_callback_btn span{display:none}}.phones_block{position:relative;padding:0 50px 10px 25px;font-size:16px;line-height:22px}.phones_block:before{content:"";position:absolute;top:0;left:0;color:#bfc4ca;font-size:16px;line-height:22px}.phones_block>li{padding-bottom:2px}.phones_block>li:last-child{padding-right:0}@media only screen and (min-width:1040px){.phones_block{float:left;padding-right:0;padding-bottom:2px}.phones_block:before{left:5px}.phones_block>li{float:left;padding:0 17px;border-left:1px solid #3f4b59}.phones_block>li:first-child{border-left:none}}.share_block{float:left;margin-right:20px}.share_block>li{float:left;padding-right:10px}@media only screen and (max-width:1039px){.share_block{position:absolute;top:20px;left:10px}}.sh_link{display:block;width:20px;height:20px;text-align:center;background:#bfc4ca;cursor:pointer}.sh_link:before{color:#fff;font-size:16px;line-height:20px}.sh_link:hover{background:#b1b7be}.small_contacts{float:left;text-align:left;margin-bottom:20px}@media only screen and (min-width:641px){.small_contacts{max-width:50%}}@media only screen and (max-width:640px){.small_contacts .contact_phones dd,.small_contacts .contact_phones dt{font-size:14px}}.contact_phones{margin-bottom:10px;padding-right:10px}.contact_phones dt{width:50%;float:left;text-align:right;padding-right:27px;position:relative}.contact_phones dt:before{content:"";width:20px;height:20px;line-height:20px;font-size:16px;position:absolute;top:50%;right:5px;color:#ffb600;margin-top:-10px}.contact_phones dt._email:before{content:""}.contact_phones dd{white-space:nowrap;float:right;width:50%}.contact_phones dd,.contact_phones dt{margin-bottom:4px;line-height:22px;font-size:18px;color:#fff}._simple .contact_phones dd,._simple .contact_phones dt{font-size:16px;line-height:20px}.contact_phones a{color:inherit}.main_menu{text-align:center;font-family:"Source Sans Pro",sans-serif;float:right}@media only screen and (min-width:1040px){.small_contacts{max-width:40%}.main_menu{float:right;padding-right:30px;text-align:left}}.main_m_item{display:inline-block;line-height:1;max-width:350px}.menu_item{float:left;margin:0 17px}.exchange_holder,.popup p{margin-bottom:20px}.menu_link{cursor:pointer;position:relative;display:block;padding-left:32px}.nav_link{display:block;font-size:14px;color:#a7a7a7}.footer_contact_phones li,.footer_contacts .contact_phones dt:before,.footer_v2 .contact_block_caption,.footer_v2 .contact_block_logo span,.footer_v2 .contact_block_questions p,.footer_v2 .contact_phones dd,.footer_v2 .contact_phones dt,.footer_v2 .sh_link:before{color:#3c3c3c}.nav_link:hover{text-decoration:underline}.footer{padding-top:10px;line-height:100px;background:#686151;border-bottom:2px solid #fff}.footer .section_inner{padding:0 25px}.popup{background:#f4f4f4;padding:0 20px 20px;text-align:center}.overlay{position:fixed;top:0;bottom:0;left:0;right:0;z-index:10;background:rgba(0,0,0,.75);display:none}.open_menu .overlay{display:block}@media only screen and (min-width:641px){.exchange_holder{float:right;max-width:50%}}.contact_block_q_center{max-width:300px;margin:0 auto}.weather_holder{margin-bottom:20px}@media only screen and (min-width:641px){.weather_holder{float:left;max-width:50%}}.footer_contacts{padding:40px 0 20px;text-align:center}.footer_contacts .contact_phones dd{min-width:60%;float:left}.footer_contacts .contact_phones dt{width:auto;padding-right:18px;clear:both}@media only screen and (max-width:768px){.footer_contact_info .contact_block_questions{clear:both}}@media only screen and (min-width:1040px){.exchange_holder{position:fixed;top:50%;right:0;z-index:30}.weather_holder{position:fixed;top:50%;left:0;z-index:30}.footer_contacts{max-width:30%;float:right;padding:0;text-align:left}.footer_contact_info{float:left;width:60%}.footer_contact_info .contact_block_questions{float:right;margin-top:0;text-align:left}}.footer_v2{background:#e8e8e8;padding:20px 0 60px}.footer_v2 .contact_block_caption{margin-bottom:15px;font:16px MyriadProBold,sans-serif}.footer_v2 .contact_share_block{float:right;margin-right:-10px;text-align:center;padding-bottom:20px;padding-top:25px}@media only screen and (min-width:1040px){.footer_v2 .contact_share_block{float:left;margin-right:0}.footer_v2{padding-bottom:20px}}.footer_v2 .contact_block_logo{float:left;margin-right:20px}.footer_contact_phones{text-align:center}.footer_contact_phones li{display:inline-block;vertical-align:top;margin:0 20px 10px;position:relative;padding-left:20px;font-size:14px;line-height:20px}.footer_contact_phones li:before{font-family:cypro_icons!important;speak:none;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;width:20px;height:20px;line-height:20px;font-size:16px;position:absolute;top:50%;left:0;color:#3c3c3c;margin-top:-10px}.footer_contact_phones li._phone:before{content:""}.footer_contact_phones li._email:before{content:""}.footer_contact_phones li a{color:inherit;text-decoration:none}@media only screen and (min-width:1040px){.footer_contact_phones{text-align:left}.footer_contact_phones li{display:block;margin:0 0 3px}}.text_center{text-align:center}.text_right{text-align:right}.text_left{text-align:left}.text_upper{text-transform:uppercase}</style><?php
/**
 * phpQuery is a server-side, chainable, CSS3 selector driven
 * Document Object Model (DOM) API based on jQuery JavaScript Library.
 *
 * @version 0.9.5
 * @link http://code.google.com/p/phpquery/
 * @link http://phpquery-library.blogspot.com/
 * @link http://jquery.com/
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @license http://www.opensource.org/licenses/mit-license.php MIT License
 * @package phpQuery
 */

// class names for instanceof
// TODO move them as class constants into phpQuery
define('DOMDOCUMENT', 'DOMDocument');
define('DOMELEMENT', 'DOMElement');
define('DOMNODELIST', 'DOMNodeList');
define('DOMNODE', 'DOMNode');

/**
 * DOMEvent class.
 *
 * Based on
 * @link http://developer.mozilla.org/En/DOM:event
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 * @todo implement ArrayAccess ?
 */
class DOMEvent {
	/**
	 * Returns a boolean indicating whether the event bubbles up through the DOM or not.
	 *
	 * @var unknown_type
	 */
	public $bubbles = true;
	/**
	 * Returns a boolean indicating whether the event is cancelable.
	 *
	 * @var unknown_type
	 */
	public $cancelable = true;
	/**
	 * Returns a reference to the currently registered target for the event.
	 *
	 * @var unknown_type
	 */
	public $currentTarget;
	/**
	 * Returns detail about the event, depending on the type of event.
	 *
	 * @var unknown_type
	 * @link http://developer.mozilla.org/en/DOM/event.detail
	 */
	public $detail;	// ???
	/**
	 * Used to indicate which phase of the event flow is currently being evaluated.
	 *
	 * NOT IMPLEMENTED
	 *
	 * @var unknown_type
	 * @link http://developer.mozilla.org/en/DOM/event.eventPhase
	 */
	public $eventPhase;	// ???
	/**
	 * The explicit original target of the event (Mozilla-specific).
	 *
	 * NOT IMPLEMENTED
	 *
	 * @var unknown_type
	 */
	public $explicitOriginalTarget; // moz only
	/**
	 * The original target of the event, before any retargetings (Mozilla-specific).
	 *
	 * NOT IMPLEMENTED
	 *
	 * @var unknown_type
	 */
	public $originalTarget;	// moz only
	/**
	 * Identifies a secondary target for the event.
	 *
	 * @var unknown_type
	 */
	public $relatedTarget;
	/**
	 * Returns a reference to the target to which the event was originally dispatched.
	 *
	 * @var unknown_type
	 */
	public $target;
	/**
	 * Returns the time that the event was created.
	 *
	 * @var unknown_type
	 */
	public $timeStamp;
	/**
	 * Returns the name of the event (case-insensitive).
	 */
	public $type;
	public $runDefault = true;
	public $data = null;
	public function __construct($data) {
		foreach($data as $k => $v) {
			$this->$k = $v;
		}
		if (! $this->timeStamp)
			$this->timeStamp = time();
	}
	/**
	 * Cancels the event (if it is cancelable).
	 *
	 */
	public function preventDefault() {
		$this->runDefault = false;
	}
	/**
	 * Stops the propagation of events further along in the DOM.
	 *
	 */
	public function stopPropagation() {
		$this->bubbles = false;
	}
}


/**
 * DOMDocumentWrapper class simplifies work with DOMDocument.
 *
 * Know bug:
 * - in XHTML fragments, <br /> changes to <br clear="none" />
 *
 * @todo check XML catalogs compatibility
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 */
class DOMDocumentWrapper {
	/**
	 * @var DOMDocument
	 */
	public $document;
	public $id;
	/**
	 * @todo Rewrite as method and quess if null.
	 * @var unknown_type
	 */
	public $contentType = '';
	public $xpath;
	public $uuid = 0;
	public $data = array();
	public $dataNodes = array();
	public $events = array();
	public $eventsNodes = array();
	public $eventsGlobal = array();
	/**
	 * @TODO iframes support http://code.google.com/p/phpquery/issues/detail?id=28
	 * @var unknown_type
	 */
	public $frames = array();
	/**
	 * Document root, by default equals to document itself.
	 * Used by documentFragments.
	 *
	 * @var DOMNode
	 */
	public $root;
	public $isDocumentFragment;
	public $isXML = false;
	public $isXHTML = false;
	public $isHTML = false;
	public $charset;
	public function __construct($markup = null, $contentType = null, $newDocumentID = null) {
		if (isset($markup))
			$this->load($markup, $contentType, $newDocumentID);
		$this->id = $newDocumentID
			? $newDocumentID
			: md5(microtime());
	}
	public function load($markup, $contentType = null, $newDocumentID = null) {
//		phpQuery::$documents[$id] = $this;
		$this->contentType = strtolower($contentType);
		if ($markup instanceof DOMDOCUMENT) {
			$this->document = $markup;
			$this->root = $this->document;
			$this->charset = $this->document->encoding;
			// TODO isDocumentFragment
		} else {
			$loaded = $this->loadMarkup($markup);
		}
		if ($loaded) {
//			$this->document->formatOutput = true;
			$this->document->preserveWhiteSpace = true;
			$this->xpath = new DOMXPath($this->document);
			$this->afterMarkupLoad();
			return true;
			// remember last loaded document
//			return phpQuery::selectDocument($id);
		}
		return false;
	}
	protected function afterMarkupLoad() {
		if ($this->isXHTML) {
			$this->xpath->registerNamespace("html", "http://www.w3.org/1999/xhtml");
		}
	}
	protected function loadMarkup($markup) {
		$loaded = false;
		if ($this->contentType) {
			self::debug("Load markup for content type {$this->contentType}");
			// content determined by contentType
			list($contentType, $charset) = $this->contentTypeToArray($this->contentType);
			switch($contentType) {
				case 'text/html':
					phpQuery::debug("Loading HTML, content type '{$this->contentType}'");
					$loaded = $this->loadMarkupHTML($markup, $charset);
				break;
				case 'text/xml':
				case 'application/xhtml+xml':
					phpQuery::debug("Loading XML, content type '{$this->contentType}'");
					$loaded = $this->loadMarkupXML($markup, $charset);
				break;
				default:
					// for feeds or anything that sometimes doesn't use text/xml
					if (strpos('xml', $this->contentType) !== false) {
						phpQuery::debug("Loading XML, content type '{$this->contentType}'");
						$loaded = $this->loadMarkupXML($markup, $charset);
					} else
						phpQuery::debug("Could not determine document type from content type '{$this->contentType}'");
			}
		} else {
			// content type autodetection
			if ($this->isXML($markup)) {
				phpQuery::debug("Loading XML, isXML() == true");
				$loaded = $this->loadMarkupXML($markup);
				if (! $loaded && $this->isXHTML) {
					phpQuery::debug('Loading as XML failed, trying to load as HTML, isXHTML == true');
					$loaded = $this->loadMarkupHTML($markup);
				}
			} else {
				phpQuery::debug("Loading HTML, isXML() == false");
				$loaded = $this->loadMarkupHTML($markup);
			}
		}
		return $loaded;
	}
	protected function loadMarkupReset() {
		$this->isXML = $this->isXHTML = $this->isHTML = false;
	}
	protected function documentCreate($charset, $version = '1.0') {
		if (! $version)
			$version = '1.0';
		$this->document = new DOMDocument($version, $charset);
		$this->charset = $this->document->encoding;
//		$this->document->encoding = $charset;
		$this->document->formatOutput = true;
		$this->document->preserveWhiteSpace = true;
	}
	protected function loadMarkupHTML($markup, $requestedCharset = null) {
		if (phpQuery::$debug)
			phpQuery::debug('Full markup load (HTML): '.substr($markup, 0, 250));
		$this->loadMarkupReset();
		$this->isHTML = true;
		if (!isset($this->isDocumentFragment))
			$this->isDocumentFragment = self::isDocumentFragmentHTML($markup);
		$charset = null;
		$documentCharset = $this->charsetFromHTML($markup);
		$addDocumentCharset = false;
		if ($documentCharset) {
			$charset = $documentCharset;
			$markup = $this->charsetFixHTML($markup);
		} else if ($requestedCharset) {
			$charset = $requestedCharset;
		}
		if (! $charset)
			$charset = phpQuery::$defaultCharset;
		// HTTP 1.1 says that the default charset is ISO-8859-1
		// @see http://www.w3.org/International/O-HTTP-charset
		if (! $documentCharset) {
			$documentCharset = 'ISO-8859-1';
			$addDocumentCharset = true;	
		}
		// Should be careful here, still need 'magic encoding detection' since lots of pages have other 'default encoding'
		// Worse, some pages can have mixed encodings... we'll try not to worry about that
		$requestedCharset = strtoupper($requestedCharset);
		$documentCharset = strtoupper($documentCharset);
		phpQuery::debug("DOC: $documentCharset REQ: $requestedCharset");
		if ($requestedCharset && $documentCharset && $requestedCharset !== $documentCharset) {
			phpQuery::debug("CHARSET CONVERT");
			// Document Encoding Conversion
			// http://code.google.com/p/phpquery/issues/detail?id=86
			if (function_exists('mb_detect_encoding')) {
				$possibleCharsets = array($documentCharset, $requestedCharset, 'AUTO');
				$docEncoding = mb_detect_encoding($markup, implode(', ', $possibleCharsets));
				if (! $docEncoding)
					$docEncoding = $documentCharset; // ok trust the document
				phpQuery::debug("DETECTED '$docEncoding'");
				// Detected does not match what document says...
				if ($docEncoding !== $documentCharset) {
					// Tricky..
				}
				if ($docEncoding !== $requestedCharset) {
					phpQuery::debug("CONVERT $docEncoding => $requestedCharset");
					$markup = mb_convert_encoding($markup, $requestedCharset, $docEncoding);
					$markup = $this->charsetAppendToHTML($markup, $requestedCharset);
					$charset = $requestedCharset;
				}
			} else {
				phpQuery::debug("TODO: charset conversion without mbstring...");
			}
		}
		$return = false;
		if ($this->isDocumentFragment) {
			phpQuery::debug("Full markup load (HTML), DocumentFragment detected, using charset '$charset'");
			$return = $this->documentFragmentLoadMarkup($this, $charset, $markup);
		} else {
			if ($addDocumentCharset) {
				phpQuery::debug("Full markup load (HTML), appending charset: '$charset'");
				$markup = $this->charsetAppendToHTML($markup, $charset);
			}
			phpQuery::debug("Full markup load (HTML), documentCreate('$charset')");
			$this->documentCreate($charset);
			$return = phpQuery::$debug === 2
				? $this->document->loadHTML($markup)
				: @$this->document->loadHTML($markup);
			if ($return)
				$this->root = $this->document;
		}
		if ($return && ! $this->contentType)
			$this->contentType = 'text/html';
		return $return;
	}
	protected function loadMarkupXML($markup, $requestedCharset = null) {
		if (phpQuery::$debug)
			phpQuery::debug('Full markup load (XML): '.substr($markup, 0, 250));
		$this->loadMarkupReset();
		$this->isXML = true;
		// check agains XHTML in contentType or markup
		$isContentTypeXHTML = $this->isXHTML();
		$isMarkupXHTML = $this->isXHTML($markup);
		if ($isContentTypeXHTML || $isMarkupXHTML) {
			self::debug('Full markup load (XML), XHTML detected');
			$this->isXHTML = true;
		}
		// determine document fragment
		if (! isset($this->isDocumentFragment))
			$this->isDocumentFragment = $this->isXHTML
				? self::isDocumentFragmentXHTML($markup)
				: self::isDocumentFragmentXML($markup);
		// this charset will be used
		$charset = null;
		// charset from XML declaration @var string
		$documentCharset = $this->charsetFromXML($markup);
		if (! $documentCharset) {
			if ($this->isXHTML) {
				// this is XHTML, try to get charset from content-type meta header
				$documentCharset = $this->charsetFromHTML($markup);
				if ($documentCharset) {
					phpQuery::debug("Full markup load (XML), appending XHTML charset '$documentCharset'");
					$this->charsetAppendToXML($markup, $documentCharset);
					$charset = $documentCharset;
				}
			}
			if (! $documentCharset) {
				// if still no document charset...
				$charset = $requestedCharset;
			}
		} else if ($requestedCharset) {
			$charset = $requestedCharset;
		}
		if (! $charset) {
			$charset = phpQuery::$defaultCharset;
		}
		if ($requestedCharset && $documentCharset && $requestedCharset != $documentCharset) {
			// TODO place for charset conversion
//			$charset = $requestedCharset;
		}
		$return = false;
		if ($this->isDocumentFragment) {
			phpQuery::debug("Full markup load (XML), DocumentFragment detected, using charset '$charset'");
			$return = $this->documentFragmentLoadMarkup($this, $charset, $markup);
		} else {
			// FIXME ???
			if ($isContentTypeXHTML && ! $isMarkupXHTML)
			if (! $documentCharset) {
				phpQuery::debug("Full markup load (XML), appending charset '$charset'");
				$markup = $this->charsetAppendToXML($markup, $charset);
			}
			// see http://pl2.php.net/manual/en/book.dom.php#78929
			// LIBXML_DTDLOAD (>= PHP 5.1)
			// does XML ctalogues works with LIBXML_NONET
	//		$this->document->resolveExternals = true;
			// TODO test LIBXML_COMPACT for performance improvement
			// create document
			$this->documentCreate($charset);
			if (phpversion() < 5.1) {
				$this->document->resolveExternals = true;
				$return = phpQuery::$debug === 2
					? $this->document->loadXML($markup)
					: @$this->document->loadXML($markup);
			} else {
				/** @link http://pl2.php.net/manual/en/libxml.constants.php */
				$libxmlStatic = phpQuery::$debug === 2
					? LIBXML_DTDLOAD|LIBXML_DTDATTR|LIBXML_NONET
					: LIBXML_DTDLOAD|LIBXML_DTDATTR|LIBXML_NONET|LIBXML_NOWARNING|LIBXML_NOERROR;
				$return = $this->document->loadXML($markup, $libxmlStatic);
// 				if (! $return)
// 					$return = $this->document->loadHTML($markup);
			}
			if ($return)
				$this->root = $this->document;
		}
		if ($return) {
			if (! $this->contentType) {
				if ($this->isXHTML)
					$this->contentType = 'application/xhtml+xml';
				else
					$this->contentType = 'text/xml';
			}
			return $return;
		} else {
			throw new Exception("Error loading XML markup");
		}
	}
	protected function isXHTML($markup = null) {
		if (! isset($markup)) {
			return strpos($this->contentType, 'xhtml') !== false;
		}
		// XXX ok ?
		return strpos($markup, "<!DOCTYPE html") !== false;
//		return stripos($doctype, 'xhtml') !== false;
//		$doctype = isset($dom->doctype) && is_object($dom->doctype)
//			? $dom->doctype->publicId
//			: self::$defaultDoctype;
	}
	protected function isXML($markup) {
//		return strpos($markup, '<?xml') !== false && stripos($markup, 'xhtml') === false;
		return strpos(substr($markup, 0, 100), '<'.'?xml') !== false;
	}
	protected function contentTypeToArray($contentType) {
		$matches = explode(';', trim(strtolower($contentType)));
		if (isset($matches[1])) {
			$matches[1] = explode('=', $matches[1]);
			// strip 'charset='
			$matches[1] = isset($matches[1][1]) && trim($matches[1][1])
				? $matches[1][1]
				: $matches[1][0];
		} else
			$matches[1] = null;
		return $matches;
	}
	/**
	 *
	 * @param $markup
	 * @return array contentType, charset
	 */
	protected function contentTypeFromHTML($markup) {
		$matches = array();
		// find meta tag
		preg_match('@<meta[^>]+http-equiv\\s*=\\s*(["|\'])Content-Type\\1([^>]+?)>@i',
			$markup, $matches
		);
		if (! isset($matches[0]))
			return array(null, null);
		// get attr 'content'
		preg_match('@content\\s*=\\s*(["|\'])(.+?)\\1@', $matches[0], $matches);
		if (! isset($matches[0]))
			return array(null, null);
		return $this->contentTypeToArray($matches[2]);
	}
	protected function charsetFromHTML($markup) {
		$contentType = $this->contentTypeFromHTML($markup);
		return $contentType[1];
	}
	protected function charsetFromXML($markup) {
		$matches;
		// find declaration
		preg_match('@<'.'?xml[^>]+encoding\\s*=\\s*(["|\'])(.*?)\\1@i',
			$markup, $matches
		);
		return isset($matches[2])
			? strtolower($matches[2])
			: null;
	}
	/**
	 * Repositions meta[type=charset] at the start of head. Bypasses DOMDocument bug.
	 *
	 * @link http://code.google.com/p/phpquery/issues/detail?id=80
	 * @param $html
	 */
	protected function charsetFixHTML($markup) {
		$matches = array();
		// find meta tag
		preg_match('@\s*<meta[^>]+http-equiv\\s*=\\s*(["|\'])Content-Type\\1([^>]+?)>@i',
			$markup, $matches, PREG_OFFSET_CAPTURE
		);
		if (! isset($matches[0]))
			return;
		$metaContentType = $matches[0][0];
		$markup = substr($markup, 0, $matches[0][1])
			.substr($markup, $matches[0][1]+strlen($metaContentType));
		$headStart = stripos($markup, '<head>');
		$markup = substr($markup, 0, $headStart+6).$metaContentType
			.substr($markup, $headStart+6);
		return $markup;
	}
	protected function charsetAppendToHTML($html, $charset, $xhtml = false) {
		// remove existing meta[type=content-type]
		$html = preg_replace('@\s*<meta[^>]+http-equiv\\s*=\\s*(["|\'])Content-Type\\1([^>]+?)>@i', '', $html);
		$meta = '<meta http-equiv="Content-Type" content="text/html;charset='
			.$charset.'" '
			.($xhtml ? '/' : '')
			.'>';
		if (strpos($html, '<head') === false) {
			if (strpos($hltml, '<html') === false) {
				return $meta.$html;
			} else {
				return preg_replace(
					'@<html(.*?)(?(?<!\?)>)@s',
					"<html\\1><head>{$meta}</head>",
					$html
				);
			}
		} else {
			return preg_replace(
				'@<head(.*?)(?(?<!\?)>)@s',
				'<head\\1>'.$meta,
				$html
			);
		}
	}
	protected function charsetAppendToXML($markup, $charset) {
		$declaration = '<'.'?xml version="1.0" encoding="'.$charset.'"?'.'>';
		return $declaration.$markup;
	}
	public static function isDocumentFragmentHTML($markup) {
		return stripos($markup, '<html') === false && stripos($markup, '<!doctype') === false;
	}
	public static function isDocumentFragmentXML($markup) {
		return stripos($markup, '<'.'?xml') === false;
	}
	public static function isDocumentFragmentXHTML($markup) {
		return self::isDocumentFragmentHTML($markup);
	}
	public function importAttr($value) {
		// TODO
	}
	/**
	 *
	 * @param $source
	 * @param $target
	 * @param $sourceCharset
	 * @return array Array of imported nodes.
	 */
	public function import($source, $sourceCharset = null) {
		// TODO charset conversions
		$return = array();
		if ($source instanceof DOMNODE && !($source instanceof DOMNODELIST))
			$source = array($source);
//		if (is_array($source)) {
//			foreach($source as $node) {
//				if (is_string($node)) {
//					// string markup
//					$fake = $this->documentFragmentCreate($node, $sourceCharset);
//					if ($fake === false)
//						throw new Exception("Error loading documentFragment markup");
//					else
//						$return = array_merge($return, 
//							$this->import($fake->root->childNodes)
//						);
//				} else {
//					$return[] = $this->document->importNode($node, true);
//				}
//			}
//			return $return;
//		} else {
//			// string markup
//			$fake = $this->documentFragmentCreate($source, $sourceCharset);
//			if ($fake === false)
//				throw new Exception("Error loading documentFragment markup");
//			else
//				return $this->import($fake->root->childNodes);
//		}
		if (is_array($source) || $source instanceof DOMNODELIST) {
			// dom nodes
			self::debug('Importing nodes to document');
			foreach($source as $node)
				$return[] = $this->document->importNode($node, true);
		} else {
			// string markup
			$fake = $this->documentFragmentCreate($source, $sourceCharset);
			if ($fake === false)
				throw new Exception("Error loading documentFragment markup");
			else
				return $this->import($fake->root->childNodes);
		}
		return $return;
	}
	/**
	 * Creates new document fragment.
	 *
	 * @param $source
	 * @return DOMDocumentWrapper
	 */
	protected function documentFragmentCreate($source, $charset = null) {
		$fake = new DOMDocumentWrapper();
		$fake->contentType = $this->contentType;
		$fake->isXML = $this->isXML;
		$fake->isHTML = $this->isHTML;
		$fake->isXHTML = $this->isXHTML;
		$fake->root = $fake->document;
		if (! $charset)
			$charset = $this->charset;
//	$fake->documentCreate($this->charset);
		if ($source instanceof DOMNODE && !($source instanceof DOMNODELIST))
			$source = array($source);
		if (is_array($source) || $source instanceof DOMNODELIST) {
			// dom nodes
			// load fake document
			if (! $this->documentFragmentLoadMarkup($fake, $charset))
				return false;
			$nodes = $fake->import($source);
			foreach($nodes as $node)
				$fake->root->appendChild($node);
		} else {
			// string markup
			$this->documentFragmentLoadMarkup($fake, $charset, $source);
		}
		return $fake;
	}
	/**
	 *
	 * @param $document DOMDocumentWrapper
	 * @param $markup
	 * @return $document
	 */
	private function documentFragmentLoadMarkup($fragment, $charset, $markup = null) {
		// TODO error handling
		// TODO copy doctype
		// tempolary turn off
		$fragment->isDocumentFragment = false;
		if ($fragment->isXML) {
			if ($fragment->isXHTML) {
				// add FAKE element to set default namespace
				$fragment->loadMarkupXML('<?xml version="1.0" encoding="'.$charset.'"?>'
					.'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" '
					.'"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'
					.'<fake xmlns="http://www.w3.org/1999/xhtml">'.$markup.'</fake>');
				$fragment->root = $fragment->document->firstChild->nextSibling;
			} else {
				$fragment->loadMarkupXML('<?xml version="1.0" encoding="'.$charset.'"?><fake>'.$markup.'</fake>');
				$fragment->root = $fragment->document->firstChild;
			}
		} else {
			$markup2 = phpQuery::$defaultDoctype.'<html><head><meta http-equiv="Content-Type" content="text/html;charset='
				.$charset.'"></head>';
			$noBody = strpos($markup, '<body') === false;
			if ($noBody)
				$markup2 .= '<body>';
			$markup2 .= $markup;
			if ($noBody)
				$markup2 .= '</body>';
			$markup2 .= '</html>';
			$fragment->loadMarkupHTML($markup2);
			// TODO resolv body tag merging issue
			$fragment->root = $noBody
				? $fragment->document->firstChild->nextSibling->firstChild->nextSibling
				: $fragment->document->firstChild->nextSibling->firstChild->nextSibling;
		}
		if (! $fragment->root)
			return false;
		$fragment->isDocumentFragment = true;
		return true;
	}
	protected function documentFragmentToMarkup($fragment) {
		phpQuery::debug('documentFragmentToMarkup');
		$tmp = $fragment->isDocumentFragment;
		$fragment->isDocumentFragment = false;
		$markup = $fragment->markup();
		if ($fragment->isXML) {
			$markup = substr($markup, 0, strrpos($markup, '</fake>'));
			if ($fragment->isXHTML) {
				$markup = substr($markup, strpos($markup, '<fake')+43);
			} else {
				$markup = substr($markup, strpos($markup, '<fake>')+6);
			}
		} else {
				$markup = substr($markup, strpos($markup, '<body>')+6);
				$markup = substr($markup, 0, strrpos($markup, '</body>'));
		}
		$fragment->isDocumentFragment = $tmp;
		if (phpQuery::$debug)
			phpQuery::debug('documentFragmentToMarkup: '.substr($markup, 0, 150));
		return $markup;
	}
	/**
	 * Return document markup, starting with optional $nodes as root.
	 *
	 * @param $nodes	DOMNode|DOMNodeList
	 * @return string
	 */
	public function markup($nodes = null, $innerMarkup = false) {
		if (isset($nodes) && count($nodes) == 1 && $nodes[0] instanceof DOMDOCUMENT)
			$nodes = null;
		if (isset($nodes)) {
			$markup = '';
			if (!is_array($nodes) && !($nodes instanceof DOMNODELIST) )
				$nodes = array($nodes);
			if ($this->isDocumentFragment && ! $innerMarkup)
				foreach($nodes as $i => $node)
					if ($node->isSameNode($this->root)) {
					//	var_dump($node);
						$nodes = array_slice($nodes, 0, $i)
							+ phpQuery::DOMNodeListToArray($node->childNodes)
							+ array_slice($nodes, $i+1);
						}
			if ($this->isXML && ! $innerMarkup) {
				self::debug("Getting outerXML with charset '{$this->charset}'");
				// we need outerXML, so we can benefit from
				// $node param support in saveXML()
				foreach($nodes as $node)
					$markup .= $this->document->saveXML($node);
			} else {
				$loop = array();
				if ($innerMarkup)
					foreach($nodes as $node) {
						if ($node->childNodes)
							foreach($node->childNodes as $child)
								$loop[] = $child;
						else
							$loop[] = $node;
					}
				else
					$loop = $nodes;
				self::debug("Getting markup, moving selected nodes (".count($loop).") to new DocumentFragment");
				$fake = $this->documentFragmentCreate($loop);
				$markup = $this->documentFragmentToMarkup($fake);
			}
			if ($this->isXHTML) {
				self::debug("Fixing XHTML");
				$markup = self::markupFixXHTML($markup);
			}
			self::debug("Markup: ".substr($markup, 0, 250));
			return $markup;
		} else {
			if ($this->isDocumentFragment) {
				// documentFragment, html only...
				self::debug("Getting markup, DocumentFragment detected");
//				return $this->markup(
////					$this->document->getElementsByTagName('body')->item(0)
//					$this->document->root, true
//				);
				$markup = $this->documentFragmentToMarkup($this);
				// no need for markupFixXHTML, as it's done thought markup($nodes) method
				return $markup;
			} else {
				self::debug("Getting markup (".($this->isXML?'XML':'HTML')."), final with charset '{$this->charset}'");
				$markup = $this->isXML
					? $this->document->saveXML()
					: $this->document->saveHTML();
				if ($this->isXHTML) {
					self::debug("Fixing XHTML");
					$markup = self::markupFixXHTML($markup);
				}
				self::debug("Markup: ".substr($markup, 0, 250));
				return $markup;
			}
		}
	}
	protected static function markupFixXHTML($markup) {
		$markup = self::expandEmptyTag('script', $markup);
		$markup = self::expandEmptyTag('select', $markup);
		$markup = self::expandEmptyTag('textarea', $markup);
		return $markup;
	}
	public static function debug($text) {
		phpQuery::debug($text);
	}
	/**
	 * expandEmptyTag
	 *
	 * @param $tag
	 * @param $xml
	 * @return unknown_type
	 * @author mjaque at ilkebenson dot com
	 * @link http://php.net/manual/en/domdocument.savehtml.php#81256
	 */
	public static function expandEmptyTag($tag, $xml){
        $indice = 0;
        while ($indice< strlen($xml)){
            $pos = strpos($xml, "<$tag ", $indice);
            if ($pos){
                $posCierre = strpos($xml, ">", $pos);
                if ($xml[$posCierre-1] == "/"){
                    $xml = substr_replace($xml, "></$tag>", $posCierre-1, 2);
                }
                $indice = $posCierre;
            }
            else break;
        }
        return $xml;
	}
}

/**
 * Event handling class.
 *
 * @author Tobiasz Cudnik
 * @package phpQuery
 * @static
 */
abstract class phpQueryEvents {
	/**
	 * Trigger a type of event on every matched element.
	 *
	 * @param DOMNode|phpQueryObject|string $document
	 * @param unknown_type $type
	 * @param unknown_type $data
	 *
	 * @TODO exclusive events (with !)
	 * @TODO global events (test)
	 * @TODO support more than event in $type (space-separated)
	 */
	public static function trigger($document, $type, $data = array(), $node = null) {
		// trigger: function(type, data, elem, donative, extra) {
		$documentID = phpQuery::getDocumentID($document);
		$namespace = null;
		if (strpos($type, '.') !== false)
			list($name, $namespace) = explode('.', $type);
		else
			$name = $type;
		if (! $node) {
			if (self::issetGlobal($documentID, $type)) {
				$pq = phpQuery::getDocument($documentID);
				// TODO check add($pq->document)
				$pq->find('*')->add($pq->document)
					->trigger($type, $data);
			}
		} else {
			if (isset($data[0]) && $data[0] instanceof DOMEvent) {
				$event = $data[0];
				$event->relatedTarget = $event->target;
				$event->target = $node;
				$data = array_slice($data, 1);
			} else {
				$event = new DOMEvent(array(
					'type' => $type,
					'target' => $node,
					'timeStamp' => time(),
				));
			}
			$i = 0;
			while($node) {
				// TODO whois
				phpQuery::debug("Triggering ".($i?"bubbled ":'')."event '{$type}' on "
					."node \n");//.phpQueryObject::whois($node)."\n");
				$event->currentTarget = $node;
				$eventNode = self::getNode($documentID, $node);
				if (isset($eventNode->eventHandlers)) {
					foreach($eventNode->eventHandlers as $eventType => $handlers) {
						$eventNamespace = null;
						if (strpos($type, '.') !== false)
							list($eventName, $eventNamespace) = explode('.', $eventType);
						else
							$eventName = $eventType;
						if ($name != $eventName)
							continue;
						if ($namespace && $eventNamespace && $namespace != $eventNamespace)
							continue;
						foreach($handlers as $handler) {
							phpQuery::debug("Calling event handler\n");
							$event->data = $handler['data']
								? $handler['data']
								: null;
							$params = array_merge(array($event), $data);
							$return = phpQuery::callbackRun($handler['callback'], $params);
							if ($return === false) {
								$event->bubbles = false;
							}
						}
					}
				}
				// to bubble or not to bubble...
				if (! $event->bubbles)
					break;
				$node = $node->parentNode;
				$i++;
			}
		}
	}
	/**
	 * Binds a handler to one or more events (like click) for each matched element.
	 * Can also bind custom events.
	 *
	 * @param DOMNode|phpQueryObject|string $document
	 * @param unknown_type $type
	 * @param unknown_type $data Optional
	 * @param unknown_type $callback
	 *
	 * @TODO support '!' (exclusive) events
	 * @TODO support more than event in $type (space-separated)
	 * @TODO support binding to global events
	 */
	public static function add($document, $node, $type, $data, $callback = null) {
		phpQuery::debug("Binding '$type' event");
		$documentID = phpQuery::getDocumentID($document);
//		if (is_null($callback) && is_callable($data)) {
//			$callback = $data;
//			$data = null;
//		}
		$eventNode = self::getNode($documentID, $node);
		if (! $eventNode)
			$eventNode = self::setNode($documentID, $node);
		if (!isset($eventNode->eventHandlers[$type]))
			$eventNode->eventHandlers[$type] = array();
		$eventNode->eventHandlers[$type][] = array(
			'callback' => $callback,
			'data' => $data,
		);
	}
	/**
	 * Enter description here...
	 *
	 * @param DOMNode|phpQueryObject|string $document
	 * @param unknown_type $type
	 * @param unknown_type $callback
	 *
	 * @TODO namespace events
	 * @TODO support more than event in $type (space-separated)
	 */
	public static function remove($document, $node, $type = null, $callback = null) {
		$documentID = phpQuery::getDocumentID($document);
		$eventNode = self::getNode($documentID, $node);
		if (is_object($eventNode) && isset($eventNode->eventHandlers[$type])) {
			if ($callback) {
				foreach($eventNode->eventHandlers[$type] as $k => $handler)
					if ($handler['callback'] == $callback)
						unset($eventNode->eventHandlers[$type][$k]);
			} else {
				unset($eventNode->eventHandlers[$type]);
			}
		}
	}
	protected static function getNode($documentID, $node) {
		foreach(phpQuery::$documents[$documentID]->eventsNodes as $eventNode) {
			if ($node->isSameNode($eventNode))
				return $eventNode;
		}
	}
	protected static function setNode($documentID, $node) {
		phpQuery::$documents[$documentID]->eventsNodes[] = $node;
		return phpQuery::$documents[$documentID]->eventsNodes[
			count(phpQuery::$documents[$documentID]->eventsNodes)-1
		];
	}
	protected static function issetGlobal($documentID, $type) {
		return isset(phpQuery::$documents[$documentID])
			? in_array($type, phpQuery::$documents[$documentID]->eventsGlobal)
			: false;
	}
}


interface ICallbackNamed {
	function hasName();
	function getName();
}
/**
 * Callback class introduces currying-like pattern.
 * 
 * Example:
 * function foo($param1, $param2, $param3) {
 *   var_dump($param1, $param2, $param3);
 * }
 * $fooCurried = new Callback('foo', 
 *   'param1 is now statically set', 
 *   new CallbackParam, new CallbackParam
 * );
 * phpQuery::callbackRun($fooCurried,
 * 	array('param2 value', 'param3 value'
 * );
 * 
 * Callback class is supported in all phpQuery methods which accepts callbacks. 
 *
 * @link http://code.google.com/p/phpquery/wiki/Callbacks#Param_Structures
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * 
 * @TODO??? return fake forwarding function created via create_function
 * @TODO honor paramStructure
 */
class Callback
	implements ICallbackNamed {
	public $callback = null;
	public $params = null;
	protected $name;
	public function __construct($callback, $param1 = null, $param2 = null, 
			$param3 = null) {
		$params = func_get_args();
		$params = array_slice($params, 1);
		if ($callback instanceof Callback) {
			// TODO implement recurention
		} else {
			$this->callback = $callback;
			$this->params = $params;
		}
	}
	public function getName() {
		return 'Callback: '.$this->name;
	}
	public function hasName() {
		return isset($this->name) && $this->name;
	}
	public function setName($name) {
		$this->name = $name;
		return $this;
	}
	// TODO test me
//	public function addParams() {
//		$params = func_get_args();
//		return new Callback($this->callback, $this->params+$params);
//	}
}
/**
 * Shorthand for new Callback(create_function(...), ...);
 * 
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackBody extends Callback {
	public function __construct($paramList, $code, $param1 = null, $param2 = null, 
			$param3 = null) {
		$params = func_get_args();
		$params = array_slice($params, 2);
		$this->callback = create_function($paramList, $code);
		$this->params = $params;
	}
}
/**
 * Callback type which on execution returns reference passed during creation.
 * 
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackReturnReference extends Callback
	implements ICallbackNamed {
	protected $reference;
	public function __construct(&$reference, $name = null){
		$this->reference =& $reference;
		$this->callback = array($this, 'callback');
	}
	public function callback() {
		return $this->reference;
	}
	public function getName() {
		return 'Callback: '.$this->name;
	}
	public function hasName() {
		return isset($this->name) && $this->name;
	}
}
/**
 * Callback type which on execution returns value passed during creation.
 * 
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackReturnValue extends Callback
	implements ICallbackNamed {
	protected $value;
	protected $name;
	public function __construct($value, $name = null){
		$this->value =& $value;
		$this->name = $name;
		$this->callback = array($this, 'callback');
	}
	public function callback() {
		return $this->value;
	}
	public function __toString() {
		return $this->getName();
	}
	public function getName() {
		return 'Callback: '.$this->name;
	}
	public function hasName() {
		return isset($this->name) && $this->name;
	}
}
/**
 * CallbackParameterToReference can be used when we don't really want a callback,
 * only parameter passed to it. CallbackParameterToReference takes first 
 * parameter's value and passes it to reference.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 */
class CallbackParameterToReference extends Callback {
	/**
	 * @param $reference
	 * @TODO implement $paramIndex; 
	 * param index choose which callback param will be passed to reference
	 */
	public function __construct(&$reference){
		$this->callback =& $reference;
	}
}
//class CallbackReference extends Callback {
//	/**
//	 *
//	 * @param $reference
//	 * @param $paramIndex
//	 * @todo implement $paramIndex; param index choose which callback param will be passed to reference
//	 */
//	public function __construct(&$reference, $name = null){
//		$this->callback =& $reference;
//	}
//}
class CallbackParam {}

/**
 * Class representing phpQuery objects.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 * @method phpQueryObject clone() clone()
 * @method phpQueryObject empty() empty()
 * @method phpQueryObject next() next($selector = null)
 * @method phpQueryObject prev() prev($selector = null)
 * @property Int $length
 */
class phpQueryObject
	implements Iterator, Countable, ArrayAccess {
	public $documentID = null;
	/**
	 * DOMDocument class.
	 *
	 * @var DOMDocument
	 */
	public $document = null;
	public $charset = null;
	/**
	 *
	 * @var DOMDocumentWrapper
	 */
	public $documentWrapper = null;
	/**
	 * XPath interface.
	 *
	 * @var DOMXPath
	 */
	public $xpath = null;
	/**
	 * Stack of selected elements.
	 * @TODO refactor to ->nodes
	 * @var array
	 */
	public $elements = array();
	/**
	 * @access private
	 */
	protected $elementsBackup = array();
	/**
	 * @access private
	 */
	protected $previous = null;
	/**
	 * @access private
	 * @TODO deprecate
	 */
	protected $root = array();
	/**
	 * Indicated if doument is just a fragment (no <html> tag).
	 *
	 * Every document is realy a full document, so even documentFragments can
	 * be queried against <html>, but getDocument(id)->htmlOuter() will return
	 * only contents of <body>.
	 *
	 * @var bool
	 */
	public $documentFragment = true;
	/**
	 * Iterator interface helper
	 * @access private
	 */
	protected $elementsInterator = array();
	/**
	 * Iterator interface helper
	 * @access private
	 */
	protected $valid = false;
	/**
	 * Iterator interface helper
	 * @access private
	 */
	protected $current = null;
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function __construct($documentID) {
//		if ($documentID instanceof self)
//			var_dump($documentID->getDocumentID());
		$id = $documentID instanceof self
			? $documentID->getDocumentID()
			: $documentID;
//		var_dump($id);
		if (! isset(phpQuery::$documents[$id] )) {
//			var_dump(phpQuery::$documents);
			throw new Exception("Document with ID '{$id}' isn't loaded. Use phpQuery::newDocument(\$html) or phpQuery::newDocumentFile(\$file) first.");
		}
		$this->documentID = $id;
		$this->documentWrapper =& phpQuery::$documents[$id];
		$this->document =& $this->documentWrapper->document;
		$this->xpath =& $this->documentWrapper->xpath;
		$this->charset =& $this->documentWrapper->charset;
		$this->documentFragment =& $this->documentWrapper->isDocumentFragment;
		// TODO check $this->DOM->documentElement;
//		$this->root = $this->document->documentElement;
		$this->root =& $this->documentWrapper->root;
//		$this->toRoot();
		$this->elements = array($this->root);
	}
	/**
	 *
	 * @access private
	 * @param $attr
	 * @return unknown_type
	 */
	public function __get($attr) {
		switch($attr) {
			// FIXME doesnt work at all ?
			case 'length':
				return $this->size();
			break;
			default:
				return $this->$attr;
		}
	}
	/**
	 * Saves actual object to $var by reference.
	 * Useful when need to break chain.
	 * @param phpQueryObject $var
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function toReference(&$var) {
		return $var = $this;
	}
	public function documentFragment($state = null) {
		if ($state) {
			phpQuery::$documents[$this->getDocumentID()]['documentFragment'] = $state;
			return $this;
		}
		return $this->documentFragment;
	}
	/**
   * @access private
   * @TODO documentWrapper
	 */
	protected function isRoot( $node) {
//		return $node instanceof DOMDOCUMENT || $node->tagName == 'html';
		return $node instanceof DOMDOCUMENT
			|| ($node instanceof DOMELEMENT && $node->tagName == 'html')
			|| $this->root->isSameNode($node);
	}
	/**
   * @access private
	 */
	protected function stackIsRoot() {
		return $this->size() == 1 && $this->isRoot($this->elements[0]);
	}
	/**
	 * Enter description here...
	 * NON JQUERY METHOD
	 *
	 * Watch out, it doesn't creates new instance, can be reverted with end().
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function toRoot() {
		$this->elements = array($this->root);
		return $this;
//		return $this->newInstance(array($this->root));
	}
	/**
	 * Saves object's DocumentID to $var by reference.
	 * <code>
	 * $myDocumentId;
	 * phpQuery::newDocument('<div/>')
	 *     ->getDocumentIDRef($myDocumentId)
	 *     ->find('div')->...
	 * </code>
	 *
	 * @param unknown_type $domId
	 * @see phpQuery::newDocument
	 * @see phpQuery::newDocumentFile
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function getDocumentIDRef(&$documentID) {
		$documentID = $this->getDocumentID();
		return $this;
	}
	/**
	 * Returns object with stack set to document root.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function getDocument() {
		return phpQuery::getDocument($this->getDocumentID());
	}
	/**
	 *
	 * @return DOMDocument
	 */
	public function getDOMDocument() {
		return $this->document;
	}
	/**
	 * Get object's Document ID.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function getDocumentID() {
		return $this->documentID;
	}
	/**
	 * Unloads whole document from memory.
	 * CAUTION! None further operations will be possible on this document.
	 * All objects refering to it will be useless.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function unloadDocument() {
		phpQuery::unloadDocuments($this->getDocumentID());
	}
	public function isHTML() {
		return $this->documentWrapper->isHTML;
	}
	public function isXHTML() {
		return $this->documentWrapper->isXHTML;
	}
	public function isXML() {
		return $this->documentWrapper->isXML;
	}
	/**
	 * Enter description here...
	 *
	 * @link http://docs.jquery.com/Ajax/serialize
	 * @return string
	 */
	public function serialize() {
		return phpQuery::param($this->serializeArray());
	}
	/**
	 * Enter description here...
	 *
	 * @link http://docs.jquery.com/Ajax/serializeArray
	 * @return array
	 */
	public function serializeArray($submit = null) {
		$source = $this->filter('form, input, select, textarea')
			->find('input, select, textarea')
			->andSelf()
			->not('form');
		$return = array();
//		$source->dumpDie();
		foreach($source as $input) {
			$input = phpQuery::pq($input);
			if ($input->is('[disabled]'))
				continue;
			if (!$input->is('[name]'))
				continue;
			if ($input->is('[type=checkbox]') && !$input->is('[checked]'))
				continue;
			// jquery diff
			if ($submit && $input->is('[type=submit]')) {
				if ($submit instanceof DOMELEMENT && ! $input->elements[0]->isSameNode($submit))
					continue;
				else if (is_string($submit) && $input->attr('name') != $submit)
					continue;
			}
			$return[] = array(
				'name' => $input->attr('name'),
				'value' => $input->val(),
			);
		}
		return $return;
	}
	/**
	 * @access private
	 */
	protected function debug($in) {
		if (! phpQuery::$debug )
			return;
		print('<pre>');
		print_r($in);
		// file debug
//		file_put_contents(dirname(__FILE__).'/phpQuery.log', print_r($in, true)."\n", FILE_APPEND);
		// quite handy debug trace
//		if ( is_array($in))
//			print_r(array_slice(debug_backtrace(), 3));
		print("</pre>\n");
	}
	/**
	 * @access private
	 */
	protected function isRegexp($pattern) {
		return in_array(
			$pattern[ mb_strlen($pattern)-1 ],
			array('^','*','$')
		);
	}
	/**
	 * Determines if $char is really a char.
	 *
	 * @param string $char
	 * @return bool
	 * @todo rewrite me to charcode range ! ;)
	 * @access private
	 */
	protected function isChar($char) {
		return extension_loaded('mbstring') && phpQuery::$mbstringSupport
			? mb_eregi('\w', $char)
			: preg_match('@\w@', $char);
	}
	/**
	 * @access private
	 */
	protected function parseSelector($query) {
		// clean spaces
		// TODO include this inside parsing ?
		$query = trim(
			preg_replace('@\s+@', ' ',
				preg_replace('@\s*(>|\\+|~)\s*@', '\\1', $query)
			)
		);
		$queries = array(array());
		if (! $query)
			return $queries;
		$return =& $queries[0];
		$specialChars = array('>',' ');
//		$specialCharsMapping = array('/' => '>');
		$specialCharsMapping = array();
		$strlen = mb_strlen($query);
		$classChars = array('.', '-');
		$pseudoChars = array('-');
		$tagChars = array('*', '|', '-');
		// split multibyte string
		// http://code.google.com/p/phpquery/issues/detail?id=76
		$_query = array();
		for ($i=0; $i<$strlen; $i++)
			$_query[] = mb_substr($query, $i, 1);
		$query = $_query;
		// it works, but i dont like it...
		$i = 0;
		while( $i < $strlen) {
			$c = $query[$i];
			$tmp = '';
			// TAG
			if ($this->isChar($c) || in_array($c, $tagChars)) {
				while(isset($query[$i])
					&& ($this->isChar($query[$i]) || in_array($query[$i], $tagChars))) {
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// IDs
			} else if ( $c == '#') {
				$i++;
				while( isset($query[$i]) && ($this->isChar($query[$i]) || $query[$i] == '-')) {
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = '#'.$tmp;
			// SPECIAL CHARS
			} else if (in_array($c, $specialChars)) {
				$return[] = $c;
				$i++;
			// MAPPED SPECIAL MULTICHARS
//			} else if ( $c.$query[$i+1] == '//') {
//				$return[] = ' ';
//				$i = $i+2;
			// MAPPED SPECIAL CHARS
			} else if ( isset($specialCharsMapping[$c])) {
				$return[] = $specialCharsMapping[$c];
				$i++;
			// COMMA
			} else if ( $c == ',') {
				$queries[] = array();
				$return =& $queries[ count($queries)-1 ];
				$i++;
				while( isset($query[$i]) && $query[$i] == ' ')
					$i++;
			// CLASSES
			} else if ($c == '.') {
				while( isset($query[$i]) && ($this->isChar($query[$i]) || in_array($query[$i], $classChars))) {
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// ~ General Sibling Selector
			} else if ($c == '~') {
				$spaceAllowed = true;
				$tmp .= $query[$i++];
				while( isset($query[$i])
					&& ($this->isChar($query[$i])
						|| in_array($query[$i], $classChars)
						|| $query[$i] == '*'
						|| ($query[$i] == ' ' && $spaceAllowed)
					)) {
					if ($query[$i] != ' ')
						$spaceAllowed = false;
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// + Adjacent sibling selectors
			} else if ($c == '+') {
				$spaceAllowed = true;
				$tmp .= $query[$i++];
				while( isset($query[$i])
					&& ($this->isChar($query[$i])
						|| in_array($query[$i], $classChars)
						|| $query[$i] == '*'
						|| ($spaceAllowed && $query[$i] == ' ')
					)) {
					if ($query[$i] != ' ')
						$spaceAllowed = false;
					$tmp .= $query[$i];
					$i++;
				}
				$return[] = $tmp;
			// ATTRS
			} else if ($c == '[') {
				$stack = 1;
				$tmp .= $c;
				while( isset($query[++$i])) {
					$tmp .= $query[$i];
					if ( $query[$i] == '[') {
						$stack++;
					} else if ( $query[$i] == ']') {
						$stack--;
						if (! $stack )
							break;
					}
				}
				$return[] = $tmp;
				$i++;
			// PSEUDO CLASSES
			} else if ($c == ':') {
				$stack = 1;
				$tmp .= $query[$i++];
				while( isset($query[$i]) && ($this->isChar($query[$i]) || in_array($query[$i], $pseudoChars))) {
					$tmp .= $query[$i];
					$i++;
				}
				// with arguments ?
				if ( isset($query[$i]) && $query[$i] == '(') {
					$tmp .= $query[$i];
					$stack = 1;
					while( isset($query[++$i])) {
						$tmp .= $query[$i];
						if ( $query[$i] == '(') {
							$stack++;
						} else if ( $query[$i] == ')') {
							$stack--;
							if (! $stack )
								break;
						}
					}
					$return[] = $tmp;
					$i++;
				} else {
					$return[] = $tmp;
				}
			} else {
				$i++;
			}
		}
		foreach($queries as $k => $q) {
			if (isset($q[0])) {
				if (isset($q[0][0]) && $q[0][0] == ':')
					array_unshift($queries[$k], '*');
				if ($q[0] != '>')
					array_unshift($queries[$k], ' ');
			}
		}
		return $queries;
	}
	/**
	 * Return matched DOM nodes.
	 *
	 * @param int $index
	 * @return array|DOMElement Single DOMElement or array of DOMElement.
	 */
	public function get($index = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		$return = isset($index)
			? (isset($this->elements[$index]) ? $this->elements[$index] : null)
			: $this->elements;
		// pass thou callbacks
		$args = func_get_args();
		$args = array_slice($args, 1);
		foreach($args as $callback) {
			if (is_array($return))
				foreach($return as $k => $v)
					$return[$k] = phpQuery::callbackRun($callback, array($v));
			else
				$return = phpQuery::callbackRun($callback, array($return));
		}
		return $return;
	}
	/**
	 * Return matched DOM nodes.
	 * jQuery difference.
	 *
	 * @param int $index
	 * @return array|string Returns string if $index != null
	 * @todo implement callbacks
	 * @todo return only arrays ?
	 * @todo maybe other name...
	 */
	public function getString($index = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if ($index)
			$return = $this->eq($index)->text();
		else {
			$return = array();
			for($i = 0; $i < $this->size(); $i++) {
				$return[] = $this->eq($i)->text();
			}
		}
		// pass thou callbacks
		$args = func_get_args();
		$args = array_slice($args, 1);
		foreach($args as $callback) {
			$return = phpQuery::callbackRun($callback, array($return));
		}
		return $return;
	}
	/**
	 * Return matched DOM nodes.
	 * jQuery difference.
	 *
	 * @param int $index
	 * @return array|string Returns string if $index != null
	 * @todo implement callbacks
	 * @todo return only arrays ?
	 * @todo maybe other name...
	 */
	public function getStrings($index = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if ($index)
			$return = $this->eq($index)->text();
		else {
			$return = array();
			for($i = 0; $i < $this->size(); $i++) {
				$return[] = $this->eq($i)->text();
			}
			// pass thou callbacks
			$args = func_get_args();
			$args = array_slice($args, 1);
		}
		foreach($args as $callback) {
			if (is_array($return))
				foreach($return as $k => $v)
					$return[$k] = phpQuery::callbackRun($callback, array($v));
			else
				$return = phpQuery::callbackRun($callback, array($return));
		}
		return $return;
	}
	/**
	 * Returns new instance of actual class.
	 *
	 * @param array $newStack Optional. Will replace old stack with new and move old one to history.c
	 */
	public function newInstance($newStack = null) {
		$class = get_class($this);
		// support inheritance by passing old object to overloaded constructor
		$new = $class != 'phpQuery'
			? new $class($this, $this->getDocumentID())
			: new phpQueryObject($this->getDocumentID());
		$new->previous = $this;
		if (is_null($newStack)) {
			$new->elements = $this->elements;
			if ($this->elementsBackup)
				$this->elements = $this->elementsBackup;
		} else if (is_string($newStack)) {
			$new->elements = phpQuery::pq($newStack, $this->getDocumentID())->stack();
		} else {
			$new->elements = $newStack;
		}
		return $new;
	}
	/**
	 * Enter description here...
	 *
	 * In the future, when PHP will support XLS 2.0, then we would do that this way:
	 * contains(tokenize(@class, '\s'), "something")
	 * @param unknown_type $class
	 * @param unknown_type $node
	 * @return boolean
	 * @access private
	 */
	protected function matchClasses($class, $node) {
		// multi-class
		if ( mb_strpos($class, '.', 1)) {
			$classes = explode('.', substr($class, 1));
			$classesCount = count( $classes );
			$nodeClasses = explode(' ', $node->getAttribute('class') );
			$nodeClassesCount = count( $nodeClasses );
			if ( $classesCount > $nodeClassesCount )
				return false;
			$diff = count(
				array_diff(
					$classes,
					$nodeClasses
				)
			);
			if (! $diff )
				return true;
		// single-class
		} else {
			return in_array(
				// strip leading dot from class name
				substr($class, 1),
				// get classes for element as array
				explode(' ', $node->getAttribute('class') )
			);
		}
	}
	/**
	 * @access private
	 */
	protected function runQuery($XQuery, $selector = null, $compare = null) {
		if ($compare && ! method_exists($this, $compare))
			return false;
		$stack = array();
		if (! $this->elements)
			$this->debug('Stack empty, skipping...');
//		var_dump($this->elements[0]->nodeType);
		// element, document
		foreach($this->stack(array(1, 9, 13)) as $k => $stackNode) {
			$detachAfter = false;
			// to work on detached nodes we need temporary place them somewhere
			// thats because context xpath queries sucks ;]
			$testNode = $stackNode;
			while ($testNode) {
				if (! $testNode->parentNode && ! $this->isRoot($testNode)) {
					$this->root->appendChild($testNode);
					$detachAfter = $testNode;
					break;
				}
				$testNode = isset($testNode->parentNode)
					? $testNode->parentNode
					: null;
			}
			// XXX tmp ?
			$xpath = $this->documentWrapper->isXHTML
				? $this->getNodeXpath($stackNode, 'html')
				: $this->getNodeXpath($stackNode);
			// FIXME pseudoclasses-only query, support XML
			$query = $XQuery == '//' && $xpath == '/html[1]'
				? '//*'
				: $xpath.$XQuery;
			$this->debug("XPATH: {$query}");
			// run query, get elements
			$nodes = $this->xpath->query($query);
			$this->debug("QUERY FETCHED");
			if (! $nodes->length )
				$this->debug('Nothing found');
			$debug = array();
			foreach($nodes as $node) {
				$matched = false;
				if ( $compare) {
					phpQuery::$debug ?
						$this->debug("Found: ".$this->whois( $node ).", comparing with {$compare}()")
						: null;
					$phpQueryDebug = phpQuery::$debug;
					phpQuery::$debug = false;
					// TODO ??? use phpQuery::callbackRun()
					if (call_user_func_array(array($this, $compare), array($selector, $node)))
						$matched = true;
					phpQuery::$debug = $phpQueryDebug;
				} else {
					$matched = true;
				}
				if ( $matched) {
					if (phpQuery::$debug)
						$debug[] = $this->whois( $node );
					$stack[] = $node;
				}
			}
			if (phpQuery::$debug) {
				$this->debug("Matched ".count($debug).": ".implode(', ', $debug));
			}
			if ($detachAfter)
				$this->root->removeChild($detachAfter);
		}
		$this->elements = $stack;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function find($selectors, $context = null, $noHistory = false) {
		if (!$noHistory)
			// backup last stack /for end()/
			$this->elementsBackup = $this->elements;
		// allow to define context
		// TODO combine code below with phpQuery::pq() context guessing code
		//   as generic function
		if ($context) {
			if (! is_array($context) && $context instanceof DOMELEMENT)
				$this->elements = array($context);
			else if (is_array($context)) {
				$this->elements = array();
				foreach ($context as $c)
					if ($c instanceof DOMELEMENT)
						$this->elements[] = $c;
			} else if ( $context instanceof self )
				$this->elements = $context->elements;
		}
		$queries = $this->parseSelector($selectors);
		$this->debug(array('FIND', $selectors, $queries));
		$XQuery = '';
		// remember stack state because of multi-queries
		$oldStack = $this->elements;
		// here we will be keeping found elements
		$stack = array();
		foreach($queries as $selector) {
			$this->elements = $oldStack;
			$delimiterBefore = false;
			foreach($selector as $s) {
				// TAG
				$isTag = extension_loaded('mbstring') && phpQuery::$mbstringSupport
					? mb_ereg_match('^[\w|\||-]+$', $s) || $s == '*'
					: preg_match('@^[\w|\||-]+$@', $s) || $s == '*';
				if ($isTag) {
					if ($this->isXML()) {
						// namespace support
						if (mb_strpos($s, '|') !== false) {
							$ns = $tag = null;
							list($ns, $tag) = explode('|', $s);
							$XQuery .= "$ns:$tag";
						} else if ($s == '*') {
							$XQuery .= "*";
						} else {
							$XQuery .= "*[local-name()='$s']";
						}
					} else {
						$XQuery .= $s;
					}
				// ID
				} else if ($s[0] == '#') {
					if ($delimiterBefore)
						$XQuery .= '*';
					$XQuery .= "[@id='".substr($s, 1)."']";
				// ATTRIBUTES
				} else if ($s[0] == '[') {
					if ($delimiterBefore)
						$XQuery .= '*';
					// strip side brackets
					$attr = trim($s, '][');
					$execute = false;
					// attr with specifed value
					if (mb_strpos($s, '=')) {
						$value = null;
						list($attr, $value) = explode('=', $attr);
						$value = trim($value, "'\"");
						if ($this->isRegexp($attr)) {
							// cut regexp character
							$attr = substr($attr, 0, -1);
							$execute = true;
							$XQuery .= "[@{$attr}]";
						} else {
							$XQuery .= "[@{$attr}='{$value}']";
						}
					// attr without specified value
					} else {
						$XQuery .= "[@{$attr}]";
					}
					if ($execute) {
						$this->runQuery($XQuery, $s, 'is');
						$XQuery = '';
						if (! $this->length())
							break;
					}
				// CLASSES
				} else if ($s[0] == '.') {
					// TODO use return $this->find("./self::*[contains(concat(\" \",@class,\" \"), \" $class \")]");
					// thx wizDom ;)
					if ($delimiterBefore)
						$XQuery .= '*';
					$XQuery .= '[@class]';
					$this->runQuery($XQuery, $s, 'matchClasses');
					$XQuery = '';
					if (! $this->length() )
						break;
				// ~ General Sibling Selector
				} else if ($s[0] == '~') {
					$this->runQuery($XQuery);
					$XQuery = '';
					$this->elements = $this
						->siblings(
							substr($s, 1)
						)->elements;
					if (! $this->length() )
						break;
				// + Adjacent sibling selectors
				} else if ($s[0] == '+') {
					// TODO /following-sibling::
					$this->runQuery($XQuery);
					$XQuery = '';
					$subSelector = substr($s, 1);
					$subElements = $this->elements;
					$this->elements = array();
					foreach($subElements as $node) {
						// search first DOMElement sibling
						$test = $node->nextSibling;
						while($test && ! ($test instanceof DOMELEMENT))
							$test = $test->nextSibling;
						if ($test && $this->is($subSelector, $test))
							$this->elements[] = $test;
					}
					if (! $this->length() )
						break;
				// PSEUDO CLASSES
				} else if ($s[0] == ':') {
					// TODO optimization for :first :last
					if ($XQuery) {
						$this->runQuery($XQuery);
						$XQuery = '';
					}
					if (! $this->length())
						break;
					$this->pseudoClasses($s);
					if (! $this->length())
						break;
				// DIRECT DESCENDANDS
				} else if ($s == '>') {
					$XQuery .= '/';
					$delimiterBefore = 2;
				// ALL DESCENDANDS
				} else if ($s == ' ') {
					$XQuery .= '//';
					$delimiterBefore = 2;
				// ERRORS
				} else {
					phpQuery::debug("Unrecognized token '$s'");
				}
				$delimiterBefore = $delimiterBefore === 2;
			}
			// run query if any
			if ($XQuery && $XQuery != '//') {
				$this->runQuery($XQuery);
				$XQuery = '';
			}
			foreach($this->elements as $node)
				if (! $this->elementsContainsNode($node, $stack))
					$stack[] = $node;
		}
		$this->elements = $stack;
		return $this->newInstance();
	}
	/**
	 * @todo create API for classes with pseudoselectors
	 * @access private
	 */
	protected function pseudoClasses($class) {
		// TODO clean args parsing ?
		$class = ltrim($class, ':');
		$haveArgs = mb_strpos($class, '(');
		if ($haveArgs !== false) {
			$args = substr($class, $haveArgs+1, -1);
			$class = substr($class, 0, $haveArgs);
		}
		switch($class) {
			case 'even':
			case 'odd':
				$stack = array();
				foreach($this->elements as $i => $node) {
					if ($class == 'even' && ($i%2) == 0)
						$stack[] = $node;
					else if ( $class == 'odd' && $i % 2 )
						$stack[] = $node;
				}
				$this->elements = $stack;
				break;
			case 'eq':
				$k = intval($args);
				$this->elements = isset( $this->elements[$k] )
					? array( $this->elements[$k] )
					: array();
				break;
			case 'gt':
				$this->elements = array_slice($this->elements, $args+1);
				break;
			case 'lt':
				$this->elements = array_slice($this->elements, 0, $args+1);
				break;
			case 'first':
				if (isset($this->elements[0]))
					$this->elements = array($this->elements[0]);
				break;
			case 'last':
				if ($this->elements)
					$this->elements = array($this->elements[count($this->elements)-1]);
				break;
			/*case 'parent':
				$stack = array();
				foreach($this->elements as $node) {
					if ( $node->childNodes->length )
						$stack[] = $node;
				}
				$this->elements = $stack;
				break;*/
			case 'contains':
				$text = trim($args, "\"'");
				$stack = array();
				foreach($this->elements as $node) {
					if (mb_stripos($node->textContent, $text) === false)
						continue;
					$stack[] = $node;
				}
				$this->elements = $stack;
				break;
			case 'not':
				$selector = self::unQuote($args);
				$this->elements = $this->not($selector)->stack();
				break;
			case 'slice':
				// TODO jQuery difference ?
				$args = explode(',',
					str_replace(', ', ',', trim($args, "\"'"))
				);
				$start = $args[0];
				$end = isset($args[1])
					? $args[1]
					: null;
				if ($end > 0)
					$end = $end-$start;
				$this->elements = array_slice($this->elements, $start, $end);
				break;
			case 'has':
				$selector = trim($args, "\"'");
				$stack = array();
				foreach($this->stack(1) as $el) {
					if ($this->find($selector, $el, true)->length)
						$stack[] = $el;
				}
				$this->elements = $stack;
				break;
			case 'submit':
			case 'reset':
				$this->elements = phpQuery::merge(
					$this->map(array($this, 'is'),
						"input[type=$class]", new CallbackParam()
					),
					$this->map(array($this, 'is'),
						"button[type=$class]", new CallbackParam()
					)
				);
			break;
//				$stack = array();
//				foreach($this->elements as $node)
//					if ($node->is('input[type=submit]') || $node->is('button[type=submit]'))
//						$stack[] = $el;
//				$this->elements = $stack;
			case 'input':
				$this->elements = $this->map(
					array($this, 'is'),
					'input', new CallbackParam()
				)->elements;
			break;
			case 'password':
			case 'checkbox':
			case 'radio':
			case 'hidden':
			case 'image':
			case 'file':
				$this->elements = $this->map(
					array($this, 'is'),
					"input[type=$class]", new CallbackParam()
				)->elements;
			break;
			case 'parent':
				$this->elements = $this->map(
					create_function('$node', '
						return $node instanceof DOMELEMENT && $node->childNodes->length
							? $node : null;')
				)->elements;
			break;
			case 'empty':
				$this->elements = $this->map(
					create_function('$node', '
						return $node instanceof DOMELEMENT && $node->childNodes->length
							? null : $node;')
				)->elements;
			break;
			case 'disabled':
			case 'selected':
			case 'checked':
				$this->elements = $this->map(
					array($this, 'is'),
					"[$class]", new CallbackParam()
				)->elements;
			break;
			case 'enabled':
				$this->elements = $this->map(
					create_function('$node', '
						return pq($node)->not(":disabled") ? $node : null;')
				)->elements;
			break;
			case 'header':
				$this->elements = $this->map(
					create_function('$node',
						'$isHeader = isset($node->tagName) && in_array($node->tagName, array(
							"h1", "h2", "h3", "h4", "h5", "h6", "h7"
						));
						return $isHeader
							? $node
							: null;')
				)->elements;
//				$this->elements = $this->map(
//					create_function('$node', '$node = pq($node);
//						return $node->is("h1")
//							|| $node->is("h2")
//							|| $node->is("h3")
//							|| $node->is("h4")
//							|| $node->is("h5")
//							|| $node->is("h6")
//							|| $node->is("h7")
//							? $node
//							: null;')
//				)->elements;
			break;
			case 'only-child':
				$this->elements = $this->map(
					create_function('$node',
						'return pq($node)->siblings()->size() == 0 ? $node : null;')
				)->elements;
			break;
			case 'first-child':
				$this->elements = $this->map(
					create_function('$node', 'return pq($node)->prevAll()->size() == 0 ? $node : null;')
				)->elements;
			break;
			case 'last-child':
				$this->elements = $this->map(
					create_function('$node', 'return pq($node)->nextAll()->size() == 0 ? $node : null;')
				)->elements;
			break;
			case 'nth-child':
				$param = trim($args, "\"'");
				if (! $param)
					break;
					// nth-child(n+b) to nth-child(1n+b)
				if ($param{0} == 'n')
					$param = '1'.$param;
				// :nth-child(index/even/odd/equation)
				if ($param == 'even' || $param == 'odd')
					$mapped = $this->map(
						create_function('$node, $param',
							'$index = pq($node)->prevAll()->size()+1;
							if ($param == "even" && ($index%2) == 0)
								return $node;
							else if ($param == "odd" && $index%2 == 1)
								return $node;
							else
								return null;'),
						new CallbackParam(), $param
					);
				else if (mb_strlen($param) > 1 && $param{1} == 'n')
					// an+b
					$mapped = $this->map(
						create_function('$node, $param',
							'$prevs = pq($node)->prevAll()->size();
							$index = 1+$prevs;
							$b = mb_strlen($param) > 3
								? $param{3}
								: 0;
							$a = $param{0};
							if ($b && $param{2} == "-")
								$b = -$b;
							if ($a > 0) {
								return ($index-$b)%$a == 0
									? $node
									: null;
								phpQuery::debug($a."*".floor($index/$a)."+$b-1 == ".($a*floor($index/$a)+$b-1)." ?= $prevs");
								return $a*floor($index/$a)+$b-1 == $prevs
										? $node
										: null;
							} else if ($a == 0)
								return $index == $b
										? $node
										: null;
							else
								// negative value
								return $index <= $b
										? $node
										: null;
//							if (! $b)
//								return $index%$a == 0
//									? $node
//									: null;
//							else
//								return ($index-$b)%$a == 0
//									? $node
//									: null;
							'),
						new CallbackParam(), $param
					);
				else
					// index
					$mapped = $this->map(
						create_function('$node, $index',
							'$prevs = pq($node)->prevAll()->size();
							if ($prevs && $prevs == $index-1)
								return $node;
							else if (! $prevs && $index == 1)
								return $node;
							else
								return null;'),
						new CallbackParam(), $param
					);
				$this->elements = $mapped->elements;
			break;
			default:
				$this->debug("Unknown pseudoclass '{$class}', skipping...");
		}
	}
	/**
	 * @access private
	 */
	protected function __pseudoClassParam($paramsString) {
		// TODO;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function is($selector, $nodes = null) {
		phpQuery::debug(array("Is:", $selector));
		if (! $selector)
			return false;
		$oldStack = $this->elements;
		$returnArray = false;
		if ($nodes && is_array($nodes)) {
			$this->elements = $nodes;
		} else if ($nodes)
			$this->elements = array($nodes);
		$this->filter($selector, true);
		$stack = $this->elements;
		$this->elements = $oldStack;
		if ($nodes)
			return $stack ? $stack : null;
		return (bool)count($stack);
	}
	/**
	 * Enter description here...
	 * jQuery difference.
	 *
	 * Callback:
	 * - $index int
	 * - $node DOMNode
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @link http://docs.jquery.com/Traversing/filter
	 */
	public function filterCallback($callback, $_skipHistory = false) {
		if (! $_skipHistory) {
			$this->elementsBackup = $this->elements;
			$this->debug("Filtering by callback");
		}
		$newStack = array();
		foreach($this->elements as $index => $node) {
			$result = phpQuery::callbackRun($callback, array($index, $node));
			if (is_null($result) || (! is_null($result) && $result))
				$newStack[] = $node;
		}
		$this->elements = $newStack;
		return $_skipHistory
			? $this
			: $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @link http://docs.jquery.com/Traversing/filter
	 */
	public function filter($selectors, $_skipHistory = false) {
		if ($selectors instanceof Callback OR $selectors instanceof Closure)
			return $this->filterCallback($selectors, $_skipHistory);
		if (! $_skipHistory)
			$this->elementsBackup = $this->elements;
		$notSimpleSelector = array(' ', '>', '~', '+', '/');
		if (! is_array($selectors))
			$selectors = $this->parseSelector($selectors);
		if (! $_skipHistory)
			$this->debug(array("Filtering:", $selectors));
		$finalStack = array();
		foreach($selectors as $selector) {
			$stack = array();
			if (! $selector)
				break;
			// avoid first space or /
			if (in_array($selector[0], $notSimpleSelector))
				$selector = array_slice($selector, 1);
			// PER NODE selector chunks
			foreach($this->stack() as $node) {
				$break = false;
				foreach($selector as $s) {
					if (!($node instanceof DOMELEMENT)) {
						// all besides DOMElement
						if ( $s[0] == '[') {
							$attr = trim($s, '[]');
							if ( mb_strpos($attr, '=')) {
								list( $attr, $val ) = explode('=', $attr);
								if ($attr == 'nodeType' && $node->nodeType != $val)
									$break = true;
							}
						} else
							$break = true;
					} else {
						// DOMElement only
						// ID
						if ( $s[0] == '#') {
							if ( $node->getAttribute('id') != substr($s, 1) )
								$break = true;
						// CLASSES
						} else if ( $s[0] == '.') {
							if (! $this->matchClasses( $s, $node ) )
								$break = true;
						// ATTRS
						} else if ( $s[0] == '[') {
							// strip side brackets
							$attr = trim($s, '[]');
							if (mb_strpos($attr, '=')) {
								list($attr, $val) = explode('=', $attr);
								$val = self::unQuote($val);
								if ($attr == 'nodeType') {
									if ($val != $node->nodeType)
										$break = true;
								} else if ($this->isRegexp($attr)) {
									$val = extension_loaded('mbstring') && phpQuery::$mbstringSupport
										? quotemeta(trim($val, '"\''))
										: preg_quote(trim($val, '"\''), '@');
									// switch last character
									switch( substr($attr, -1)) {
										// quotemeta used insted of preg_quote
										// http://code.google.com/p/phpquery/issues/detail?id=76
										case '^':
											$pattern = '^'.$val;
											break;
										case '*':
											$pattern = '.*'.$val.'.*';
											break;
										case '$':
											$pattern = '.*'.$val.'$';
											break;
									}
									// cut last character
									$attr = substr($attr, 0, -1);
									$isMatch = extension_loaded('mbstring') && phpQuery::$mbstringSupport
										? mb_ereg_match($pattern, $node->getAttribute($attr))
										: preg_match("@{$pattern}@", $node->getAttribute($attr));
									if (! $isMatch)
										$break = true;
								} else if ($node->getAttribute($attr) != $val)
									$break = true;
							} else if (! $node->hasAttribute($attr))
								$break = true;
						// PSEUDO CLASSES
						} else if ( $s[0] == ':') {
							// skip
						// TAG
						} else if (trim($s)) {
							if ($s != '*') {
								// TODO namespaces
								if (isset($node->tagName)) {
									if ($node->tagName != $s)
										$break = true;
								} else if ($s == 'html' && ! $this->isRoot($node))
									$break = true;
							}
						// AVOID NON-SIMPLE SELECTORS
						} else if (in_array($s, $notSimpleSelector)) {
							$break = true;
							$this->debug(array('Skipping non simple selector', $selector));
						}
					}
					if ($break)
						break;
				}
				// if element passed all chunks of selector - add it to new stack
				if (! $break )
					$stack[] = $node;
			}
			$tmpStack = $this->elements;
			$this->elements = $stack;
			// PER ALL NODES selector chunks
			foreach($selector as $s)
				// PSEUDO CLASSES
				if ($s[0] == ':')
					$this->pseudoClasses($s);
			foreach($this->elements as $node)
				// XXX it should be merged without duplicates
				// but jQuery doesnt do that
				$finalStack[] = $node;
			$this->elements = $tmpStack;
		}
		$this->elements = $finalStack;
		if ($_skipHistory) {
			return $this;
		} else {
			$this->debug("Stack length after filter(): ".count($finalStack));
			return $this->newInstance();
		}
	}
	/**
	 *
	 * @param $value
	 * @return unknown_type
	 * @TODO implement in all methods using passed parameters
	 */
	protected static function unQuote($value) {
		return $value[0] == '\'' || $value[0] == '"'
			? substr($value, 1, -1)
			: $value;
	}
	/**
	 * Enter description here...
	 *
	 * @link http://docs.jquery.com/Ajax/load
	 * @return phpQuery|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo Support $selector
	 */
	public function load($url, $data = null, $callback = null) {
		if ($data && ! is_array($data)) {
			$callback = $data;
			$data = null;
		}
		if (mb_strpos($url, ' ') !== false) {
			$matches = null;
			if (extension_loaded('mbstring') && phpQuery::$mbstringSupport)
				mb_ereg('^([^ ]+) (.*)$', $url, $matches);
			else
				preg_match('^([^ ]+) (.*)$', $url, $matches);
			$url = $matches[1];
			$selector = $matches[2];
			// FIXME this sucks, pass as callback param
			$this->_loadSelector = $selector;
		}
		$ajax = array(
			'url' => $url,
			'type' => $data ? 'POST' : 'GET',
			'data' => $data,
			'complete' => $callback,
			'success' => array($this, '__loadSuccess')
		);
		phpQuery::ajax($ajax);
		return $this;
	}
	/**
	 * @access private
	 * @param $html
	 * @return unknown_type
	 */
	public function __loadSuccess($html) {
		if ($this->_loadSelector) {
			$html = phpQuery::newDocument($html)->find($this->_loadSelector);
			unset($this->_loadSelector);
		}
		foreach($this->stack(1) as $node) {
			phpQuery::pq($node, $this->getDocumentID())
				->markup($html);
		}
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQuery|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo
	 */
	public function css() {
		// TODO
		return $this;
	}
	/**
	 * @todo
	 *
	 */
	public function show(){
		// TODO
		return $this;
	}
	/**
	 * @todo
	 *
	 */
	public function hide(){
		// TODO
		return $this;
	}
	/**
	 * Trigger a type of event on every matched element.
	 *
	 * @param unknown_type $type
	 * @param unknown_type $data
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO support more than event in $type (space-separated)
	 */
	public function trigger($type, $data = array()) {
		foreach($this->elements as $node)
			phpQueryEvents::trigger($this->getDocumentID(), $type, $data, $node);
		return $this;
	}
	/**
	 * This particular method triggers all bound event handlers on an element (for a specific event type) WITHOUT executing the browsers default actions.
	 *
	 * @param unknown_type $type
	 * @param unknown_type $data
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO
	 */
	public function triggerHandler($type, $data = array()) {
		// TODO;
	}
	/**
	 * Binds a handler to one or more events (like click) for each matched element.
	 * Can also bind custom events.
	 *
	 * @param unknown_type $type
	 * @param unknown_type $data Optional
	 * @param unknown_type $callback
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO support '!' (exclusive) events
	 * @TODO support more than event in $type (space-separated)
	 */
	public function bind($type, $data, $callback = null) {
		// TODO check if $data is callable, not using is_callable
		if (! isset($callback)) {
			$callback = $data;
			$data = null;
		}
		foreach($this->elements as $node)
			phpQueryEvents::add($this->getDocumentID(), $node, $type, $data, $callback);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $type
	 * @param unknown_type $callback
	 * @return unknown
	 * @TODO namespace events
	 * @TODO support more than event in $type (space-separated)
	 */
	public function unbind($type = null, $callback = null) {
		foreach($this->elements as $node)
			phpQueryEvents::remove($this->getDocumentID(), $node, $type, $callback);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function change($callback = null) {
		if ($callback)
			return $this->bind('change', $callback);
		return $this->trigger('change');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function submit($callback = null) {
		if ($callback)
			return $this->bind('submit', $callback);
		return $this->trigger('submit');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function click($callback = null) {
		if ($callback)
			return $this->bind('click', $callback);
		return $this->trigger('click');
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapAllOld($wrapper) {
		$wrapper = pq($wrapper)->_clone();
		if (! $wrapper->length() || ! $this->length() )
			return $this;
		$wrapper->insertBefore($this->elements[0]);
		$deepest = $wrapper->elements[0];
		while($deepest->firstChild && $deepest->firstChild instanceof DOMELEMENT)
			$deepest = $deepest->firstChild;
		pq($deepest)->append($this);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * TODO testme...
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapAll($wrapper) {
		if (! $this->length())
			return $this;
		return phpQuery::pq($wrapper, $this->getDocumentID())
			->clone()
			->insertBefore($this->get(0))
			->map(array($this, '___wrapAllCallback'))
			->append($this);
	}
  /**
   *
	 * @param $node
	 * @return unknown_type
	 * @access private
   */
	public function ___wrapAllCallback($node) {
		$deepest = $node;
		while($deepest->firstChild && $deepest->firstChild instanceof DOMELEMENT)
			$deepest = $deepest->firstChild;
		return $deepest;
	}
	/**
	 * Enter description here...
	 * NON JQUERY METHOD
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapAllPHP($codeBefore, $codeAfter) {
		return $this
			->slice(0, 1)
				->beforePHP($codeBefore)
			->end()
			->slice(-1)
				->afterPHP($codeAfter)
			->end();
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrap($wrapper) {
		foreach($this->stack() as $node)
			phpQuery::pq($node, $this->getDocumentID())->wrapAll($wrapper);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapPHP($codeBefore, $codeAfter) {
		foreach($this->stack() as $node)
			phpQuery::pq($node, $this->getDocumentID())->wrapAllPHP($codeBefore, $codeAfter);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapInner($wrapper) {
		foreach($this->stack() as $node)
			phpQuery::pq($node, $this->getDocumentID())->contents()->wrapAll($wrapper);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function wrapInnerPHP($codeBefore, $codeAfter) {
		foreach($this->stack(1) as $node)
			phpQuery::pq($node, $this->getDocumentID())->contents()
				->wrapAllPHP($codeBefore, $codeAfter);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @testme Support for text nodes
	 */
	public function contents() {
		$stack = array();
		foreach($this->stack(1) as $el) {
			// FIXME (fixed) http://code.google.com/p/phpquery/issues/detail?id=56
//			if (! isset($el->childNodes))
//				continue;
			foreach($el->childNodes as $node) {
				$stack[] = $node;
			}
		}
		return $this->newInstance($stack);
	}
	/**
	 * Enter description here...
	 *
	 * jQuery difference.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function contentsUnwrap() {
		foreach($this->stack(1) as $node) {
			if (! $node->parentNode )
				continue;
			$childNodes = array();
			// any modification in DOM tree breaks childNodes iteration, so cache them first
			foreach($node->childNodes as $chNode )
				$childNodes[] = $chNode;
			foreach($childNodes as $chNode )
//				$node->parentNode->appendChild($chNode);
				$node->parentNode->insertBefore($chNode, $node);
			$node->parentNode->removeChild($node);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * jQuery difference.
	 */
	public function switchWith($markup) {
		$markup = pq($markup, $this->getDocumentID());
		$content = null;
		foreach($this->stack(1) as $node) {
			pq($node)
				->contents()->toReference($content)->end()
				->replaceWith($markup->clone()->append($content));
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function eq($num) {
		$oldStack = $this->elements;
		$this->elementsBackup = $this->elements;
		$this->elements = array();
		if ( isset($oldStack[$num]) )
			$this->elements[] = $oldStack[$num];
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function size() {
		return count($this->elements);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @deprecated Use length as attribute
	 */
	public function length() {
		return $this->size();
	}
	public function count() {
		return $this->size();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo $level
	 */
	public function end($level = 1) {
//		$this->elements = array_pop( $this->history );
//		return $this;
//		$this->previous->DOM = $this->DOM;
//		$this->previous->XPath = $this->XPath;
		return $this->previous
			? $this->previous
			: $this;
	}
	/**
	 * Enter description here...
	 * Normal use ->clone() .
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _clone() {
		$newStack = array();
		//pr(array('copy... ', $this->whois()));
		//$this->dumpHistory('copy');
		$this->elementsBackup = $this->elements;
		foreach($this->elements as $node) {
			$newStack[] = $node->cloneNode(true);
		}
		$this->elements = $newStack;
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function replaceWithPHP($code) {
		return $this->replaceWith(phpQuery::php($code));
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery $content
	 * @link http://docs.jquery.com/Manipulation/replaceWith#content
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function replaceWith($content) {
		return $this->after($content)->remove();
	}
	/**
	 * Enter description here...
	 *
	 * @param String $selector
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo this works ?
	 */
	public function replaceAll($selector) {
		foreach(phpQuery::pq($selector, $this->getDocumentID()) as $node)
			phpQuery::pq($node, $this->getDocumentID())
				->after($this->_clone())
				->remove();
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function remove($selector = null) {
		$loop = $selector
			? $this->filter($selector)->elements
			: $this->elements;
		foreach($loop as $node) {
			if (! $node->parentNode )
				continue;
			if (isset($node->tagName))
				$this->debug("Removing '{$node->tagName}'");
			$node->parentNode->removeChild($node);
			// Mutation event
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'DOMNodeRemoved'
			));
			phpQueryEvents::trigger($this->getDocumentID(),
				$event->type, array($event), $node
			);
		}
		return $this;
	}
	protected function markupEvents($newMarkup, $oldMarkup, $node) {
		if ($node->tagName == 'textarea' && $newMarkup != $oldMarkup) {
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'change'
			));
			phpQueryEvents::trigger($this->getDocumentID(),
				$event->type, array($event), $node
			);
		}
	}
	/**
	 * jQuey difference
	 *
	 * @param $markup
	 * @return unknown_type
	 * @TODO trigger change event for textarea
	 */
	public function markup($markup = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		if ($this->documentWrapper->isXML)
			return call_user_func_array(array($this, 'xml'), $args);
		else
			return call_user_func_array(array($this, 'html'), $args);
	}
	/**
	 * jQuey difference
	 *
	 * @param $markup
	 * @return unknown_type
	 */
	public function markupOuter($callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		if ($this->documentWrapper->isXML)
			return call_user_func_array(array($this, 'xmlOuter'), $args);
		else
			return call_user_func_array(array($this, 'htmlOuter'), $args);
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $html
	 * @return string|phpQuery|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO force html result
	 */
	public function html($html = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if (isset($html)) {
			// INSERT
			$nodes = $this->documentWrapper->import($html);
			$this->empty();
			foreach($this->stack(1) as $alreadyAdded => $node) {
				// for now, limit events for textarea
				if (($this->isXHTML() || $this->isHTML()) && $node->tagName == 'textarea')
					$oldHtml = pq($node, $this->getDocumentID())->markup();
				foreach($nodes as $newNode) {
					$node->appendChild($alreadyAdded
						? $newNode->cloneNode(true)
						: $newNode
					);
				}
				// for now, limit events for textarea
				if (($this->isXHTML() || $this->isHTML()) && $node->tagName == 'textarea')
					$this->markupEvents($html, $oldHtml, $node);
			}
			return $this;
		} else {
			// FETCH
			$return = $this->documentWrapper->markup($this->elements, true);
			$args = func_get_args();
			foreach(array_slice($args, 1) as $callback) {
				$return = phpQuery::callbackRun($callback, array($return));
			}
			return $return;
		}
	}
	/**
	 * @TODO force xml result
	 */
	public function xml($xml = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		return call_user_func_array(array($this, 'html'), $args);
	}
	/**
	 * Enter description here...
	 * @TODO force html result
	 *
	 * @return String
	 */
	public function htmlOuter($callback1 = null, $callback2 = null, $callback3 = null) {
		$markup = $this->documentWrapper->markup($this->elements);
		// pass thou callbacks
		$args = func_get_args();
		foreach($args as $callback) {
			$markup = phpQuery::callbackRun($callback, array($markup));
		}
		return $markup;
	}
	/**
	 * @TODO force xml result
	 */
	public function xmlOuter($callback1 = null, $callback2 = null, $callback3 = null) {
		$args = func_get_args();
		return call_user_func_array(array($this, 'htmlOuter'), $args);
	}
	public function __toString() {
		return $this->markupOuter();
	}
	/**
	 * Just like html(), but returns markup with VALID (dangerous) PHP tags.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo support returning markup with PHP tags when called without param
	 */
	public function php($code = null) {
		return $this->markupPHP($code);
	}
	/**
	 * Enter description here...
	 * 
	 * @param $code
	 * @return unknown_type
	 */
	public function markupPHP($code = null) {
		return isset($code)
			? $this->markup(phpQuery::php($code))
			: phpQuery::markupToPHP($this->markup());
	}
	/**
	 * Enter description here...
	 * 
	 * @param $code
	 * @return unknown_type
	 */
	public function markupOuterPHP() {
		return phpQuery::markupToPHP($this->markupOuter());
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function children($selector = null) {
		$stack = array();
		foreach($this->stack(1) as $node) {
//			foreach($node->getElementsByTagName('*') as $newNode) {
			foreach($node->childNodes as $newNode) {
				if ($newNode->nodeType != 1)
					continue;
				if ($selector && ! $this->is($selector, $newNode))
					continue;
				if ($this->elementsContainsNode($newNode, $stack))
					continue;
				$stack[] = $newNode;
			}
		}
		$this->elementsBackup = $this->elements;
		$this->elements = $stack;
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function ancestors($selector = null) {
		return $this->children( $selector );
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function append( $content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function appendPHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'append');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function appendTo( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prepend( $content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @todo accept many arguments, which are joined, arrays maybe also
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prependPHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'prepend');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prependTo( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function before($content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function beforePHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'before');
	}
	/**
	 * Enter description here...
	 *
	 * @param String|phpQuery
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function insertBefore( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function after( $content) {
		return $this->insert($content, __FUNCTION__);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function afterPHP( $content) {
		return $this->insert("<php><!-- {$content} --></php>", 'after');
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function insertAfter( $seletor) {
		return $this->insert($seletor, __FUNCTION__);
	}
	/**
	 * Internal insert method. Don't use it.
	 *
	 * @param unknown_type $target
	 * @param unknown_type $type
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function insert($target, $type) {
		$this->debug("Inserting data with '{$type}'");
		$to = false;
		switch( $type) {
			case 'appendTo':
			case 'prependTo':
			case 'insertBefore':
			case 'insertAfter':
				$to = true;
		}
		switch(gettype($target)) {
			case 'string':
				$insertFrom = $insertTo = array();
				if ($to) {
					// INSERT TO
					$insertFrom = $this->elements;
					if (phpQuery::isMarkup($target)) {
						// $target is new markup, import it
						$insertTo = $this->documentWrapper->import($target);
					// insert into selected element
					} else {
						// $tagret is a selector
						$thisStack = $this->elements;
						$this->toRoot();
						$insertTo = $this->find($target)->elements;
						$this->elements = $thisStack;
					}
				} else {
					// INSERT FROM
					$insertTo = $this->elements;
					$insertFrom = $this->documentWrapper->import($target);
				}
				break;
			case 'object':
				$insertFrom = $insertTo = array();
				// phpQuery
				if ($target instanceof self) {
					if ($to) {
						$insertTo = $target->elements;
						if ($this->documentFragment && $this->stackIsRoot())
							// get all body children
//							$loop = $this->find('body > *')->elements;
							// TODO test it, test it hard...
//							$loop = $this->newInstance($this->root)->find('> *')->elements;
							$loop = $this->root->childNodes;
						else
							$loop = $this->elements;
						// import nodes if needed
						$insertFrom = $this->getDocumentID() == $target->getDocumentID()
							? $loop
							: $target->documentWrapper->import($loop);
					} else {
						$insertTo = $this->elements;
						if ( $target->documentFragment && $target->stackIsRoot() )
							// get all body children
//							$loop = $target->find('body > *')->elements;
							$loop = $target->root->childNodes;
						else
							$loop = $target->elements;
						// import nodes if needed
						$insertFrom = $this->getDocumentID() == $target->getDocumentID()
							? $loop
							: $this->documentWrapper->import($loop);
					}
				// DOMNODE
				} elseif ($target instanceof DOMNODE) {
					// import node if needed
//					if ( $target->ownerDocument != $this->DOM )
//						$target = $this->DOM->importNode($target, true);
					if ( $to) {
						$insertTo = array($target);
						if ($this->documentFragment && $this->stackIsRoot())
							// get all body children
							$loop = $this->root->childNodes;
//							$loop = $this->find('body > *')->elements;
						else
							$loop = $this->elements;
						foreach($loop as $fromNode)
							// import nodes if needed
							$insertFrom[] = ! $fromNode->ownerDocument->isSameNode($target->ownerDocument)
								? $target->ownerDocument->importNode($fromNode, true)
								: $fromNode;
					} else {
						// import node if needed
						if (! $target->ownerDocument->isSameNode($this->document))
							$target = $this->document->importNode($target, true);
						$insertTo = $this->elements;
						$insertFrom[] = $target;
					}
				}
				break;
		}
		phpQuery::debug("From ".count($insertFrom)."; To ".count($insertTo)." nodes");
		foreach($insertTo as $insertNumber => $toNode) {
			// we need static relative elements in some cases
			switch( $type) {
				case 'prependTo':
				case 'prepend':
					$firstChild = $toNode->firstChild;
					break;
				case 'insertAfter':
				case 'after':
					$nextSibling = $toNode->nextSibling;
					break;
			}
			foreach($insertFrom as $fromNode) {
				// clone if inserted already before
				$insert = $insertNumber
					? $fromNode->cloneNode(true)
					: $fromNode;
				switch($type) {
					case 'appendTo':
					case 'append':
//						$toNode->insertBefore(
//							$fromNode,
//							$toNode->lastChild->nextSibling
//						);
						$toNode->appendChild($insert);
						$eventTarget = $insert;
						break;
					case 'prependTo':
					case 'prepend':
						$toNode->insertBefore(
							$insert,
							$firstChild
						);
						break;
					case 'insertBefore':
					case 'before':
						if (! $toNode->parentNode)
							throw new Exception("No parentNode, can't do {$type}()");
						else
							$toNode->parentNode->insertBefore(
								$insert,
								$toNode
							);
						break;
					case 'insertAfter':
					case 'after':
						if (! $toNode->parentNode)
							throw new Exception("No parentNode, can't do {$type}()");
						else
							$toNode->parentNode->insertBefore(
								$insert,
								$nextSibling
							);
						break;
				}
				// Mutation event
				$event = new DOMEvent(array(
					'target' => $insert,
					'type' => 'DOMNodeInserted'
				));
				phpQueryEvents::trigger($this->getDocumentID(),
					$event->type, array($event), $insert
				);
			}
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return Int
	 */
	public function index($subject) {
		$index = -1;
		$subject = $subject instanceof phpQueryObject
			? $subject->elements[0]
			: $subject;
		foreach($this->newInstance() as $k => $node) {
			if ($node->isSameNode($subject))
				$index = $k;
		}
		return $index;
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $start
	 * @param unknown_type $end
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @testme
	 */
	public function slice($start, $end = null) {
//		$last = count($this->elements)-1;
//		$end = $end
//			? min($end, $last)
//			: $last;
//		if ($start < 0)
//			$start = $last+$start;
//		if ($start > $last)
//			return array();
		if ($end > 0)
			$end = $end-$start;
		return $this->newInstance(
			array_slice($this->elements, $start, $end)
		);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function reverse() {
		$this->elementsBackup = $this->elements;
		$this->elements = array_reverse($this->elements);
		return $this->newInstance();
	}
	/**
	 * Return joined text content.
	 * @return String
	 */
	public function text($text = null, $callback1 = null, $callback2 = null, $callback3 = null) {
		if (isset($text))
			return $this->html(htmlspecialchars($text));
		$args = func_get_args();
		$args = array_slice($args, 1);
		$return = '';
		foreach($this->elements as $node) {
			$text = $node->textContent;
			if (count($this->elements) > 1 && $text)
				$text .= "\n";
			foreach($args as $callback) {
				$text = phpQuery::callbackRun($callback, array($text));
			}
			$return .= $text;
		}
		return $return;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function plugin($class, $file = null) {
		phpQuery::plugin($class, $file);
		return $this;
	}
	/**
	 * Deprecated, use $pq->plugin() instead.
	 *
	 * @deprecated
	 * @param $class
	 * @param $file
	 * @return unknown_type
	 */
	public static function extend($class, $file = null) {
		return $this->plugin($class, $file);
	}
	/**
	 *
	 * @access private
	 * @param $method
	 * @param $args
	 * @return unknown_type
	 */
	public function __call($method, $args) {
		$aliasMethods = array('clone', 'empty');
		if (isset(phpQuery::$extendMethods[$method])) {
			array_unshift($args, $this);
			return phpQuery::callbackRun(
				phpQuery::$extendMethods[$method], $args
			);
		} else if (isset(phpQuery::$pluginsMethods[$method])) {
			array_unshift($args, $this);
			$class = phpQuery::$pluginsMethods[$method];
			$realClass = "phpQueryObjectPlugin_$class";
			$return = call_user_func_array(
				array($realClass, $method),
				$args
			);
			// XXX deprecate ?
			return is_null($return)
				? $this
				: $return;
		} else if (in_array($method, $aliasMethods)) {
			return call_user_func_array(array($this, '_'.$method), $args);
		} else
			throw new Exception("Method '{$method}' doesnt exist");
	}
	/**
	 * Safe rename of next().
	 *
	 * Use it ONLY when need to call next() on an iterated object (in same time).
	 * Normaly there is no need to do such thing ;)
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _next($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('nextSibling', $selector, true)
		);
	}
	/**
	 * Use prev() and next().
	 *
	 * @deprecated
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _prev($selector = null) {
		return $this->prev($selector);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function prev($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('previousSibling', $selector, true)
		);
	}
	/**
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo
	 */
	public function prevAll($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('previousSibling', $selector)
		);
	}
	/**
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo FIXME: returns source elements insted of next siblings
	 */
	public function nextAll($selector = null) {
		return $this->newInstance(
			$this->getElementSiblings('nextSibling', $selector)
		);
	}
	/**
	 * @access private
	 */
	protected function getElementSiblings($direction, $selector = null, $limitToOne = false) {
		$stack = array();
		$count = 0;
		foreach($this->stack() as $node) {
			$test = $node;
			while( isset($test->{$direction}) && $test->{$direction}) {
				$test = $test->{$direction};
				if (! $test instanceof DOMELEMENT)
					continue;
				$stack[] = $test;
				if ($limitToOne)
					break;
			}
		}
		if ($selector) {
			$stackOld = $this->elements;
			$this->elements = $stack;
			$stack = $this->filter($selector, true)->stack();
			$this->elements = $stackOld;
		}
		return $stack;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function siblings($selector = null) {
		$stack = array();
		$siblings = array_merge(
			$this->getElementSiblings('previousSibling', $selector),
			$this->getElementSiblings('nextSibling', $selector)
		);
		foreach($siblings as $node) {
			if (! $this->elementsContainsNode($node, $stack))
				$stack[] = $node;
		}
		return $this->newInstance($stack);
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function not($selector = null) {
		if (is_string($selector))
			phpQuery::debug(array('not', $selector));
		else
			phpQuery::debug('not');
		$stack = array();
		if ($selector instanceof self || $selector instanceof DOMNODE) {
			foreach($this->stack() as $node) {
				if ($selector instanceof self) {
					$matchFound = false;
					foreach($selector->stack() as $notNode) {
						if ($notNode->isSameNode($node))
							$matchFound = true;
					}
					if (! $matchFound)
						$stack[] = $node;
				} else if ($selector instanceof DOMNODE) {
					if (! $selector->isSameNode($node))
						$stack[] = $node;
				} else {
					if (! $this->is($selector))
						$stack[] = $node;
				}
			}
		} else {
			$orgStack = $this->stack();
			$matched = $this->filter($selector, true)->stack();
//			$matched = array();
//			// simulate OR in filter() instead of AND 5y
//			foreach($this->parseSelector($selector) as $s) {
//				$matched = array_merge($matched,
//					$this->filter(array($s))->stack()
//				);
//			}
			foreach($orgStack as $node)
				if (! $this->elementsContainsNode($node, $matched))
					$stack[] = $node;
		}
		return $this->newInstance($stack);
	}
	/**
	 * Enter description here...
	 *
	 * @param string|phpQueryObject
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function add($selector = null) {
		if (! $selector)
			return $this;
		$stack = array();
		$this->elementsBackup = $this->elements;
		$found = phpQuery::pq($selector, $this->getDocumentID());
		$this->merge($found->elements);
		return $this->newInstance();
	}
	/**
	 * @access private
	 */
	protected function merge() {
		foreach(func_get_args() as $nodes)
			foreach($nodes as $newNode )
				if (! $this->elementsContainsNode($newNode) )
					$this->elements[] = $newNode;
	}
	/**
	 * @access private
	 * TODO refactor to stackContainsNode
	 */
	protected function elementsContainsNode($nodeToCheck, $elementsStack = null) {
		$loop = ! is_null($elementsStack)
			? $elementsStack
			: $this->elements;
		foreach($loop as $node) {
			if ( $node->isSameNode( $nodeToCheck ) )
				return true;
		}
		return false;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function parent($selector = null) {
		$stack = array();
		foreach($this->elements as $node )
			if ( $node->parentNode && ! $this->elementsContainsNode($node->parentNode, $stack) )
				$stack[] = $node->parentNode;
		$this->elementsBackup = $this->elements;
		$this->elements = $stack;
		if ( $selector )
			$this->filter($selector, true);
		return $this->newInstance();
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function parents($selector = null) {
		$stack = array();
		if (! $this->elements )
			$this->debug('parents() - stack empty');
		foreach($this->elements as $node) {
			$test = $node;
			while( $test->parentNode) {
				$test = $test->parentNode;
				if ($this->isRoot($test))
					break;
				if (! $this->elementsContainsNode($test, $stack)) {
					$stack[] = $test;
					continue;
				}
			}
		}
		$this->elementsBackup = $this->elements;
		$this->elements = $stack;
		if ( $selector )
			$this->filter($selector, true);
		return $this->newInstance();
	}
	/**
	 * Internal stack iterator.
	 *
	 * @access private
	 */
	public function stack($nodeTypes = null) {
		if (!isset($nodeTypes))
			return $this->elements;
		if (!is_array($nodeTypes))
			$nodeTypes = array($nodeTypes);
		$return = array();
		foreach($this->elements as $node) {
			if (in_array($node->nodeType, $nodeTypes))
				$return[] = $node;
		}
		return $return;
	}
	// TODO phpdoc; $oldAttr is result of hasAttribute, before any changes
	protected function attrEvents($attr, $oldAttr, $oldValue, $node) {
		// skip events for XML documents
		if (! $this->isXHTML() && ! $this->isHTML())
			return;
		$event = null;
		// identify
		$isInputValue = $node->tagName == 'input'
			&& (
				in_array($node->getAttribute('type'),
					array('text', 'password', 'hidden'))
				|| !$node->getAttribute('type')
				 );
		$isRadio = $node->tagName == 'input'
			&& $node->getAttribute('type') == 'radio';
		$isCheckbox = $node->tagName == 'input'
			&& $node->getAttribute('type') == 'checkbox';
		$isOption = $node->tagName == 'option';
		if ($isInputValue && $attr == 'value' && $oldValue != $node->getAttribute($attr)) {
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'change'
			));
		} else if (($isRadio || $isCheckbox) && $attr == 'checked' && (
				// check
				(! $oldAttr && $node->hasAttribute($attr))
				// un-check
				|| (! $node->hasAttribute($attr) && $oldAttr)
			)) {
			$event = new DOMEvent(array(
				'target' => $node,
				'type' => 'change'
			));
		} else if ($isOption && $node->parentNode && $attr == 'selected' && (
				// select
				(! $oldAttr && $node->hasAttribute($attr))
				// un-select
				|| (! $node->hasAttribute($attr) && $oldAttr)
			)) {
			$event = new DOMEvent(array(
				'target' => $node->parentNode,
				'type' => 'change'
			));
		}
		if ($event) {
			phpQueryEvents::trigger($this->getDocumentID(),
				$event->type, array($event), $node
			);
		}
	}
	public function attr($attr = null, $value = null) {
		foreach($this->stack(1) as $node) {
			if (! is_null($value)) {
				$loop = $attr == '*'
					? $this->getNodeAttrs($node)
					: array($attr);
				foreach($loop as $a) {
					$oldValue = $node->getAttribute($a);
					$oldAttr = $node->hasAttribute($a);
					// TODO raises an error when charset other than UTF-8
					// while document's charset is also not UTF-8
					@$node->setAttribute($a, $value);
					$this->attrEvents($a, $oldAttr, $oldValue, $node);
				}
			} else if ($attr == '*') {
				// jQuery difference
				$return = array();
				foreach($node->attributes as $n => $v)
					$return[$n] = $v->value;
				return $return;
			} else
				return $node->hasAttribute($attr)
					? $node->getAttribute($attr)
					: null;
		}
		return is_null($value)
			? '' : $this;
	}
	/**
	 * @access private
	 */
	protected function getNodeAttrs($node) {
		$return = array();
		foreach($node->attributes as $n => $o)
			$return[] = $n;
		return $return;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo check CDATA ???
	 */
	public function attrPHP($attr, $code) {
		if (! is_null($code)) {
			$value = '<'.'?php '.$code.' ?'.'>';
			// TODO tempolary solution
			// http://code.google.com/p/phpquery/issues/detail?id=17
//			if (function_exists('mb_detect_encoding') && mb_detect_encoding($value) == 'ASCII')
//				$value	= mb_convert_encoding($value, 'UTF-8', 'HTML-ENTITIES');
		}
		foreach($this->stack(1) as $node) {
			if (! is_null($code)) {
//				$attrNode = $this->DOM->createAttribute($attr);
				$node->setAttribute($attr, $value);
//				$attrNode->value = $value;
//				$node->appendChild($attrNode);
			} else if ( $attr == '*') {
				// jQuery diff
				$return = array();
				foreach($node->attributes as $n => $v)
					$return[$n] = $v->value;
				return $return;
			} else
				return $node->getAttribute($attr);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function removeAttr($attr) {
		foreach($this->stack(1) as $node) {
			$loop = $attr == '*'
				? $this->getNodeAttrs($node)
				: array($attr);
			foreach($loop as $a) {
				$oldValue = $node->getAttribute($a);
				$node->removeAttribute($a);
				$this->attrEvents($a, $oldValue, null, $node);
			}
		}
		return $this;
	}
	/**
	 * Return form element value.
	 *
	 * @return String Fields value.
	 */
	public function val($val = null) {
		if (! isset($val)) {
			if ($this->eq(0)->is('select')) {
					$selected = $this->eq(0)->find('option[selected=selected]');
					if ($selected->is('[value]'))
						return $selected->attr('value');
					else
						return $selected->text();
			} else if ($this->eq(0)->is('textarea'))
					return $this->eq(0)->markup();
				else
					return $this->eq(0)->attr('value');
		} else {
			$_val = null;
			foreach($this->stack(1) as $node) {
				$node = pq($node, $this->getDocumentID());
				if (is_array($val) && in_array($node->attr('type'), array('checkbox', 'radio'))) {
					$isChecked = in_array($node->attr('value'), $val)
							|| in_array($node->attr('name'), $val);
					if ($isChecked)
						$node->attr('checked', 'checked');
					else
						$node->removeAttr('checked');
				} else if ($node->get(0)->tagName == 'select') {
					if (! isset($_val)) {
						$_val = array();
						if (! is_array($val))
							$_val = array((string)$val);
						else
							foreach($val as $v)
								$_val[] = $v;
					}
					foreach($node['option']->stack(1) as $option) {
						$option = pq($option, $this->getDocumentID());
						$selected = false;
						// XXX: workaround for string comparsion, see issue #96
						// http://code.google.com/p/phpquery/issues/detail?id=96
						$selected = is_null($option->attr('value'))
							? in_array($option->markup(), $_val)
							: in_array($option->attr('value'), $_val);
//						$optionValue = $option->attr('value');
//						$optionText = $option->text();
//						$optionTextLenght = mb_strlen($optionText);
//						foreach($_val as $v)
//							if ($optionValue == $v)
//								$selected = true;
//							else if ($optionText == $v && $optionTextLenght == mb_strlen($v))
//								$selected = true;
						if ($selected)
							$option->attr('selected', 'selected');
						else
							$option->removeAttr('selected');
					}
				} else if ($node->get(0)->tagName == 'textarea')
					$node->markup($val);
				else
					$node->attr('value', $val);
			}
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function andSelf() {
		if ( $this->previous )
			$this->elements = array_merge($this->elements, $this->previous->elements);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function addClass( $className) {
		if (! $className)
			return $this;
		foreach($this->stack(1) as $node) {
			if (! $this->is(".$className", $node))
				$node->setAttribute(
					'class',
					trim($node->getAttribute('class').' '.$className)
				);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function addClassPHP( $className) {
		foreach($this->stack(1) as $node) {
				$classes = $node->getAttribute('class');
				$newValue = $classes
					? $classes.' <'.'?php '.$className.' ?'.'>'
					: '<'.'?php '.$className.' ?'.'>';
				$node->setAttribute('class', $newValue);
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param	string	$className
	 * @return	bool
	 */
	public function hasClass($className) {
		foreach($this->stack(1) as $node) {
			if ( $this->is(".$className", $node))
				return true;
		}
		return false;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function removeClass($className) {
		foreach($this->stack(1) as $node) {
			$classes = explode( ' ', $node->getAttribute('class'));
			if ( in_array($className, $classes)) {
				$classes = array_diff($classes, array($className));
				if ( $classes )
					$node->setAttribute('class', implode(' ', $classes));
				else
					$node->removeAttribute('class');
			}
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function toggleClass($className) {
		foreach($this->stack(1) as $node) {
			if ( $this->is( $node, '.'.$className ))
				$this->removeClass($className);
			else
				$this->addClass($className);
		}
		return $this;
	}
	/**
	 * Proper name without underscore (just ->empty()) also works.
	 *
	 * Removes all child nodes from the set of matched elements.
	 *
	 * Example:
	 * pq("p")._empty()
	 *
	 * HTML:
	 * <p>Hello, <span>Person</span> <a href="#">and person</a></p>
	 *
	 * Result:
	 * [ <p></p> ]
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @access private
	 */
	public function _empty() {
		foreach($this->stack(1) as $node) {
			// thx to 'dave at dgx dot cz'
			$node->nodeValue = '';
		}
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @param array|string $callback Expects $node as first param, $index as second
	 * @param array $scope External variables passed to callback. Use compact('varName1', 'varName2'...) and extract($scope)
	 * @param array $arg1 Will ba passed as third and futher args to callback.
	 * @param array $arg2 Will ba passed as fourth and futher args to callback, and so on...
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function each($callback, $param1 = null, $param2 = null, $param3 = null) {
		$paramStructure = null;
		if (func_num_args() > 1) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 1);
		}
		foreach($this->elements as $v)
			phpQuery::callbackRun($callback, array($v), $paramStructure);
		return $this;
	}
	/**
	 * Run callback on actual object.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function callback($callback, $param1 = null, $param2 = null, $param3 = null) {
		$params = func_get_args();
		$params[0] = $this;
		phpQuery::callbackRun($callback, $params);
		return $this;
	}
	/**
	 * Enter description here...
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @todo add $scope and $args as in each() ???
	 */
	public function map($callback, $param1 = null, $param2 = null, $param3 = null) {
//		$stack = array();
////		foreach($this->newInstance() as $node) {
//		foreach($this->newInstance() as $node) {
//			$result = call_user_func($callback, $node);
//			if ($result)
//				$stack[] = $result;
//		}
		$params = func_get_args();
		array_unshift($params, $this->elements);
		return $this->newInstance(
			call_user_func_array(array('phpQuery', 'map'), $params)
//			phpQuery::map($this->elements, $callback)
		);
	}
	/**
	 * Enter description here...
	 * 
	 * @param <type> $key
	 * @param <type> $value
	 */
	public function data($key, $value = null) {
		if (! isset($value)) {
			// TODO? implement specific jQuery behavior od returning parent values
			// is child which we look up doesn't exist
			return phpQuery::data($this->get(0), $key, $value, $this->getDocumentID());
		} else {
			foreach($this as $node)
				phpQuery::data($node, $key, $value, $this->getDocumentID());
			return $this;
		}
	}
	/**
	 * Enter description here...
	 * 
	 * @param <type> $key
	 */
	public function removeData($key) {
		foreach($this as $node)
			phpQuery::removeData($node, $key, $this->getDocumentID());
		return $this;
	}
	// INTERFACE IMPLEMENTATIONS

	// ITERATOR INTERFACE
	/**
   * @access private
	 */
	public function rewind(){
		$this->debug('iterating foreach');
//		phpQuery::selectDocument($this->getDocumentID());
		$this->elementsBackup = $this->elements;
		$this->elementsInterator = $this->elements;
		$this->valid = isset( $this->elements[0] )
			? 1 : 0;
// 		$this->elements = $this->valid
// 			? array($this->elements[0])
// 			: array();
		$this->current = 0;
	}
	/**
   * @access private
	 */
	public function current(){
		return $this->elementsInterator[ $this->current ];
	}
	/**
   * @access private
	 */
	public function key(){
		return $this->current;
	}
	/**
	 * Double-function method.
	 *
	 * First: main iterator interface method.
	 * Second: Returning next sibling, alias for _next().
	 *
	 * Proper functionality is choosed automagicaly.
	 *
	 * @see phpQueryObject::_next()
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public function next($cssSelector = null){
//		if ($cssSelector || $this->valid)
//			return $this->_next($cssSelector);
		$this->valid = isset( $this->elementsInterator[ $this->current+1 ] )
			? true
			: false;
		if (! $this->valid && $this->elementsInterator) {
			$this->elementsInterator = null;
		} else if ($this->valid) {
			$this->current++;
		} else {
			return $this->_next($cssSelector);
		}
	}
	/**
   * @access private
	 */
	public function valid(){
		return $this->valid;
	}
	// ITERATOR INTERFACE END
	// ARRAYACCESS INTERFACE
	/**
   * @access private
	 */
	public function offsetExists($offset) {
		return $this->find($offset)->size() > 0;
	}
	/**
   * @access private
	 */
	public function offsetGet($offset) {
		return $this->find($offset);
	}
	/**
   * @access private
	 */
	public function offsetSet($offset, $value) {
//		$this->find($offset)->replaceWith($value);
		$this->find($offset)->html($value);
	}
	/**
   * @access private
	 */
	public function offsetUnset($offset) {
		// empty
		throw new Exception("Can't do unset, use array interface only for calling queries and replacing HTML.");
	}
	// ARRAYACCESS INTERFACE END
	/**
	 * Returns node's XPath.
	 *
	 * @param unknown_type $oneNode
	 * @return string
	 * @TODO use native getNodePath is avaible
	 * @access private
	 */
	protected function getNodeXpath($oneNode = null, $namespace = null) {
		$return = array();
		$loop = $oneNode
			? array($oneNode)
			: $this->elements;
//		if ($namespace)
//			$namespace .= ':';
		foreach($loop as $node) {
			if ($node instanceof DOMDOCUMENT) {
				$return[] = '';
				continue;
			}
			$xpath = array();
			while(! ($node instanceof DOMDOCUMENT)) {
				$i = 1;
				$sibling = $node;
				while($sibling->previousSibling) {
					$sibling = $sibling->previousSibling;
					$isElement = $sibling instanceof DOMELEMENT;
					if ($isElement && $sibling->tagName == $node->tagName)
						$i++;
				}
				$xpath[] = $this->isXML()
					? "*[local-name()='{$node->tagName}'][{$i}]"
					: "{$node->tagName}[{$i}]";
				$node = $node->parentNode;
			}
			$xpath = join('/', array_reverse($xpath));
			$return[] = '/'.$xpath;
		}
		return $oneNode
			? $return[0]
			: $return;
	}
	// HELPERS
	public function whois($oneNode = null) {
		$return = array();
		$loop = $oneNode
			? array( $oneNode )
			: $this->elements;
		foreach($loop as $node) {
			if (isset($node->tagName)) {
				$tag = in_array($node->tagName, array('php', 'js'))
					? strtoupper($node->tagName)
					: $node->tagName;
				$return[] = $tag
					.($node->getAttribute('id')
						? '#'.$node->getAttribute('id'):'')
					.($node->getAttribute('class')
						? '.'.join('.', split(' ', $node->getAttribute('class'))):'')
					.($node->getAttribute('name')
						? '[name="'.$node->getAttribute('name').'"]':'')
					.($node->getAttribute('value') && strpos($node->getAttribute('value'), '<'.'?php') === false
						? '[value="'.substr(str_replace("\n", '', $node->getAttribute('value')), 0, 15).'"]':'')
					.($node->getAttribute('value') && strpos($node->getAttribute('value'), '<'.'?php') !== false
						? '[value=PHP]':'')
					.($node->getAttribute('selected')
						? '[selected]':'')
					.($node->getAttribute('checked')
						? '[checked]':'')
				;
			} else if ($node instanceof DOMTEXT) {
				if (trim($node->textContent))
					$return[] = 'Text:'.substr(str_replace("\n", ' ', $node->textContent), 0, 15);
			} else {

			}
		}
		return $oneNode && isset($return[0])
			? $return[0]
			: $return;
	}
	/**
	 * Dump htmlOuter and preserve chain. Usefull for debugging.
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 *
	 */
	public function dump() {
		print 'DUMP #'.(phpQuery::$dumpCount++).' ';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
//		print __FILE__.':'.__LINE__."\n";
		var_dump($this->htmlOuter());
		return $this;
	}
	public function dumpWhois() {
		print 'DUMP #'.(phpQuery::$dumpCount++).' ';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
//		print __FILE__.':'.__LINE__."\n";
		var_dump('whois', $this->whois());
		phpQuery::$debug = $debug;
		return $this;
	}
	public function dumpLength() {
		print 'DUMP #'.(phpQuery::$dumpCount++).' ';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
//		print __FILE__.':'.__LINE__."\n";
		var_dump('length', $this->length());
		phpQuery::$debug = $debug;
		return $this;
	}
	public function dumpTree($html = true, $title = true) {
		$output = $title
			? 'DUMP #'.(phpQuery::$dumpCount++)." \n" : '';
		$debug = phpQuery::$debug;
		phpQuery::$debug = false;
		foreach($this->stack() as $node)
			$output .= $this->__dumpTree($node);
		phpQuery::$debug = $debug;
		print $html
			? nl2br(str_replace(' ', '&nbsp;', $output))
			: $output;
		return $this;
	}
	private function __dumpTree($node, $intend = 0) {
		$whois = $this->whois($node);
		$return = '';
		if ($whois)
			$return .= str_repeat(' - ', $intend).$whois."\n";
		if (isset($node->childNodes))
			foreach($node->childNodes as $chNode)
				$return .= $this->__dumpTree($chNode, $intend+1);
		return $return;
	}
	/**
	 * Dump htmlOuter and stop script execution. Usefull for debugging.
	 *
	 */
	public function dumpDie() {
		print __FILE__.':'.__LINE__;
		var_dump($this->htmlOuter());
		die();
	}
}


// -- Multibyte Compatibility functions ---------------------------------------
// http://svn.iphonewebdev.com/lace/lib/mb_compat.php

/**
 *  mb_internal_encoding()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_internal_encoding'))
{
	function mb_internal_encoding($enc) {return true; }
}

/**
 *  mb_regex_encoding()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_regex_encoding'))
{
	function mb_regex_encoding($enc) {return true; }
}

/**
 *  mb_strlen()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_strlen'))
{
	function mb_strlen($str)
	{
		return strlen($str);
	}
}

/**
 *  mb_strpos()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_strpos'))
{
	function mb_strpos($haystack, $needle, $offset=0)
	{
		return strpos($haystack, $needle, $offset);
	}
}
/**
 *  mb_stripos()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_stripos'))
{
	function mb_stripos($haystack, $needle, $offset=0)
	{
		return stripos($haystack, $needle, $offset);
	}
}

/**
 *  mb_substr()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_substr'))
{
	function mb_substr($str, $start, $length=0)
	{
		return substr($str, $start, $length);
	}
}

/**
 *  mb_substr_count()
 *
 *  Included for mbstring pseudo-compatability.
 */
if (!function_exists('mb_substr_count'))
{
	function mb_substr_count($haystack, $needle)
	{
		return substr_count($haystack, $needle);
	}
}


/**
 * Static namespace for phpQuery functions.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 */
abstract class phpQuery {
	/**
	 * XXX: Workaround for mbstring problems 
	 * 
	 * @var bool
	 */
	public static $mbstringSupport = true;
	public static $debug = false;
	public static $documents = array();
	public static $defaultDocumentID = null;
//	public static $defaultDoctype = 'html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"';
	/**
	 * Applies only to HTML.
	 *
	 * @var unknown_type
	 */
	public static $defaultDoctype = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">';
	public static $defaultCharset = 'UTF-8';
	/**
	 * Static namespace for plugins.
	 *
	 * @var object
	 */
	public static $plugins = array();
	/**
	 * List of loaded plugins.
	 *
	 * @var unknown_type
	 */
	public static $pluginsLoaded = array();
	public static $pluginsMethods = array();
	public static $pluginsStaticMethods = array();
	public static $extendMethods = array();
	/**
	 * @TODO implement
	 */
	public static $extendStaticMethods = array();
	/**
	 * Hosts allowed for AJAX connections.
	 * Dot '.' means $_SERVER['HTTP_HOST'] (if any).
	 *
	 * @var array
	 */
	public static $ajaxAllowedHosts = array(
		'.'
	);
	/**
	 * AJAX settings.
	 *
	 * @var array
	 * XXX should it be static or not ?
	 */
	public static $ajaxSettings = array(
		'url' => '',//TODO
		'global' => true,
		'type' => "GET",
		'timeout' => null,
		'contentType' => "application/x-www-form-urlencoded",
		'processData' => true,
//		'async' => true,
		'data' => null,
		'username' => null,
		'password' => null,
		'accepts' => array(
			'xml' => "application/xml, text/xml",
			'html' => "text/html",
			'script' => "text/javascript, application/javascript",
			'json' => "application/json, text/javascript",
			'text' => "text/plain",
			'_default' => "*/*"
		)
	);
	public static $lastModified = null;
	public static $active = 0;
	public static $dumpCount = 0;
	/**
	 * Multi-purpose function.
	 * Use pq() as shortcut.
	 *
	 * In below examples, $pq is any result of pq(); function.
	 *
	 * 1. Import markup into existing document (without any attaching):
	 * - Import into selected document:
	 *   pq('<div/>')				// DOESNT accept text nodes at beginning of input string !
	 * - Import into document with ID from $pq->getDocumentID():
	 *   pq('<div/>', $pq->getDocumentID())
	 * - Import into same document as DOMNode belongs to:
	 *   pq('<div/>', DOMNode)
	 * - Import into document from phpQuery object:
	 *   pq('<div/>', $pq)
	 *
	 * 2. Run query:
	 * - Run query on last selected document:
	 *   pq('div.myClass')
	 * - Run query on document with ID from $pq->getDocumentID():
	 *   pq('div.myClass', $pq->getDocumentID())
	 * - Run query on same document as DOMNode belongs to and use node(s)as root for query:
	 *   pq('div.myClass', DOMNode)
	 * - Run query on document from phpQuery object
	 *   and use object's stack as root node(s) for query:
	 *   pq('div.myClass', $pq)
	 *
	 * @param string|DOMNode|DOMNodeList|array	$arg1	HTML markup, CSS Selector, DOMNode or array of DOMNodes
	 * @param string|phpQueryObject|DOMNode	$context	DOM ID from $pq->getDocumentID(), phpQuery object (determines also query root) or DOMNode (determines also query root)
	 *
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery|QueryTemplatesPhpQuery|false
   * phpQuery object or false in case of error.
	 */
	public static function pq($arg1, $context = null) {
		if ($arg1 instanceof DOMNODE && ! isset($context)) {
			foreach(phpQuery::$documents as $documentWrapper) {
				$compare = $arg1 instanceof DOMDocument
					? $arg1 : $arg1->ownerDocument;
				if ($documentWrapper->document->isSameNode($compare))
					$context = $documentWrapper->id;
			}
		}
		if (! $context) {
			$domId = self::$defaultDocumentID;
			if (! $domId)
				throw new Exception("Can't use last created DOM, because there isn't any. Use phpQuery::newDocument() first.");
//		} else if (is_object($context) && ($context instanceof PHPQUERY || is_subclass_of($context, 'phpQueryObject')))
		} else if (is_object($context) && $context instanceof phpQueryObject)
			$domId = $context->getDocumentID();
		else if ($context instanceof DOMDOCUMENT) {
			$domId = self::getDocumentID($context);
			if (! $domId) {
				//throw new Exception('Orphaned DOMDocument');
				$domId = self::newDocument($context)->getDocumentID();
			}
		} else if ($context instanceof DOMNODE) {
			$domId = self::getDocumentID($context);
			if (! $domId) {
				throw new Exception('Orphaned DOMNode');
//				$domId = self::newDocument($context->ownerDocument);
			}
		} else
			$domId = $context;
		if ($arg1 instanceof phpQueryObject) {
//		if (is_object($arg1) && (get_class($arg1) == 'phpQueryObject' || $arg1 instanceof PHPQUERY || is_subclass_of($arg1, 'phpQueryObject'))) {
			/**
			 * Return $arg1 or import $arg1 stack if document differs:
			 * pq(pq('<div/>'))
			 */
			if ($arg1->getDocumentID() == $domId)
				return $arg1;
			$class = get_class($arg1);
			// support inheritance by passing old object to overloaded constructor
			$phpQuery = $class != 'phpQuery'
				? new $class($arg1, $domId)
				: new phpQueryObject($domId);
			$phpQuery->elements = array();
			foreach($arg1->elements as $node)
				$phpQuery->elements[] = $phpQuery->document->importNode($node, true);
			return $phpQuery;
		} else if ($arg1 instanceof DOMNODE || (is_array($arg1) && isset($arg1[0]) && $arg1[0] instanceof DOMNODE)) {
			/*
			 * Wrap DOM nodes with phpQuery object, import into document when needed:
			 * pq(array($domNode1, $domNode2))
			 */
			$phpQuery = new phpQueryObject($domId);
			if (!($arg1 instanceof DOMNODELIST) && ! is_array($arg1))
				$arg1 = array($arg1);
			$phpQuery->elements = array();
			foreach($arg1 as $node) {
				$sameDocument = $node->ownerDocument instanceof DOMDOCUMENT
					&& ! $node->ownerDocument->isSameNode($phpQuery->document);
				$phpQuery->elements[] = $sameDocument
					? $phpQuery->document->importNode($node, true)
					: $node;
			}
			return $phpQuery;
		} else if (self::isMarkup($arg1)) {
			/**
			 * Import HTML:
			 * pq('<div/>')
			 */
			$phpQuery = new phpQueryObject($domId);
			return $phpQuery->newInstance(
				$phpQuery->documentWrapper->import($arg1)
			);
		} else {
			/**
			 * Run CSS query:
			 * pq('div.myClass')
			 */
			$phpQuery = new phpQueryObject($domId);
//			if ($context && ($context instanceof PHPQUERY || is_subclass_of($context, 'phpQueryObject')))
			if ($context && $context instanceof phpQueryObject)
				$phpQuery->elements = $context->elements;
			else if ($context && $context instanceof DOMNODELIST) {
				$phpQuery->elements = array();
				foreach($context as $node)
					$phpQuery->elements[] = $node;
			} else if ($context && $context instanceof DOMNODE)
				$phpQuery->elements = array($context);
			return $phpQuery->find($arg1);
		}
	}
	/**
	 * Sets default document to $id. Document has to be loaded prior
	 * to using this method.
	 * $id can be retrived via getDocumentID() or getDocumentIDRef().
	 *
	 * @param unknown_type $id
	 */
	public static function selectDocument($id) {
		$id = self::getDocumentID($id);
		self::debug("Selecting document '$id' as default one");
		self::$defaultDocumentID = self::getDocumentID($id);
	}
	/**
	 * Returns document with id $id or last used as phpQueryObject.
	 * $id can be retrived via getDocumentID() or getDocumentIDRef().
	 * Chainable.
	 *
	 * @see phpQuery::selectDocument()
	 * @param unknown_type $id
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function getDocument($id = null) {
		if ($id)
			phpQuery::selectDocument($id);
		else
			$id = phpQuery::$defaultDocumentID;
		return new phpQueryObject($id);
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocument($markup = null, $contentType = null) {
		if (! $markup)
			$markup = '';
		$documentID = phpQuery::createDocumentWrapper($markup, $contentType);
		return new phpQueryObject($documentID);
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentHTML($markup = null, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocument($markup, "text/html{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentXML($markup = null, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocument($markup, "text/xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentXHTML($markup = null, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocument($markup, "application/xhtml+xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentPHP($markup = null, $contentType = "text/html") {
		// TODO pass charset to phpToMarkup if possible (use DOMDocumentWrapper function)
		$markup = phpQuery::phpToMarkup($markup, self::$defaultCharset);
		return self::newDocument($markup, $contentType);
	}
	public static function phpToMarkup($php, $charset = 'utf-8') {
		$regexes = array(
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(\')([^\']*)<'.'?php?(.*?)(?:\\?>)([^\']*)\'@s',
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(")([^"]*)<'.'?php?(.*?)(?:\\?>)([^"]*)"@s',
		);
		foreach($regexes as $regex)
			while (preg_match($regex, $php, $matches)) {
				$php = preg_replace_callback(
					$regex,
//					create_function('$m, $charset = "'.$charset.'"',
//						'return $m[1].$m[2]
//							.htmlspecialchars("<"."?php".$m[4]."?".">", ENT_QUOTES|ENT_NOQUOTES, $charset)
//							.$m[5].$m[2];'
//					),
					array('phpQuery', '_phpToMarkupCallback'),
					$php
				);
			}
		$regex = '@(^|>[^<]*)+?(<\?php(.*?)(\?>))@s';
//preg_match_all($regex, $php, $matches);
//var_dump($matches);
		$php = preg_replace($regex, '\\1<php><!-- \\3 --></php>', $php);
		return $php;
	}
	public static function _phpToMarkupCallback($php, $charset = 'utf-8') {
		return $m[1].$m[2]
			.htmlspecialchars("<"."?php".$m[4]."?".">", ENT_QUOTES|ENT_NOQUOTES, $charset)
			.$m[5].$m[2];
	}
	public static function _markupToPHPCallback($m) {
		return "<"."?php ".htmlspecialchars_decode($m[1])." ?".">";
	}
	/**
	 * Converts document markup containing PHP code generated by phpQuery::php()
	 * into valid (executable) PHP code syntax.
	 *
	 * @param string|phpQueryObject $content
	 * @return string PHP code.
	 */
	public static function markupToPHP($content) {
		if ($content instanceof phpQueryObject)
			$content = $content->markupOuter();
		/* <php>...</php> to <?php...? > */
		$content = preg_replace_callback(
			'@<php>\s*<!--(.*?)-->\s*</php>@s',
//			create_function('$m',
//				'return "<'.'?php ".htmlspecialchars_decode($m[1])." ?'.'>";'
//			),
			array('phpQuery', '_markupToPHPCallback'),
			$content
		);
		/* <node attr='< ?php ? >'> extra space added to save highlighters */
		$regexes = array(
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(\')([^\']*)(?:&lt;|%3C)\\?(?:php)?(.*?)(?:\\?(?:&gt;|%3E))([^\']*)\'@s',
			'@(<(?!\\?)(?:[^>]|\\?>)+\\w+\\s*=\\s*)(")([^"]*)(?:&lt;|%3C)\\?(?:php)?(.*?)(?:\\?(?:&gt;|%3E))([^"]*)"@s',
		);
		foreach($regexes as $regex)
			while (preg_match($regex, $content))
				$content = preg_replace_callback(
					$regex,
					create_function('$m',
						'return $m[1].$m[2].$m[3]."<?php "
							.str_replace(
								array("%20", "%3E", "%09", "&#10;", "&#9;", "%7B", "%24", "%7D", "%22", "%5B", "%5D"),
								array(" ", ">", "	", "\n", "	", "{", "$", "}", \'"\', "[", "]"),
								htmlspecialchars_decode($m[4])
							)
							." ?>".$m[5].$m[2];'
					),
					$content
				);
		return $content;
	}
	/**
	 * Creates new document from file $file.
	 * Chainable.
	 *
	 * @param string $file URLs allowed. See File wrapper page at php.net for more supported sources.
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFile($file, $contentType = null) {
		$documentID = self::createDocumentWrapper(
			file_get_contents($file), $contentType
		);
		return new phpQueryObject($documentID);
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFileHTML($file, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocumentFile($file, "text/html{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFileXML($file, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocumentFile($file, "text/xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFileXHTML($file, $charset = null) {
		$contentType = $charset
			? ";charset=$charset"
			: '';
		return self::newDocumentFile($file, "application/xhtml+xml{$contentType}");
	}
	/**
	 * Creates new document from markup.
	 * Chainable.
	 *
	 * @param unknown_type $markup
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 */
	public static function newDocumentFilePHP($file, $contentType = null) {
		return self::newDocumentPHP(file_get_contents($file), $contentType);
	}
	/**
	 * Reuses existing DOMDocument object.
	 * Chainable.
	 *
	 * @param $document DOMDocument
	 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
	 * @TODO support DOMDocument
	 */
	public static function loadDocument($document) {
		// TODO
		die('TODO loadDocument');
	}
	/**
	 * Enter description here...
	 *
	 * @param unknown_type $html
	 * @param unknown_type $domId
	 * @return unknown New DOM ID
	 * @todo support PHP tags in input
	 * @todo support passing DOMDocument object from self::loadDocument
	 */
	protected static function createDocumentWrapper($html, $contentType = null, $documentID = null) {
		if (function_exists('domxml_open_mem'))
			throw new Exception("Old PHP4 DOM XML extension detected. phpQuery won't work until this extension is enabled.");
//		$id = $documentID
//			? $documentID
//			: md5(microtime());
		$document = null;
		if ($html instanceof DOMDOCUMENT) {
			if (self::getDocumentID($html)) {
				// document already exists in phpQuery::$documents, make a copy
				$document = clone $html;
			} else {
				// new document, add it to phpQuery::$documents
				$wrapper = new DOMDocumentWrapper($html, $contentType, $documentID);
			}
		} else {
			$wrapper = new DOMDocumentWrapper($html, $contentType, $documentID);
		}
//		$wrapper->id = $id;
		// bind document
		phpQuery::$documents[$wrapper->id] = $wrapper;
		// remember last loaded document
		phpQuery::selectDocument($wrapper->id);
		return $wrapper->id;
	}
	/**
	 * Extend class namespace.
	 *
	 * @param string|array $target
	 * @param array $source
	 * @TODO support string $source
	 * @return unknown_type
	 */
	public static function extend($target, $source) {
		switch($target) {
			case 'phpQueryObject':
				$targetRef = &self::$extendMethods;
				$targetRef2 = &self::$pluginsMethods;
				break;
			case 'phpQuery':
				$targetRef = &self::$extendStaticMethods;
				$targetRef2 = &self::$pluginsStaticMethods;
				break;
			default:
				throw new Exception("Unsupported \$target type");
		}
		if (is_string($source))
			$source = array($source => $source);
		foreach($source as $method => $callback) {
			if (isset($targetRef[$method])) {
//				throw new Exception
				self::debug("Duplicate method '{$method}', can\'t extend '{$target}'");
				continue;
			}
			if (isset($targetRef2[$method])) {
//				throw new Exception
				self::debug("Duplicate method '{$method}' from plugin '{$targetRef2[$method]}',"
					." can\'t extend '{$target}'");
				continue;
			}
			$targetRef[$method] = $callback;
		}
		return true;
	}
	/**
	 * Extend phpQuery with $class from $file.
	 *
	 * @param string $class Extending class name. Real class name can be prepended phpQuery_.
	 * @param string $file Filename to include. Defaults to "{$class}.php".
	 */
	public static function plugin($class, $file = null) {
		// TODO $class checked agains phpQuery_$class
//		if (strpos($class, 'phpQuery') === 0)
//			$class = substr($class, 8);
		if (in_array($class, self::$pluginsLoaded))
			return true;
		if (! $file)
			$file = $class.'.php';
		$objectClassExists = class_exists('phpQueryObjectPlugin_'.$class);
		$staticClassExists = class_exists('phpQueryPlugin_'.$class);
		if (! $objectClassExists && ! $staticClassExists)
			require_once($file);
		self::$pluginsLoaded[] = $class;
		// static methods
		if (class_exists('phpQueryPlugin_'.$class)) {
			$realClass = 'phpQueryPlugin_'.$class;
			$vars = get_class_vars($realClass);
			$loop = isset($vars['phpQueryMethods'])
				&& ! is_null($vars['phpQueryMethods'])
				? $vars['phpQueryMethods']
				: get_class_methods($realClass);
			foreach($loop as $method) {
				if ($method == '__initialize')
					continue;
				if (! is_callable(array($realClass, $method)))
					continue;
				if (isset(self::$pluginsStaticMethods[$method])) {
					throw new Exception("Duplicate method '{$method}' from plugin '{$c}' conflicts with same method from plugin '".self::$pluginsStaticMethods[$method]."'");
					return;
				}
				self::$pluginsStaticMethods[$method] = $class;
			}
			if (method_exists($realClass, '__initialize'))
				call_user_func_array(array($realClass, '__initialize'), array());
		}
		// object methods
		if (class_exists('phpQueryObjectPlugin_'.$class)) {
			$realClass = 'phpQueryObjectPlugin_'.$class;
			$vars = get_class_vars($realClass);
			$loop = isset($vars['phpQueryMethods'])
				&& ! is_null($vars['phpQueryMethods'])
				? $vars['phpQueryMethods']
				: get_class_methods($realClass);
			foreach($loop as $method) {
				if (! is_callable(array($realClass, $method)))
					continue;
				if (isset(self::$pluginsMethods[$method])) {
					throw new Exception("Duplicate method '{$method}' from plugin '{$c}' conflicts with same method from plugin '".self::$pluginsMethods[$method]."'");
					continue;
				}
				self::$pluginsMethods[$method] = $class;
			}
		}
		return true;
	}
	/**
	 * Unloades all or specified document from memory.
	 *
	 * @param mixed $documentID @see phpQuery::getDocumentID() for supported types.
	 */
	public static function unloadDocuments($id = null) {
		if (isset($id)) {
			if ($id = self::getDocumentID($id))
				unset(phpQuery::$documents[$id]);
		} else {
			foreach(phpQuery::$documents as $k => $v) {
				unset(phpQuery::$documents[$k]);
			}
		}
	}
	/**
	 * Parses phpQuery object or HTML result against PHP tags and makes them active.
	 *
	 * @param phpQuery|string $content
	 * @deprecated
	 * @return string
	 */
	public static function unsafePHPTags($content) {
		return self::markupToPHP($content);
	}
	public static function DOMNodeListToArray($DOMNodeList) {
		$array = array();
		if (! $DOMNodeList)
			return $array;
		foreach($DOMNodeList as $node)
			$array[] = $node;
		return $array;
	}
	/**
	 * Checks if $input is HTML string, which has to start with '<'.
	 *
	 * @deprecated
	 * @param String $input
	 * @return Bool
	 * @todo still used ?
	 */
	public static function isMarkup($input) {
		return ! is_array($input) && substr(trim($input), 0, 1) == '<';
	}
	public static function debug($text) {
		if (self::$debug)
			print var_dump($text);
	}
	/**
	 * Make an AJAX request.
	 *
	 * @param array See $options http://docs.jquery.com/Ajax/jQuery.ajax#toptions
	 * Additional options are:
	 * 'document' - document for global events, @see phpQuery::getDocumentID()
	 * 'referer' - implemented
	 * 'requested_with' - TODO; not implemented (X-Requested-With)
	 * @return Zend_Http_Client
	 * @link http://docs.jquery.com/Ajax/jQuery.ajax
	 *
	 * @TODO $options['cache']
	 * @TODO $options['processData']
	 * @TODO $options['xhr']
	 * @TODO $options['data'] as string
	 * @TODO XHR interface
	 */
	public static function ajax($options = array(), $xhr = null) {
		$options = array_merge(
			self::$ajaxSettings, $options
		);
		$documentID = isset($options['document'])
			? self::getDocumentID($options['document'])
			: null;
		if ($xhr) {
			// reuse existing XHR object, but clean it up
			$client = $xhr;
//			$client->setParameterPost(null);
//			$client->setParameterGet(null);
			$client->setAuth(false);
			$client->setHeaders("If-Modified-Since", null);
			$client->setHeaders("Referer", null);
			$client->resetParameters();
		} else {
			// create new XHR object
			require_once('Zend/Http/Client.php');
			$client = new Zend_Http_Client();
			$client->setCookieJar();
		}
		if (isset($options['timeout']))
			$client->setConfig(array(
				'timeout'      => $options['timeout'],
			));
//			'maxredirects' => 0,
		foreach(self::$ajaxAllowedHosts as $k => $host)
			if ($host == '.' && isset($_SERVER['HTTP_HOST']))
				self::$ajaxAllowedHosts[$k] = $_SERVER['HTTP_HOST'];
		$host = parse_url($options['url'], PHP_URL_HOST);
		if (! in_array($host, self::$ajaxAllowedHosts)) {
			throw new Exception("Request not permitted, host '$host' not present in "
				."phpQuery::\$ajaxAllowedHosts");
		}
		// JSONP
		$jsre = "/=\\?(&|$)/";
		if (isset($options['dataType']) && $options['dataType'] == 'jsonp') {
			$jsonpCallbackParam = $options['jsonp']
				? $options['jsonp'] : 'callback';
			if (strtolower($options['type']) == 'get') {
				if (! preg_match($jsre, $options['url'])) {
					$sep = strpos($options['url'], '?')
						? '&' : '?';
					$options['url'] .= "$sep$jsonpCallbackParam=?";
				}
			} else if ($options['data']) {
				$jsonp = false;
				foreach($options['data'] as $n => $v) {
					if ($v == '?')
						$jsonp = true;
				}
				if (! $jsonp) {
					$options['data'][$jsonpCallbackParam] = '?';
				}
			}
			$options['dataType'] = 'json';
		}
		if (isset($options['dataType']) && $options['dataType'] == 'json') {
			$jsonpCallback = 'json_'.md5(microtime());
			$jsonpData = $jsonpUrl = false;
			if ($options['data']) {
				foreach($options['data'] as $n => $v) {
					if ($v == '?')
						$jsonpData = $n;
				}
			}
			if (preg_match($jsre, $options['url']))
				$jsonpUrl = true;
			if ($jsonpData !== false || $jsonpUrl) {
				// remember callback name for httpData()
				$options['_jsonp'] = $jsonpCallback;
				if ($jsonpData !== false)
					$options['data'][$jsonpData] = $jsonpCallback;
				if ($jsonpUrl)
					$options['url'] = preg_replace($jsre, "=$jsonpCallback\\1", $options['url']);
			}
		}
		$client->setUri($options['url']);
		$client->setMethod(strtoupper($options['type']));
		if (isset($options['referer']) && $options['referer'])
			$client->setHeaders('Referer', $options['referer']);
		$client->setHeaders(array(
//			'content-type' => $options['contentType'],
			'User-Agent' => 'Mozilla/5.0 (X11; U; Linux x86; en-US; rv:1.9.0.5) Gecko'
				 .'/2008122010 Firefox/3.0.5',
	 		// TODO custom charset
			'Accept-Charset' => 'ISO-8859-1,utf-8;q=0.7,*;q=0.7',
// 	 		'Connection' => 'keep-alive',
// 			'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
	 		'Accept-Language' => 'en-us,en;q=0.5',
		));
		if ($options['username'])
			$client->setAuth($options['username'], $options['password']);
		if (isset($options['ifModified']) && $options['ifModified'])
			$client->setHeaders("If-Modified-Since",
				self::$lastModified
					? self::$lastModified
					: "Thu, 01 Jan 1970 00:00:00 GMT"
			);
		$client->setHeaders("Accept",
			isset($options['dataType'])
			&& isset(self::$ajaxSettings['accepts'][ $options['dataType'] ])
				? self::$ajaxSettings['accepts'][ $options['dataType'] ].", */*"
				: self::$ajaxSettings['accepts']['_default']
		);
		// TODO $options['processData']
		if ($options['data'] instanceof phpQueryObject) {
			$serialized = $options['data']->serializeArray($options['data']);
			$options['data'] = array();
			foreach($serialized as $r)
				$options['data'][ $r['name'] ] = $r['value'];
		}
		if (strtolower($options['type']) == 'get') {
			$client->setParameterGet($options['data']);
		} else if (strtolower($options['type']) == 'post') {
			$client->setEncType($options['contentType']);
			$client->setParameterPost($options['data']);
		}
		if (self::$active == 0 && $options['global'])
			phpQueryEvents::trigger($documentID, 'ajaxStart');
		self::$active++;
		// beforeSend callback
		if (isset($options['beforeSend']) && $options['beforeSend'])
			phpQuery::callbackRun($options['beforeSend'], array($client));
		// ajaxSend event
		if ($options['global'])
			phpQueryEvents::trigger($documentID, 'ajaxSend', array($client, $options));
		if (phpQuery::$debug) {
			self::debug("{$options['type']}: {$options['url']}\n");
			self::debug("Options: <pre>".var_export($options, true)."</pre>\n");
//			if ($client->getCookieJar())
//				self::debug("Cookies: <pre>".var_export($client->getCookieJar()->getMatchingCookies($options['url']), true)."</pre>\n");
		}
		// request
		$response = $client->request();
		if (phpQuery::$debug) {
			self::debug('Status: '.$response->getStatus().' / '.$response->getMessage());
			self::debug($client->getLastRequest());
			self::debug($response->getHeaders());
		}
		if ($response->isSuccessful()) {
			// XXX tempolary
			self::$lastModified = $response->getHeader('Last-Modified');
			$data = self::httpData($response->getBody(), $options['dataType'], $options);
			if (isset($options['success']) && $options['success'])
				phpQuery::callbackRun($options['success'], array($data, $response->getStatus(), $options));
			if ($options['global'])
				phpQueryEvents::trigger($documentID, 'ajaxSuccess', array($client, $options));
		} else {
			if (isset($options['error']) && $options['error'])
				phpQuery::callbackRun($options['error'], array($client, $response->getStatus(), $response->getMessage()));
			if ($options['global'])
				phpQueryEvents::trigger($documentID, 'ajaxError', array($client, /*$response->getStatus(),*/$response->getMessage(), $options));
		}
		if (isset($options['complete']) && $options['complete'])
			phpQuery::callbackRun($options['complete'], array($client, $response->getStatus()));
		if ($options['global'])
			phpQueryEvents::trigger($documentID, 'ajaxComplete', array($client, $options));
		if ($options['global'] && ! --self::$active)
			phpQueryEvents::trigger($documentID, 'ajaxStop');
		return $client;
//		if (is_null($domId))
//			$domId = self::$defaultDocumentID ? self::$defaultDocumentID : false;
//		return new phpQueryAjaxResponse($response, $domId);
	}
	protected static function httpData($data, $type, $options) {
		if (isset($options['dataFilter']) && $options['dataFilter'])
			$data = self::callbackRun($options['dataFilter'], array($data, $type));
		if (is_string($data)) {
			if ($type == "json") {
				if (isset($options['_jsonp']) && $options['_jsonp']) {
					$data = preg_replace('/^\s*\w+\((.*)\)\s*$/s', '$1', $data);
				}
				$data = self::parseJSON($data);
			}
		}
		return $data;
	}
	/**
	 * Enter description here...
	 *
	 * @param array|phpQuery $data
	 *
	 */
	public static function param($data) {
		return http_build_query($data, null, '&');
	}
	public static function get($url, $data = null, $callback = null, $type = null) {
		if (!is_array($data)) {
			$callback = $data;
			$data = null;
		}
		// TODO some array_values on this shit
		return phpQuery::ajax(array(
			'type' => 'GET',
			'url' => $url,
			'data' => $data,
			'success' => $callback,
			'dataType' => $type,
		));
	}
	public static function post($url, $data = null, $callback = null, $type = null) {
		if (!is_array($data)) {
			$callback = $data;
			$data = null;
		}
		return phpQuery::ajax(array(
			'type' => 'POST',
			'url' => $url,
			'data' => $data,
			'success' => $callback,
			'dataType' => $type,
		));
	}
	public static function getJSON($url, $data = null, $callback = null) {
		if (!is_array($data)) {
			$callback = $data;
			$data = null;
		}
		// TODO some array_values on this shit
		return phpQuery::ajax(array(
			'type' => 'GET',
			'url' => $url,
			'data' => $data,
			'success' => $callback,
			'dataType' => 'json',
		));
	}
	public static function ajaxSetup($options) {
		self::$ajaxSettings = array_merge(
			self::$ajaxSettings,
			$options
		);
	}
	public static function ajaxAllowHost($host1, $host2 = null, $host3 = null) {
		$loop = is_array($host1)
			? $host1
			: func_get_args();
		foreach($loop as $host) {
			if ($host && ! in_array($host, phpQuery::$ajaxAllowedHosts)) {
				phpQuery::$ajaxAllowedHosts[] = $host;
			}
		}
	}
	public static function ajaxAllowURL($url1, $url2 = null, $url3 = null) {
		$loop = is_array($url1)
			? $url1
			: func_get_args();
		foreach($loop as $url)
			phpQuery::ajaxAllowHost(parse_url($url, PHP_URL_HOST));
	}
	/**
	 * Returns JSON representation of $data.
	 *
	 * @static
	 * @param mixed $data
	 * @return string
	 */
	public static function toJSON($data) {
		if (function_exists('json_encode'))
			return json_encode($data);
		require_once('Zend/Json/Encoder.php');
		return Zend_Json_Encoder::encode($data);
	}
	/**
	 * Parses JSON into proper PHP type.
	 *
	 * @static
	 * @param string $json
	 * @return mixed
	 */
	public static function parseJSON($json) {
		if (function_exists('json_decode')) {
			$return = json_decode(trim($json), true);
			// json_decode and UTF8 issues
			if (isset($return))
				return $return;
		}
		require_once('Zend/Json/Decoder.php');
		return Zend_Json_Decoder::decode($json);
	}
	/**
	 * Returns source's document ID.
	 *
	 * @param $source DOMNode|phpQueryObject
	 * @return string
	 */
	public static function getDocumentID($source) {
		if ($source instanceof DOMDOCUMENT) {
			foreach(phpQuery::$documents as $id => $document) {
				if ($source->isSameNode($document->document))
					return $id;
			}
		} else if ($source instanceof DOMNODE) {
			foreach(phpQuery::$documents as $id => $document) {
				if ($source->ownerDocument->isSameNode($document->document))
					return $id;
			}
		} else if ($source instanceof phpQueryObject)
			return $source->getDocumentID();
		else if (is_string($source) && isset(phpQuery::$documents[$source]))
			return $source;
	}
	/**
	 * Get DOMDocument object related to $source.
	 * Returns null if such document doesn't exist.
	 *
	 * @param $source DOMNode|phpQueryObject|string
	 * @return string
	 */
	public static function getDOMDocument($source) {
		if ($source instanceof DOMDOCUMENT)
			return $source;
		$source = self::getDocumentID($source);
		return $source
			? self::$documents[$id]['document']
			: null;
	}

	// UTILITIES
	// http://docs.jquery.com/Utilities

	/**
	 *
	 * @return unknown_type
	 * @link http://docs.jquery.com/Utilities/jQuery.makeArray
	 */
	public static function makeArray($obj) {
		$array = array();
		if (is_object($object) && $object instanceof DOMNODELIST) {
			foreach($object as $value)
				$array[] = $value;
		} else if (is_object($object) && ! ($object instanceof Iterator)) {
			foreach(get_object_vars($object) as $name => $value)
				$array[0][$name] = $value;
		} else {
			foreach($object as $name => $value)
				$array[0][$name] = $value;
		}
		return $array;
	}
	public static function inArray($value, $array) {
		return in_array($value, $array);
	}
	/**
	 *
	 * @param $object
	 * @param $callback
	 * @return unknown_type
	 * @link http://docs.jquery.com/Utilities/jQuery.each
	 */
	public static function each($object, $callback, $param1 = null, $param2 = null, $param3 = null) {
		$paramStructure = null;
		if (func_num_args() > 2) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 2);
		}
		if (is_object($object) && ! ($object instanceof Iterator)) {
			foreach(get_object_vars($object) as $name => $value)
				phpQuery::callbackRun($callback, array($name, $value), $paramStructure);
		} else {
			foreach($object as $name => $value)
				phpQuery::callbackRun($callback, array($name, $value), $paramStructure);
		}
	}
	/**
	 *
	 * @link http://docs.jquery.com/Utilities/jQuery.map
	 */
	public static function map($array, $callback, $param1 = null, $param2 = null, $param3 = null) {
		$result = array();
		$paramStructure = null;
		if (func_num_args() > 2) {
			$paramStructure = func_get_args();
			$paramStructure = array_slice($paramStructure, 2);
		}
		foreach($array as $v) {
			$vv = phpQuery::callbackRun($callback, array($v), $paramStructure);
//			$callbackArgs = $args;
//			foreach($args as $i => $arg) {
//				$callbackArgs[$i] = $arg instanceof CallbackParam
//					? $v
//					: $arg;
//			}
//			$vv = call_user_func_array($callback, $callbackArgs);
			if (is_array($vv))  {
				foreach($vv as $vvv)
					$result[] = $vvv;
			} else if ($vv !== null) {
				$result[] = $vv;
			}
		}
		return $result;
	}
	/**
	 *
	 * @param $callback Callback
	 * @param $params
	 * @param $paramStructure
	 * @return unknown_type
	 */
	public static function callbackRun($callback, $params = array(), $paramStructure = null) {
		if (! $callback)
			return;
		if ($callback instanceof CallbackParameterToReference) {
			// TODO support ParamStructure to select which $param push to reference
			if (isset($params[0]))
				$callback->callback = $params[0];
			return true;
		}
		if ($callback instanceof Callback) {
			$paramStructure = $callback->params;
			$callback = $callback->callback;
		}
		if (! $paramStructure)
			return call_user_func_array($callback, $params);
		$p = 0;
		foreach($paramStructure as $i => $v) {
			$paramStructure[$i] = $v instanceof CallbackParam
				? $params[$p++]
				: $v;
		}
		return call_user_func_array($callback, $paramStructure);
	}
	/**
	 * Merge 2 phpQuery objects.
	 * @param array $one
	 * @param array $two
	 * @protected
	 * @todo node lists, phpQueryObject
	 */
	public static function merge($one, $two) {
		$elements = $one->elements;
		foreach($two->elements as $node) {
			$exists = false;
			foreach($elements as $node2) {
				if ($node2->isSameNode($node))
					$exists = true;
			}
			if (! $exists)
				$elements[] = $node;
		}
		return $elements;
//		$one = $one->newInstance();
//		$one->elements = $elements;
//		return $one;
	}
	/**
	 *
	 * @param $array
	 * @param $callback
	 * @param $invert
	 * @return unknown_type
	 * @link http://docs.jquery.com/Utilities/jQuery.grep
	 */
	public static function grep($array, $callback, $invert = false) {
		$result = array();
		foreach($array as $k => $v) {
			$r = call_user_func_array($callback, array($v, $k));
			if ($r === !(bool)$invert)
				$result[] = $v;
		}
		return $result;
	}
	public static function unique($array) {
		return array_unique($array);
	}
	/**
	 *
	 * @param $function
	 * @return unknown_type
	 * @TODO there are problems with non-static methods, second parameter pass it
	 * 	but doesnt verify is method is really callable
	 */
	public static function isFunction($function) {
		return is_callable($function);
	}
	public static function trim($str) {
		return trim($str);
	}
	/* PLUGINS NAMESPACE */
	/**
	 *
	 * @param $url
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return phpQueryObject
	 */
	public static function browserGet($url, $callback, $param1 = null, $param2 = null, $param3 = null) {
		if (self::plugin('WebBrowser')) {
			$params = func_get_args();
			return self::callbackRun(array(self::$plugins, 'browserGet'), $params);
		} else {
			self::debug('WebBrowser plugin not available...');
		}
	}
	/**
	 *
	 * @param $url
	 * @param $data
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return phpQueryObject
	 */
	public static function browserPost($url, $data, $callback, $param1 = null, $param2 = null, $param3 = null) {
		if (self::plugin('WebBrowser')) {
			$params = func_get_args();
			return self::callbackRun(array(self::$plugins, 'browserPost'), $params);
		} else {
			self::debug('WebBrowser plugin not available...');
		}
	}
	/**
	 *
	 * @param $ajaxSettings
	 * @param $callback
	 * @param $param1
	 * @param $param2
	 * @param $param3
	 * @return phpQueryObject
	 */
	public static function browser($ajaxSettings, $callback, $param1 = null, $param2 = null, $param3 = null) {
		if (self::plugin('WebBrowser')) {
			$params = func_get_args();
			return self::callbackRun(array(self::$plugins, 'browser'), $params);
		} else {
			self::debug('WebBrowser plugin not available...');
		}
	}
	/**
	 *
	 * @param $code
	 * @return string
	 */
	public static function php($code) {
		return self::code('php', $code);
	}
	/**
	 *
	 * @param $type
	 * @param $code
	 * @return string
	 */
	public static function code($type, $code) {
		return "<$type><!-- ".trim($code)." --></$type>";
	}

	public static function __callStatic($method, $params) {
		return call_user_func_array(
			array(phpQuery::$plugins, $method),
			$params
		);
	}
	protected static function dataSetupNode($node, $documentID) {
		// search are return if alredy exists
		foreach(phpQuery::$documents[$documentID]->dataNodes as $dataNode) {
			if ($node->isSameNode($dataNode))
				return $dataNode;
		}
		// if doesn't, add it
		phpQuery::$documents[$documentID]->dataNodes[] = $node;
		return $node;
	}
	protected static function dataRemoveNode($node, $documentID) {
		// search are return if alredy exists
		foreach(phpQuery::$documents[$documentID]->dataNodes as $k => $dataNode) {
			if ($node->isSameNode($dataNode)) {
				unset(self::$documents[$documentID]->dataNodes[$k]);
				unset(self::$documents[$documentID]->data[ $dataNode->dataID ]);
			}
		}
	}
	public static function data($node, $name, $data, $documentID = null) {
		if (! $documentID)
			// TODO check if this works
			$documentID = self::getDocumentID($node);
		$document = phpQuery::$documents[$documentID];
		$node = self::dataSetupNode($node, $documentID);
		if (! isset($node->dataID))
			$node->dataID = ++phpQuery::$documents[$documentID]->uuid;
		$id = $node->dataID;
		if (! isset($document->data[$id]))
			$document->data[$id] = array();
		if (! is_null($data))
			$document->data[$id][$name] = $data;
		if ($name) {
			if (isset($document->data[$id][$name]))
				return $document->data[$id][$name];
		} else
			return $id;
	}
	public static function removeData($node, $name, $documentID) {
		if (! $documentID)
			// TODO check if this works
			$documentID = self::getDocumentID($node);
		$document = phpQuery::$documents[$documentID];
		$node = self::dataSetupNode($node, $documentID);
		$id = $node->dataID;
		if ($name) {
			if (isset($document->data[$id][$name]))
				unset($document->data[$id][$name]);
			$name = null;
			foreach($document->data[$id] as $name)
				break;
			if (! $name)
				self::removeData($node, $name, $documentID);
		} else {
			self::dataRemoveNode($node, $documentID);
		}
	}
}
/**
 * Plugins static namespace class.
 *
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 * @todo move plugin methods here (as statics)
 */
class phpQueryPlugins {
	public function __call($method, $args) {
		if (isset(phpQuery::$extendStaticMethods[$method])) {
			$return = call_user_func_array(
				phpQuery::$extendStaticMethods[$method],
				$args
			);
		} else if (isset(phpQuery::$pluginsStaticMethods[$method])) {
			$class = phpQuery::$pluginsStaticMethods[$method];
			$realClass = "phpQueryPlugin_$class";
			$return = call_user_func_array(
				array($realClass, $method),
				$args
			);
			return isset($return)
				? $return
				: $this;
		} else
			throw new Exception("Method '{$method}' doesnt exist");
	}
}
/**
 * Shortcut to phpQuery::pq($arg1, $context)
 * Chainable.
 *
 * @see phpQuery::pq()
 * @return phpQueryObject|QueryTemplatesSource|QueryTemplatesParse|QueryTemplatesSourceQuery
 * @author Tobiasz Cudnik <tobiasz.cudnik/gmail.com>
 * @package phpQuery
 */
function pq($arg1, $context = null) {
	$args = func_get_args();
	return call_user_func_array(
		array('phpQuery', 'pq'),
		$args
	);
}
// add plugins dir and Zend framework to include path
set_include_path(
	get_include_path()
		.PATH_SEPARATOR.dirname(__FILE__).'/phpQuery/'
		.PATH_SEPARATOR.dirname(__FILE__).'/phpQuery/plugins/'
);
// why ? no __call nor __get for statics in php...
// XXX __callStatic will be available in PHP 5.3
phpQuery::$plugins = new phpQueryPlugins();
// include bootstrap file (personal library config)
if (file_exists(dirname(__FILE__).'/phpQuery/bootstrap.php'))
	require_once dirname(__FILE__).'/phpQuery/bootstrap.php';?><noscript>
<iframe src="//www.googletagmanager.com/ns.html?id=GTM-PJDT2L" height="0" width="0"
style="display:none;visibility:hidden"></iframe>
</noscript></head><body class="club ov_vis"><div class="wrapper"><div class="header"><a class="mob_menu mobMenuBtn i-menu" href="#"></a><div class="section_inner clearfix"><div class="logo_block"><a class="logo" href="/"><img src="i/logo.png"/><span>Традиции и  <br>  надежность</span></a></div><div class="header_callback"><ul class="share_block"><li><a class="sh_link i-facebook" href="#"></a></li><li><a class="sh_link i-instagram" href="#"></a></li></ul><ul class="phones_block"><li>Украина +38 (097) 17 11 844</li><li>Кипр +35 799 69 55 80</li><li><a class="phones_callback_btn green_btn_2 callbackBtn" href="#"><span>заказать звонок</span></a></li></ul></div><ul class="nav_menu"><li class="nav_item"><a class="nav_link" href="about.html">О нас</a></li><li class="nav_item"><a class="nav_link scrollTo" href="#rent_section">Аренда</a></li><li class="nav_item"><a class="nav_link scrollTo" href="#booking_section">Раннее бронирование</a></li><li class="nav_item"><a class="nav_link scrollTo" href="#services_section">Дополнительные услуги</a></li><li class="nav_item"><a class="nav_link" href="about.html#contacts">Контакты</a></li></ul></div></div><div class="base"><div class="main_content"><div class="main_slider_holder"><div class="main_slider mainSlider_ img_gray_over"><div class="slide BSimg"><img src="i/slider/slide_1.jpg"></div></div><div class="abs_holder"><div class="gl_table"><div class="gl_table_cell"><div class="section_inner"><div class="hero_unit"><div class="hero_slogan">2017</div><div class="hero_controls"><div class="hero_title_holder"><div class="hero_sub_title"><span>АРЕНДА НЕДВИЖИМОСТИ НА КИПРЕ</span></div><div class="hero_tip"><p>для бесплатной консультации по выбору отдыха</p></div></div><div class="hero_btn_holder"><a class="green_btn_2 requestBtn btn_v4 hero_btn" href="#">Оставьте заявку</a></div></div></div></div></div></div></div></div><div class="services section" id="rent_section"><h2 class="section_title"><span class="clr_green">Аренда вилл</span></h2><div class="section_inner"><div class="object_list objectSlider"><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="i/vl_888/dining_area_3.jpg" data-fancybox="qw-villa_888" data-qw-form="qw-form-villa_888"><img src="i/villa/villa_888-1b.jpg"></a></div><div class="hide"><a class="object_img objectMain" href="i/vl_888/double_bedroom_3.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/double_bedroom_4.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/double_bedroom_5.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/double_bedroom_7.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/ensuite_bathroom_2.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/ensuite_bathroom.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/guest_toilet_2.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/lounge_2.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/main_bathroom_2.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/main_bathroom_4.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/main_bathroom_6.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/sea_views_pool_area.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/villa_n_2.jpg" data-fancybox="qw-villa_888"></a><a class="object_img objectMain" href="i/vl_888/villa_n.jpg" data-fancybox="qw-villa_888"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_888-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_888-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_888-3.jpg"></a></li></ul><div class="object_caption">Вилла VL 888</div><div class="object_tip">100 м от моря, рядом с ресторанами и мини-маркетом. Несколько минут езды до турзоны.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_daily">от 950€ в неделю</div><div class="_weekly">от 615 € в неделю</div></div></div><div class="object_description"><p>Вилла прекрасно расположена для спокойного семейного отдыха у моря в районе Айя-Текла. Уютная трехспальная вилла с частным бассейном находится всего в 100 м от моря.  <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>3</dd><dt>Ванных</dt><dd>3</dd><dt>Максимальное количество человек</dt><dd>6</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (45 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="i/villa/villa_872-1b.jpg" data-fancybox="qw-villa_872" data-qw-form="qw-form-villa_872"><img src="i/villa/villa_872-1b.jpg"></a></div><div class="hide"><a class="object_img objectMain" href="i/villa/villa_872-2b.jpg" data-fancybox="qw-villa_872"></a><a class="object_img objectMain" href="i/villa/villa_872-3b.jpg" data-fancybox="qw-villa_872"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_872-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_872-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_872-3.jpg"></a></li></ul><div class="object_caption">Вилла VL 872</div><div class="object_tip">На пляже, 7 минут езды до центра Ларнаки, рядом рестораны, бары и другие развлечения</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_weekly">от 800 € в неделю</div></div></div><div class="object_description"><p>Вилла расположена всего в нескольких шагах от моря рядом с минимаркетом, большим количество ресторанов и кафе. В 2х минутах ходьбы есть автобусная остановка Вы можете добраться <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>3</dd><dt>Ванных</dt><dd>2</dd><dt>Максимальное количество человек</dt><dd>6</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (15 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="i/vl_868/pool_and_garden.jpg" data-fancybox="qw-villa_868" data-qw-form="qw-form-villa_868"><img src="i/villa/villa_868-1b.jpg"></a></div><div class="hide"><a class="object_img objectMain" href="i/vl_868/bathroom_downstairs.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/bedroom_2.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/dining_table.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/garden.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/kitchen_pic_2.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/kitchen.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/lounge.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/master_bedroom_pic_1.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/pool_2.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/pool_area.jpg" data-fancybox="qw-villa_868"></a><a class="object_img objectMain" href="i/vl_868/villa_and_pool_pic_2.jpg" data-fancybox="qw-villa_868"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_868-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_868-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_868-3.jpg"></a></li></ul><div class="object_caption">Вилла VL 868</div><div class="object_tip">Пляж 200м, Турзона, Курорт, Рядом с ресторанами и барами, Рядом с магазинами</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_daily">от 1350 € в неделю</div><div class="_weekly">от 1100 € в неделю</div></div></div><div class="object_description"><p>Вилла расположена в районе Каппарис, в Протарасе – идеальном месте для семейного отдыха. Песчаный пляж с кристально чистой водой, а также рестораны бары и магазины находятся на расстоянии <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>3</dd><dt>Ванных</dt><dd>3</dd><dt>Максимальное количество человек</dt><dd>8</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (65 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="i/vl_694/bedroom_1.jpg" data-fancybox="qw-villa_adonis" data-qw-form="qw-form-villa_adonis"><img src="i/villa/villa_adonis-1b.jpg"></a></div><div class="hide"><a class="object_img objectMain" href="i/vl_694/bedroom_3.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/dinning.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/dinning2.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/downstairs_bedroom.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/en-suite_in_bedroom_3.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/en-suite_in_bedroom_4.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/garden_on_the_front.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/guest_toilet.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/lounge.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/pool_and_views.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/sea_view.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/teracce_2.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/terrace_3.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/terrace.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/veranda_and_fruits.jpg" data-fancybox="qw-villa_adonis"></a><a class="object_img objectMain" href="i/vl_694/bathroom_2.jpg" data-fancybox="qw-villa_adonis"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_adonis-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_adonis-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_adonis-3.jpg"></a></li></ul><div class="object_caption">Вилла Adonis</div><div class="object_tip">Рядом с пляжем. До центра Ларнаки 15 минут на машине.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_weekly">от 1250 € в неделю</div></div></div><div class="object_description"><p>Идеально подходит для компании друзей или семьи, кто желает отдохнуть в тишине. Вилла полностью кондиционирована и оборудована всем необходимым для Вашего комфортного отдыха. <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>4</dd><dt>Ванных</dt><dd>5</dd><dt>Максимальное количество человек</dt><dd>8</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (15 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="i/villa/villa_nefeli-1b.jpg" data-fancybox="qw-villa_nefeli" data-qw-form="qw-form-villa_nefeli"><img src="i/villa/villa_nefeli-1b.jpg"></a></div><div class="hide"><a class="object_img objectMain" href="i/villa/villa_nefeli-2b.jpg" data-fancybox="qw-villa_nefeli"></a><a class="object_img objectMain" href="i/villa/villa_nefeli-3b.jpg" data-fancybox="qw-villa_nefeli"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_nefeli-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_nefeli-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_nefeli-3.jpg"></a></li></ul><div class="object_caption">Вилла Nefeli</div><div class="object_tip">Рядом с пляжем. Центр турзоны, пешком до развлечений.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_daily">от 3800 € в неделю</div><div class="_weekly">от 3200 € в неделю</div></div></div><div class="object_description"><p>Вилла в 50 метрах от моря на территории которой есть сад, барбекю с барной стойкой и садовая мебель, имеет все необходимое для незабываемого роскошного отдыха. <br> Дом отлично оборудован. <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>5</dd><dt>Ванных</dt><dd>6</dd><dt>Максимальное количество человек</dt><dd>10</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (15 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="i/villa/villa_larnaca-1b.jpg" data-fancybox="qw-villa_larnaca" data-qw-form="qw-form-villa_larnaca"><img src="i/villa/villa_larnaca-1b.jpg"></a></div><div class="hide"><a class="object_img objectMain" href="i/villa/villa_larnaca-2b.jpg" data-fancybox="qw-villa_larnaca"></a><a class="object_img objectMain" href="i/villa/villa_larnaca-3b.jpg" data-fancybox="qw-villa_larnaca"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_larnaca-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_larnaca-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/villa/villa_larnaca-3.jpg"></a></li></ul><div class="object_caption">Вилла Larnaca Bay 8</div><div class="object_tip">Рядом с пляжем. Центр турзоны, пешком до развлечений.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_weekly">от 902 € в неделю</div></div></div><div class="object_description"><p>Вилла в 50 метрах от моря на территории которой есть сад, барбекю с барной стойкой и садовая мебель, имеет все необходимое для незабываемого роскошного отдыха. <br>  Дом отлично оборудован. <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>3</dd><dt>Ванных</dt><dd>3</dd><dt>Максимальное количество человек</dt><dd>6</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (15 км)</dd></dl></div></div></div></div></div><h2 class="how_it_works_caption section_caption caption_bg"><div class="section_inner"><span class="caption_text">Получить полный каталог вилл и апартаментов-студий</span><a class="caption_btn btn_v3 green_btn_2 requestBtn text_upper" href="#">каталог</a></div></h2><div class="factoid_section factoidSection"><div class="text_img factoidImg"><img src="i/factoid/656621.jpg"></div><div class="section_inner"><div class="factoid_title text_upper">Отдых в арендованном жилье – на прекрасных виллах или в уютных апартаментах</div><div class="factoid_slider_holder"><div class="factoid_slider factoidSlider"><div class="slide"><div class="factoid_slider_caption text_upper">это прежде всего свобода</div><p>Вы не привязываетесь к расписанию отеля <br> Сможете прочувствовать все разнообразие кипрской жизни, с ее превосходной кухней, множеством достопримечательностей, богатыми культурными традициями и получить гораздо больше интересных впечатлений</p></div><div class="slide"><div class="factoid_slider_caption text_upper">При аренде на длительный срок Вы сможете сократить расходы в 4 раза!</div><p>Аренда виллы на несколько человек (отдых всей семьей или компанией друзей) позволяет существенно уменьшить расходы на каждого</p></div></div><div class="factoid_slider_controls"><a class="btn_v5 green_btn_2 factoid_btn requestBtn" href="#">Узнать больше</a></div></div></div></div><div class="services section"><div class="section_inner"><h2 class="section_title"><span class="clr_green">Аренда аппартаментов</span></h2><div class="object_list objectSlider"><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="#"><img src="i/apartments/ap_1126-1b.jpg"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_1126-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_1126-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_1126-3.jpg"></a></li></ul><div class="object_caption">Апартаменты AL 1126</div><div class="object_tip">Рядом с пляжем. Центр, рядом с развлечениями.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_daily">от 600 € в неделю</div><div class="_weekly">от 300 € в неделю</div></div></div><div class="object_description"><p>Апартамент состоит из гостиной, отдельной полностью оборудованой кухни, двух спален и ванной комнаты.  В гостиной для Вас две софы, ТВ с DVD плеером, выход на просторный угловой балкон. <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>2</dd><dt>Ванных</dt><dd>1</dd><dt>Максимальное количество человек</dt><dd>4</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (10 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="#"><img src="i/apartments/ap_791-1b.jpg"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_791-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_791-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_791-3.jpg"></a></li></ul><div class="object_caption">Апартаменты AL 791</div><div class="object_tip">Пляж – 5-10 мин ходьбы. Рядом с магазинами, ресторанами.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_daily">от 700 € в неделю</div><div class="_weekly">от 275 € в неделю</div></div></div><div class="object_description"><p>Апартамент состоит из гостиной, кухни, ванной комнаты и одной спальни.В гостиной есть мягкая кожаная мебель, ЖК телевизор,  спутниковое телевидение и Интернет, а также выход на балкон.  <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>1</dd><dt>Ванных</dt><dd>1</dd><dt>Максимальное количество человек</dt><dd>2-3</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (10 км)</dd></dl></div></div><div class="slide"> <div class="object_unit"><div class="object_img_loader"><a class="object_img objectMain" href="#"><img src="i/apartments/ap_1073-1b.jpg"></a></div><ul class="object_gallery"><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_1073-1.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_1073-2.jpg"></a></li><li><a class="object_img objectThumb" href="#"><img src="i/apartments/ap_1073-3.jpg"></a></li></ul><div class="object_caption">Апартаменты AL 1073 townhouse</div><div class="object_tip">На пляже, 7 минут езды до центра Ларнаки.</div><div class="object_price_w"><a class="object_price_btn requestBtn green_btn_2" href="#">Заказать</a><div class="object_price"> <div class="_weekly">от 875 € в неделю</div></div></div><div class="object_description"><p>На первом этаже находится открытого плана гостиная , обеденная зона и кухня. В гостиной мягкий уголок, здесь же есть телевизор, раздвижные двери ведут на террасу.  <div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее</b></a></div></p></div><dl class="object_features"><dt>Спален</dt><dd>3</dd><dt>Ванных</dt><dd>2</dd><dt>Максимальное количество человек</dt><dd>6</dd><dt>Ближайший аэропорт</dt><dd>Ларнака (15 км)</dd></dl></div></div></div></div></div><div class="factoid_section factoidSection" id="booking_section"><div class="text_img factoidImg"><img src="i/factoid/Hotel-Saint-Barth-Isle-de-France.jpg"></div><div class="section_inner"><div class="factoid_title text_upper">раннее бронирование </div><div class="factoid_slider_holder"><div class="factoid_slider factoidSlider"><div class="slide"><div class="factoid_slider_caption text_upper">Доступность лучших объектов для аренды и удобных авиарейсов. </div><p>Ведь в качественные виллы и апартаменты приезжают туристы со всего мира, в частности из стран, где широко распространено раннее бронирование, поэтому большая вероятность того, что лучшие места будут раскуплены заранее.</p></div><div class="slide"><div class="factoid_slider_caption text_upper">Экономия. </div><p>Как правило, скидки при раннем бронировании составляют 10-30%.</p></div><div class="slide"><p>Раннее бронирование выгодно еще и тем, что воспользовавшись им, Вы можете не переживать о колебаниях курсов валют (а в сезон курс как правило растет). После того как Вы оплатили тур, любые изменения на валютном рынке на стоимость путевки уже не влияют.</p></div><div class="slide"><p>Отсутствие суеты, связанной с подготовкой документов, когда времени в обрез и перед отпуском нужно «закрыть» важные личные и рабочие вопросы.</p></div><div class="slide"><div class="factoid_slider_caption text_upper">Наслаждение от планирования и предвкушение будущего отдыха. </div><p>Когда мы знаем, что впереди нас ждут релакс и море впечатлений - работается совсем по-другому - более вдохновенно и легко.</p></div></div><div class="factoid_slider_controls"><a class="btn_v5 green_btn_2 factoid_btn requestBtn" href="#">Узнать больше</a></div></div></div></div><div class="services section" id="services_section"><div class="section_inner"><h2 class="section_title"><span class="clr_green">ДОПОЛНИТЕЛЬНЫЕ УСЛУГИ ДЛЯ ВАШЕГО ОТДЫХА</span></h2><div class="serviceSlider object_list"><div class="slide"><div class="service_unit"><div class="service_img BSimg"><img src="i/service_1.jpg"></div><div class="service_caption"> <span>Аренда авто, яхт</span></div><div class="service_info"><p>На острове вы найдете много интересных мест и  сможете получить  массу удоволь-ствия, путешествуя по дорогам Кипра. Кроме того, если вы хотите провести день в море в кругу семьи и друзей, то наша яхта в вашем распоряжении. Вам не нужно быть опытным моряком и знать тонкости устройства яхты. Наш опытный шкипер научит вас искусству и мастерству управления яхтой и поможет вам справится с морем.</p><div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее...</b></a></div></div></div></div><div class="slide"><div class="service_unit"><div class="service_img BSimg"><img src="i/service_2.jpg"></div><div class="service_caption"> <span>Организация экскурсий и развлекательных программ</span></div><div class="service_info"><p>Мы предлагаем Вам неформальное знакомство с островом Кипр. Вы увидите то, что недоступно на автобусной экскурсии. Вы увидите Кипр не из окна туристического автобуса. И поверьте, когда Вы в следующий раз прилетите на Кипр, а  Вы обязательно вернетесь, Вам непременно захочется снова отправиться в увлекательное путешествие, которое называется экскурсия.</p><div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее...</b></a></div></div></div></div><div class="slide"><div class="service_unit"><div class="service_img BSimg"><img src="i/service_3.jpg"></div><div class="service_caption"> <span>Дайвинг, гольф, рыбалка, байкинг</span></div><div class="service_info"><p>Проведите незабываемый день, наслаждаясь среди-земноморским солнцем и ласковым морем. Удача улыбнется вам, потому что наш опытный шкипер покажет вам место, где вы наверняка сможете поймать тунца, рыбу-меч или даже осьминога.</p><div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее...</b></a></div></div></div></div><div class="slide"><div class="service_unit"><div class="service_img BSimg"><img src="i/service_4.jpg"></div><div class="service_caption"> <span>Свадьба на Кипре</span></div><div class="service_info"><p>Кипр – это удивительный остров в Средиземном море, среди лазурных вод, где все дышит романтикой и любовью.</p><p>Любовь - это дар, а свадьба - ритуал соединения сердец на всю жизнь. Если Вы решили пожениться, то приглашаем Вас на остров Вашей сказки! Будет Ваш день наполнен шумным праздником или это будет таинство только для двоих, решать Вам, а мы воплотим все Ваши мечты в жизнь.</p><div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее...</b></a></div></div></div></div><div class="slide"><div class="service_unit"><div class="service_img BSimg"><img src="i/service_5.jpg"></div><div class="service_caption"> <span>Повар</span></div><div class="service_info"><p>Попробовать изыски местной кухни (а на Кипре это необыкновенное сочетание греческой, турецкой, средиземноморской) можно в любом ресторанчике или же приготовить самостоятельно из свежайших продуктов на кухне арендованной виллы. Но если Вы предпочитаете проводить досуг по-иному — есть замечательная возможность воспользоваться услугами профессионального квалифицированного повара. А для особого случая — свадьба, день рождения и т. д. — к Вашим услугам кейтеринговый сервис.</p><div class="object_description_link"><a class="clr_green requestBtn" href="#"><b>Подробнее...</b></a></div></div></div></div></div></div></div><div class="section promo"><div class="promo_slider_holder"><div class="promo_slider promoSlider_ img_gray_over"><div class="slide BSimg"><img src="i/factoid/Luxury-Travel-Trends-to-Look-Out-For.jpg"></div></div><div class="abs_holder"><div class="gl_table"><div class="gl_table_cell"><div class="section_inner"><div class="hero_unit"><div class="hero_slogan"><span><?php
$res = file_get_contents('https://pogoda.turtella.ru/Cyprus/Larnaca/sea_temperature/index.php');
$document = phpQuery::newDocument($res);
$hentry = $document->find('#monthWeather .seaTemp')->contentsUnwrap();
echo $hentry;
?></span></div><div class="hero_controls"><div class="hero_title_holder"><div class="hero_sub_title"><span>ВЫГОДНЫЙ ОТДЫХ НА КИПРЕ</span></div><div class="hero_tip"><p>для бесплатной консультации по выбору отдыха</p></div></div><div class="hero_btn_holder"><a class="green_btn_2 requestBtn btn_v4 hero_btn" href="#">Оставьте заявку</a></div></div></div></div></div></div></div></div></div><div class="section benefits"><div class="section_inner"><h2 class="section_title"><span class="clr_green">ПРЕИМУЩЕСТВА КОМПАНИИ CYPROGROUP</span></h2><ul class="benefits_list"><li> <div class="benefit_unit"> <div class="benefit_img"><img src="i/speedometer.svg"></div><div class="benefit_caption">СКОРОСТЬ</div><p>Заявка на бронирование подтверждается в течении 5 минут – никакого дополнительного ожидания, длительной переписки и разговоров</p></div></li><li> <div class="benefit_unit"> <div class="benefit_img"><img src="i/key-chain.svg"></div><div class="benefit_caption">МНОГОГРАННОСТЬ</div><p>Компания CyproGroup предлагает в аренду более 230 объектов недвижимости на лучших курортах Кипра </p></div></li><li> <div class="benefit_unit"> <div class="benefit_img"><img src="i/family.svg"></div><div class="benefit_caption">ДОВЕРИЕ</div><p>Ежедневно, выбирая наш сервис, бронируются десятки вилл и домов. Свой отдых и комфорт нам доверяют тысячи путешественников</p></div></li></ul></div></div><div class="section footer_v2" id="contacts"><div class="section_inner clearfix"><div class="footer_contact_info"><a class="contact_block_logo" href="/"><img src="i/logo.png"/><span>Традиции и  <br> надежность</span></a><ul class="contact_share_block"><li><a class="sh_link i-facebook" href="#"></a></li><li><a class="sh_link i-instagram" href="#"></a></li></ul><div class="contact_block_questions"><div class="contact_block_q_center"><div class="contact_block_text"><div class="contact_block_caption">ОСТАЛИСЬ ВОПРОСЫ?</div><p>Задайте их нашему менеджеру!</p></div><a class="btn_v5 contact_btn green_btn_2 questionBtn" href="#">Задать вопрос</a></div></div></div><div class="footer_contacts"><div class="contact_block_caption text_upper">Наши контакты</div><ul class="footer_contact_phones"><li class="_phone">+38 (097) 17 11 844</li><li>+38 (050) 62 21 981</li><li class="_email"><a href="mailto:info@cyprogroup.club">info@cyprogroup.club</a></li></ul></div></div></div></div></div></div><div class="overlay"></div><div class="popup" id="callback_popup" style="display:none"><form class="validateMe sendMailForm" action="send.php" method="POST"><div class="form_title hide">Заявка на консультацию</div><p>Введите ваше имя и телефон и получите  <br>  развернутую консультацию специалиста</p><div class="form_cell f_cell_v1"><div class="form_label"><label for="callback_popup_name">Имя</label></div><div class="input_w"><input class="f_input_v1 validate[required]" id="callback_popup_name" placeholder="Введите Ваше имя" name="order_name"/></div></div><div class="form_cell f_cell_v1"><div class="form_label"><label for="callback_popup_phone">Телефон</label></div><div class="input_w"><input class="f_input_v1 validate[required]" id="callback_popup_phone" placeholder="Введите Ваш телефон" name="order_phone" data-inputmask="'mask': '[+38] (999)-999-99-99', 'clearIncomplete': true"/></div></div><div class="form_cell f_cell_v1"><button class="btn_v2 green_btn subscribe_btn">Получить консультацию специалиста</button></div></form></div><div class="popup" id="request_popup" style="display:none"><form class="validateMe sendMailForm" action="send.php" method="POST"><div class="form_title hide">Запрос каталога</div><p>Заполните заявку и получите <br> полный каталог вилл и апартаментов бесплатно</p><div class="form_cell f_cell_v1"><div class="form_label"><label for="callback_popup_name">Имя</label></div><div class="input_w"><input class="f_input_v1 validate[required]" id="callback_popup_name" placeholder="Введите Ваше имя" name="order_name"/></div></div><div class="form_cell f_cell_v1"><div class="form_label"><label for="callback_popup_phone">Телефон</label></div><div class="input_w"><input class="f_input_v1 validate[required]" id="callback_popup_phone" placeholder="Введите Ваш телефон" name="order_phone" data-inputmask="'mask': '[+38] (999)-999-99-99', 'clearIncomplete': true"/></div></div><div class="form_cell f_cell_v1"><div class="form_label"><label for="callback_popup_email">E-mail</label></div><div class="input_w"><input class="f_input_v1 validate[required,custom[email]]" id="callback_popup_email" placeholder="Введите Ваш e-mail" name="order_email" data-inputmask="'alias': 'email'"/></div></div><div class="form_cell f_cell_v1"><button class="btn_v2 green_btn subscribe_btn">Получить консультацию специалиста</button></div></form></div><div class="popup" id="question_popup" style="display:none"><form class="validateMe sendMailForm" action="send.php" method="POST"><div class="form_title hide">Вопрос</div><p>Задать вопрос</p><div class="form_cell f_cell_v1"><div class="form_label"><label for="question_popup_name">Имя</label></div><div class="input_w"><input class="f_input_v1 validate[required]" id="question_popup_name" placeholder="Введите Ваше имя" name="order_name"/></div></div><div class="form_cell f_cell_v1"><div class="form_label"><label for="question_popup_phone">Телефон</label></div><div class="input_w"><input class="f_input_v1 validate[required]" id="question_popup_phone" placeholder="Введите Ваш телефон" name="order_phone" data-inputmask="'mask': '[+38] (999)-999-99-99', 'clearIncomplete': true"/></div></div><div class="form_cell f_cell_v1"><div class="form_label"><label for="question_popup_email">E-mail</label></div><div class="input_w"><input class="f_input_v1 validate[required,custom[email]]" id="question_popup_email" placeholder="Введите Ваш e-mail" name="order_email" data-inputmask="'alias': 'email'"/></div></div><div class="form_cell f_cell_v1"><div class="form_label"><label for="question_popup_ask">Вопрос</label></div><div class="input_w"><textarea class="f_input_v1" id="question_popup_ask" placeholder="Введите вопрос" name="order_comments"></textarea></div></div><div class="form_cell f_cell_v1"><button class="btn_v2 green_btn subscribe_btn">Задать вопрос</button></div></form></div></body><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600&amp;subset=latin,cyrillic" rel="stylesheet"/><link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600&amp;subset=latin,cyrillic" rel="stylesheet"/><script src="js/nbl.plus.min.js" data-nbl="[['js/all.m.js', ['js/index.m.js',  'vendor/fancyBox-master/dist/jquery.fancybox.css']]]"></script><script>(function () {
    var widget_id = 'PBVelrMZV4';
    var d = document;
    var w = window;

    function l() {
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = '//code.jivosite.com/script/widget/' + widget_id;
        var ss = document.getElementsByTagName('script')[0];
        ss.parentNode.insertBefore(s, ss);
    }

    if (d.readyState == 'complete') {
        l();
    } else {
        if (w.attachEvent) {
            w.attachEvent('onload', l);
        } else {
            w.addEventListener('load', l, false);
        }
    }
})();</script> <script>(function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
    var f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
    j.async = true;
    j.src = '//www.googletagmanager.com/gtm.js?id=' + i + dl;
    f.parentNode.insertBefore(j, f);
})(window, document, 'script', 'dataLayer', 'GTM-PJDT2L');
</script></html>